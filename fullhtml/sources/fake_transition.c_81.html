
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class="cpp">
<a name="ln1"> </a>
<a name="ln2">// This is an open source non-commercial project. Dear PVS-Studio, please check it.</a>
<a name="ln3"> </a>
<a name="ln4">// PVS-Studio Static Code Analyzer for C, C++ and C#: http://www.viva64.com</a>
<a name="ln5">/*</a>
<a name="ln6"> * Copyright (C) 2009 Andrew Beekhof &lt;andrew@beekhof.net&gt;</a>
<a name="ln7"> *</a>
<a name="ln8"> * This program is free software; you can redistribute it and/or</a>
<a name="ln9"> * modify it under the terms of the GNU General Public</a>
<a name="ln10"> * License as published by the Free Software Foundation; either</a>
<a name="ln11"> * version 2 of the License, or (at your option) any later version.</a>
<a name="ln12"> *</a>
<a name="ln13"> * This software is distributed in the hope that it will be useful,</a>
<a name="ln14"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln15"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</a>
<a name="ln16"> * General Public License for more details.</a>
<a name="ln17"> *</a>
<a name="ln18"> * You should have received a copy of the GNU General Public</a>
<a name="ln19"> * License along with this library; if not, write to the Free Software</a>
<a name="ln20"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</a>
<a name="ln21"> */</a>
<a name="ln22"> </a>
<a name="ln23">#include &lt;crm_internal.h&gt;</a>
<a name="ln24"> </a>
<a name="ln25">#include &lt;stdio.h&gt;</a>
<a name="ln26">#include &lt;unistd.h&gt;</a>
<a name="ln27">#include &lt;stdlib.h&gt;</a>
<a name="ln28"> </a>
<a name="ln29">#include &lt;sys/stat.h&gt;</a>
<a name="ln30">#include &lt;sys/param.h&gt;</a>
<a name="ln31">#include &lt;sys/types.h&gt;</a>
<a name="ln32">#include &lt;dirent.h&gt;</a>
<a name="ln33"> </a>
<a name="ln34">#include &lt;crm/crm.h&gt;</a>
<a name="ln35">#include &lt;crm/cib.h&gt;</a>
<a name="ln36">#include &lt;crm/common/util.h&gt;</a>
<a name="ln37">#include &lt;crm/transition.h&gt;</a>
<a name="ln38">#include &lt;crm/common/iso8601.h&gt;</a>
<a name="ln39">#include &lt;crm/pengine/status.h&gt;</a>
<a name="ln40">#include &lt;allocate.h&gt;</a>
<a name="ln41">#include &quot;fake_transition.h&quot;</a>
<a name="ln42"> </a>
<a name="ln43">static bool fake_quiet = FALSE;</a>
<a name="ln44">static cib_t *fake_cib = NULL;</a>
<a name="ln45">static GListPtr fake_resource_list = NULL;</a>
<a name="ln46">static GListPtr fake_op_fail_list = NULL;</a>
<a name="ln47">gboolean bringing_nodes_online = FALSE;</a>
<a name="ln48"> </a>
<a name="ln49">#define STATUS_PATH_MAX 512</a>
<a name="ln50"> </a>
<a name="ln51">#define quiet_log(fmt, args...) do {              \</a>
<a name="ln52">              if(fake_quiet) {                         \</a>
<a name="ln53">                  crm_trace(fmt, ##args);         \</a>
<a name="ln54">              } else {                            \</a>
<a name="ln55">                  printf(fmt , ##args);           \</a>
<a name="ln56">              }                                   \</a>
<a name="ln57">    } while(0)</a>
<a name="ln58"> </a>
<a name="ln59">#define new_node_template &quot;//&quot;XML_CIB_TAG_NODE&quot;[@uname='%s']&quot;</a>
<a name="ln60">#define node_template &quot;//&quot;XML_CIB_TAG_STATE&quot;[@uname='%s']&quot;</a>
<a name="ln61">#define rsc_template &quot;//&quot;XML_CIB_TAG_STATE&quot;[@uname='%s']//&quot;XML_LRM_TAG_RESOURCE&quot;[@id='%s']&quot;</a>
<a name="ln62">#define op_template  &quot;//&quot;XML_CIB_TAG_STATE&quot;[@uname='%s']//&quot;XML_LRM_TAG_RESOURCE&quot;[@id='%s']/&quot;XML_LRM_TAG_RSC_OP&quot;[@id='%s']&quot;</a>
<a name="ln63">/* #define op_template  &quot;//&quot;XML_CIB_TAG_STATE&quot;[@uname='%s']//&quot;XML_LRM_TAG_RESOURCE&quot;[@id='%s']/&quot;XML_LRM_TAG_RSC_OP&quot;[@id='%s' and @&quot;XML_LRM_ATTR_CALLID&quot;='%d']&quot; */</a>
<a name="ln64"> </a>
<a name="ln65"> </a>
<a name="ln66">static void</a>
<a name="ln67">inject_transient_attr(xmlNode * cib_node, const char *name, const char *value)</a>
<a name="ln68">{</a>
<a name="ln69">    xmlNode *attrs = NULL;</a>
<a name="ln70">    xmlNode *container = NULL;</a>
<a name="ln71">    xmlNode *nvp = NULL;</a>
<a name="ln72">    xmlChar *node_path;</a>
<a name="ln73">    const char *node_uuid = ID(cib_node);</a>
<a name="ln74"> </a>
<a name="ln75">    node_path = xmlGetNodePath(cib_node);</a>
<a name="ln76">    quiet_log(&quot; + Injecting attribute %s=%s into %s '%s'\n&quot;,</a>
<a name="ln77">              name, value, node_path, ID(cib_node));</a>
<a name="ln78">    free(node_path);</a>
<a name="ln79"> </a>
<a name="ln80">    attrs = first_named_child(cib_node, XML_TAG_TRANSIENT_NODEATTRS);</a>
<a name="ln81">    if (attrs == NULL) {</a>
<a name="ln82">        attrs = create_xml_node(cib_node, XML_TAG_TRANSIENT_NODEATTRS);</a>
<a name="ln83">        crm_xml_add(attrs, XML_ATTR_ID, node_uuid);</a>
<a name="ln84">    }</a>
<a name="ln85"> </a>
<a name="ln86">    container = first_named_child(attrs, XML_TAG_ATTR_SETS);</a>
<a name="ln87">    if (container == NULL) {</a>
<a name="ln88">        container = create_xml_node(attrs, XML_TAG_ATTR_SETS);</a>
<a name="ln89">        crm_xml_add(container, XML_ATTR_ID, node_uuid);</a>
<a name="ln90">    }</a>
<a name="ln91"> </a>
<a name="ln92">    nvp = create_xml_node(container, XML_CIB_TAG_NVPAIR);</a>
<a name="ln93">    crm_xml_set_id(nvp, &quot;%s-%s&quot;, name, node_uuid);</a>
<a name="ln94">    crm_xml_add(nvp, XML_NVPAIR_ATTR_NAME, name);</a>
<a name="ln95">    crm_xml_add(nvp, XML_NVPAIR_ATTR_VALUE, value);</a>
<a name="ln96">}</a>
<a name="ln97"> </a>
<a name="ln98">static void</a>
<a name="ln99">update_failcounts(xmlNode * cib_node, const char *resource, const char *task,</a>
<a name="ln100">                  int interval, int rc)</a>
<a name="ln101">{</a>
<a name="ln102">    if (rc == 0) {</a>
<a name="ln103">        return;</a>
<a name="ln104"> </a>
<a name="ln105">    } else if (rc == 7 &amp;&amp; interval == 0) {</a>
<a name="ln106">        return;</a>
<a name="ln107"> </a>
<a name="ln108">    } else {</a>
<a name="ln109">        char *name = NULL;</a>
<a name="ln110">        char *now = crm_itoa(time(NULL));</a>
<a name="ln111"> </a>
<a name="ln112">        name = crm_failcount_name(resource, task, interval);</a>
<a name="ln113">        inject_transient_attr(cib_node, name, &quot;value++&quot;);</a>
<a name="ln114">        free(name);</a>
<a name="ln115"> </a>
<a name="ln116">        name = crm_lastfailure_name(resource, task, interval);</a>
<a name="ln117">        inject_transient_attr(cib_node, name, now);</a>
<a name="ln118">        free(name);</a>
<a name="ln119">        free(now);</a>
<a name="ln120">    }</a>
<a name="ln121">}</a>
<a name="ln122"> </a>
<a name="ln123">static void</a>
<a name="ln124">create_node_entry(cib_t * cib_conn, const char *node)</a>
<a name="ln125">{</a>
<a name="ln126">    int rc = pcmk_ok;</a>
<a name="ln127">    int max = strlen(new_node_template) + strlen(node) + 1;</a>
<a name="ln128">    char *xpath = NULL;</a>
<a name="ln129"> </a>
<a name="ln130">    xpath = calloc(1, max);</a>
<a name="ln131"> </a>
<a name="ln132">    snprintf(xpath, max, new_node_template, node);</a>
<a name="ln133">    rc = cib_conn-&gt;cmds-&gt;query(cib_conn, xpath, NULL, cib_xpath | cib_sync_call | cib_scope_local);</a>
<a name="ln134"> </a>
<a name="ln135">    if (rc == -ENXIO) {</a>
<a name="ln136">        xmlNode *cib_object = create_xml_node(NULL, XML_CIB_TAG_NODE);</a>
<a name="ln137"> </a>
<a name="ln138">        /* Using node uname as uuid ala corosync/openais */</a>
<a name="ln139">        crm_xml_add(cib_object, XML_ATTR_ID, node);</a>
<a name="ln140">        crm_xml_add(cib_object, XML_ATTR_UNAME, node);</a>
<a name="ln141">        cib_conn-&gt;cmds-&gt;create(cib_conn, XML_CIB_TAG_NODES, cib_object,</a>
<a name="ln142">                               cib_sync_call | cib_scope_local);</a>
<a name="ln143">        /* Not bothering with subsequent query to see if it exists,</a>
<a name="ln144">           we'll bomb out later in the call to query_node_uuid()... */</a>
<a name="ln145"> </a>
<a name="ln146">        free_xml(cib_object);</a>
<a name="ln147">    }</a>
<a name="ln148"> </a>
<a name="ln149">    free(xpath);</a>
<a name="ln150">}</a>
<a name="ln151"> </a>
<a name="ln152">static lrmd_event_data_t *</a>
<a name="ln153">create_op(xmlNode * cib_resource, const char *task, int interval, int outcome)</a>
<a name="ln154">{</a>
<a name="ln155">    lrmd_event_data_t *op = NULL;</a>
<a name="ln156">    xmlNode *xop = NULL;</a>
<a name="ln157"> </a>
<a name="ln158">    op = calloc(1, sizeof(lrmd_event_data_t));</a>
<a name="ln159"> </a>
<a name="ln160">    op-&gt;rsc_id = strdup(ID(cib_resource));</a>
<a name="ln161">    op-&gt;interval = interval;</a>
<a name="ln162">    op-&gt;op_type = strdup(task);</a>
<a name="ln163"> </a>
<a name="ln164">    op-&gt;rc = outcome;</a>
<a name="ln165">    op-&gt;op_status = 0;</a>
<a name="ln166">    op-&gt;params = NULL;          /* TODO: Fill me in */</a>
<a name="ln167">    op-&gt;t_run = time(NULL);</a>
<a name="ln168">    op-&gt;t_rcchange = op-&gt;t_run;</a>
<a name="ln169"> </a>
<a name="ln170">    op-&gt;call_id = 0;</a>
<a name="ln171">    for (xop = __xml_first_child(cib_resource); xop != NULL; xop = __xml_next(xop)) {</a>
<a name="ln172">        int tmp = 0;</a>
<a name="ln173"> </a>
<a name="ln174">        crm_element_value_int(xop, XML_LRM_ATTR_CALLID, &amp;tmp);</a>
<a name="ln175">        if (tmp &gt; op-&gt;call_id) {</a>
<a name="ln176">            op-&gt;call_id = tmp;</a>
<a name="ln177">        }</a>
<a name="ln178">    }</a>
<a name="ln179">    op-&gt;call_id++;</a>
<a name="ln180"> </a>
<a name="ln181">    return op;</a>
<a name="ln182">}</a>
<a name="ln183"> </a>
<a name="ln184">static xmlNode *</a>
<a name="ln185">inject_op(xmlNode * cib_resource, lrmd_event_data_t * op, int target_rc)</a>
<a name="ln186">{</a>
<a name="ln187">    return create_operation_update(cib_resource, op, CRM_FEATURE_SET, target_rc, NULL, crm_system_name,</a>
<a name="ln188">                                   LOG_DEBUG_2);</a>
<a name="ln189">}</a>
<a name="ln190"> </a>
<a name="ln191">static xmlNode *</a>
<a name="ln192">inject_node_state(cib_t * cib_conn, const char *node, const char *uuid)</a>
<a name="ln193">{</a>
<a name="ln194">    int rc = pcmk_ok;</a>
<a name="ln195">    int max = strlen(rsc_template) + strlen(node) + 1;</a>
<a name="ln196">    char *xpath = NULL;</a>
<a name="ln197">    xmlNode *cib_object = NULL;</a>
<a name="ln198"> </a>
<a name="ln199">    xpath = calloc(1, max);</a>
<a name="ln200"> </a>
<a name="ln201">    if (bringing_nodes_online) {</a>
<a name="ln202">        create_node_entry(cib_conn, node);</a>
<a name="ln203">    }</a>
<a name="ln204"> </a>
<a name="ln205">    snprintf(xpath, max, node_template, node);</a>
<a name="ln206">    rc = cib_conn-&gt;cmds-&gt;query(cib_conn, xpath, &amp;cib_object,</a>
<a name="ln207">                               cib_xpath | cib_sync_call | cib_scope_local);</a>
<a name="ln208"> </a>
<a name="ln209">    if (cib_object &amp;&amp; ID(cib_object) == NULL) {</a>
<a name="ln210">        crm_err(&quot;Detected multiple node_state entries for xpath=%s, bailing&quot;, xpath);</a>
<a name="ln211">        crm_log_xml_warn(cib_object, &quot;Duplicates&quot;);</a>
<a name="ln212">        crm_exit(ENOTUNIQ);</a>
<a name="ln213">    }</a>
<a name="ln214"> </a>
<a name="ln215">    if (rc == -ENXIO) {</a>
<a name="ln216">        char *found_uuid = NULL;</a>
<a name="ln217"> </a>
<a name="ln218">        if (uuid == NULL) {</a>
<a name="ln219">            query_node_uuid(cib_conn, node, &amp;found_uuid, NULL);</a>
<a name="ln220">        } else {</a>
<a name="ln221">            found_uuid = strdup(uuid);</a>
<a name="ln222">        }</a>
<a name="ln223"> </a>
<a name="ln224">        cib_object = create_xml_node(NULL, XML_CIB_TAG_STATE);</a>
<a name="ln225">        crm_xml_add(cib_object, XML_ATTR_UUID, found_uuid);</a>
<a name="ln226">        crm_xml_add(cib_object, XML_ATTR_UNAME, node);</a>
<a name="ln227">        cib_conn-&gt;cmds-&gt;create(cib_conn, XML_CIB_TAG_STATUS, cib_object,</a>
<a name="ln228">                               cib_sync_call | cib_scope_local);</a>
<a name="ln229">        free_xml(cib_object);</a>
<a name="ln230">        free(found_uuid);</a>
<a name="ln231"> </a>
<a name="ln232">        rc = cib_conn-&gt;cmds-&gt;query(cib_conn, xpath, &amp;cib_object,</a>
<a name="ln233">                                   cib_xpath | cib_sync_call | cib_scope_local);</a>
<a name="ln234">        crm_trace(&quot;injecting node state for %s. rc is %d&quot;, node, rc);</a>
<a name="ln235">    }</a>
<a name="ln236"> </a>
<a name="ln237">    free(xpath);</a>
<a name="ln238">    CRM_ASSERT(rc == pcmk_ok);</a>
<a name="ln239">    return cib_object;</a>
<a name="ln240">}</a>
<a name="ln241"> </a>
<a name="ln242">static xmlNode *</a>
<a name="ln243">modify_node(cib_t * cib_conn, char *node, gboolean up)</a>
<a name="ln244">{</a>
<a name="ln245">    xmlNode *cib_node = inject_node_state(cib_conn, node, NULL);</a>
<a name="ln246"> </a>
<a name="ln247">    if (up) {</a>
<a name="ln248">        crm_xml_add(cib_node, XML_NODE_IN_CLUSTER, XML_BOOLEAN_YES);</a>
<a name="ln249">        crm_xml_add(cib_node, XML_NODE_IS_PEER, ONLINESTATUS);</a>
<a name="ln250">        crm_xml_add(cib_node, XML_NODE_JOIN_STATE, CRMD_JOINSTATE_MEMBER);</a>
<a name="ln251">        crm_xml_add(cib_node, XML_NODE_EXPECTED, CRMD_JOINSTATE_MEMBER);</a>
<a name="ln252"> </a>
<a name="ln253">    } else {</a>
<a name="ln254">        crm_xml_add(cib_node, XML_NODE_IN_CLUSTER, XML_BOOLEAN_NO);</a>
<a name="ln255">        crm_xml_add(cib_node, XML_NODE_IS_PEER, OFFLINESTATUS);</a>
<a name="ln256">        crm_xml_add(cib_node, XML_NODE_JOIN_STATE, CRMD_JOINSTATE_DOWN);</a>
<a name="ln257">        crm_xml_add(cib_node, XML_NODE_EXPECTED, CRMD_JOINSTATE_DOWN);</a>
<a name="ln258">    }</a>
<a name="ln259"> </a>
<a name="ln260">    crm_xml_add(cib_node, XML_ATTR_ORIGIN, crm_system_name);</a>
<a name="ln261">    return cib_node;</a>
<a name="ln262">}</a>
<a name="ln263"> </a>
<a name="ln264">static xmlNode *</a>
<a name="ln265">find_resource_xml(xmlNode * cib_node, const char *resource)</a>
<a name="ln266">{</a>
<a name="ln267">    char *xpath = NULL;</a>
<a name="ln268">    xmlNode *match = NULL;</a>
<a name="ln269">    const char *node = crm_element_value(cib_node, XML_ATTR_UNAME);</a>
<a name="ln270">    int max = strlen(rsc_template) + strlen(resource) + strlen(node) + 1;</a>
<a name="ln271"> </a>
<a name="ln272">    xpath = calloc(1, max);</a>
<a name="ln273"> </a>
<a name="ln274">    snprintf(xpath, max, rsc_template, node, resource);</a>
<a name="ln275">    match = get_xpath_object(xpath, cib_node, LOG_DEBUG_2);</a>
<a name="ln276"> </a>
<a name="ln277">    free(xpath);</a>
<a name="ln278">    return match;</a>
<a name="ln279">}</a>
<a name="ln280"> </a>
<a name="ln281"> </a>
<a name="ln282">static xmlNode *</a>
<a name="ln283">inject_resource(xmlNode * cib_node, const char *resource, const char *rclass, const char *rtype,</a>
<a name="ln284">                const char *rprovider)</a>
<a name="ln285">{</a>
<a name="ln286">    xmlNode *lrm = NULL;</a>
<a name="ln287">    xmlNode *container = NULL;</a>
<a name="ln288">    xmlNode *cib_resource = NULL;</a>
<a name="ln289">    char *xpath = NULL;</a>
<a name="ln290"> </a>
<a name="ln291">    cib_resource = find_resource_xml(cib_node, resource);</a>
<a name="ln292">    if (cib_resource != NULL) {</a>
<a name="ln293">        return cib_resource;</a>
<a name="ln294">    }</a>
<a name="ln295"> </a>
<a name="ln296">    /* One day, add query for class, provider, type */</a>
<a name="ln297"> </a>
<a name="ln298">    if (rclass == NULL || rtype == NULL) {</a>
<a name="ln299">        fprintf(stderr, &quot;Resource %s not found in the status section of %s.&quot;</a>
<a name="ln300">                &quot;  Please supply the class and type to continue\n&quot;, resource, ID(cib_node));</a>
<a name="ln301">        return NULL;</a>
<a name="ln302"> </a>
<a name="ln303">    } else if (safe_str_neq(rclass, PCMK_RESOURCE_CLASS_OCF)</a>
<a name="ln304">               &amp;&amp; safe_str_neq(rclass, PCMK_RESOURCE_CLASS_STONITH)</a>
<a name="ln305">               &amp;&amp; safe_str_neq(rclass, PCMK_RESOURCE_CLASS_HB)</a>
<a name="ln306">               &amp;&amp; safe_str_neq(rclass, PCMK_RESOURCE_CLASS_SERVICE)</a>
<a name="ln307">               &amp;&amp; safe_str_neq(rclass, PCMK_RESOURCE_CLASS_UPSTART)</a>
<a name="ln308">               &amp;&amp; safe_str_neq(rclass, PCMK_RESOURCE_CLASS_SYSTEMD)</a>
<a name="ln309">               &amp;&amp; safe_str_neq(rclass, PCMK_RESOURCE_CLASS_LSB)) {</a>
<a name="ln310">        fprintf(stderr, &quot;Invalid class for %s: %s\n&quot;, resource, rclass);</a>
<a name="ln311">        return NULL;</a>
<a name="ln312"> </a>
<a name="ln313">    } else if (safe_str_eq(rclass, PCMK_RESOURCE_CLASS_OCF)</a>
<a name="ln314">               &amp;&amp; rprovider == NULL) {</a>
<a name="ln315">        fprintf(stderr, &quot;Please specify the provider for resource %s\n&quot;, resource);</a>
<a name="ln316">        return NULL;</a>
<a name="ln317">    }</a>
<a name="ln318"> </a>
<a name="ln319">    xpath = (char *)xmlGetNodePath(cib_node);</a>
<a name="ln320">    crm_info(&quot;Injecting new resource %s into %s '%s'&quot;, resource, xpath, ID(cib_node));</a>
<a name="ln321">    free(xpath);</a>
<a name="ln322"> </a>
<a name="ln323">    lrm = first_named_child(cib_node, XML_CIB_TAG_LRM);</a>
<a name="ln324">    if (lrm == NULL) {</a>
<a name="ln325">        const char *node_uuid = ID(cib_node);</a>
<a name="ln326"> </a>
<a name="ln327">        lrm = create_xml_node(cib_node, XML_CIB_TAG_LRM);</a>
<a name="ln328">        crm_xml_add(lrm, XML_ATTR_ID, node_uuid);</a>
<a name="ln329">    }</a>
<a name="ln330"> </a>
<a name="ln331">    container = first_named_child(lrm, XML_LRM_TAG_RESOURCES);</a>
<a name="ln332">    if (container == NULL) {</a>
<a name="ln333">        container = create_xml_node(lrm, XML_LRM_TAG_RESOURCES);</a>
<a name="ln334">    }</a>
<a name="ln335"> </a>
<a name="ln336">    cib_resource = create_xml_node(container, XML_LRM_TAG_RESOURCE);</a>
<a name="ln337">    crm_xml_add(cib_resource, XML_ATTR_ID, resource);</a>
<a name="ln338"> </a>
<a name="ln339">    crm_xml_add(cib_resource, XML_AGENT_ATTR_CLASS, rclass);</a>
<a name="ln340">    crm_xml_add(cib_resource, XML_AGENT_ATTR_PROVIDER, rprovider);</a>
<a name="ln341">    crm_xml_add(cib_resource, XML_ATTR_TYPE, rtype);</a>
<a name="ln342"> </a>
<a name="ln343">    return cib_resource;</a>
<a name="ln344">}</a>
<a name="ln345"> </a>
<a name="ln346">static int</a>
<a name="ln347">find_ticket_state(cib_t * the_cib, const char *ticket_id, xmlNode ** ticket_state_xml)</a>
<a name="ln348">{</a>
<a name="ln349">    int offset = 0;</a>
<a name="ln350">    static int xpath_max = 1024;</a>
<a name="ln351">    int rc = pcmk_ok;</a>
<a name="ln352">    xmlNode *xml_search = NULL;</a>
<a name="ln353"> </a>
<a name="ln354">    char *xpath_string = NULL;</a>
<a name="ln355"> </a>
<a name="ln356">    CRM_ASSERT(ticket_state_xml != NULL);</a>
<a name="ln357">    *ticket_state_xml = NULL;</a>
<a name="ln358"> </a>
<a name="ln359">    xpath_string = calloc(1, xpath_max);</a>
<a name="ln360">    offset += snprintf(xpath_string + offset, xpath_max - offset, &quot;%s&quot;, &quot;/cib/status/tickets&quot;);</a>
<a name="ln361"> </a>
<a name="ln362">    if (ticket_id) {</a>
<a name="ln363">        offset += snprintf(xpath_string + offset, xpath_max - offset, &quot;/%s[@id=\&quot;%s\&quot;]&quot;,</a>
<a name="ln364">                           XML_CIB_TAG_TICKET_STATE, ticket_id);</a>
<a name="ln365">    }</a>
<a name="ln366">    CRM_LOG_ASSERT(offset &gt; 0);</a>
<a name="ln367">    rc = the_cib-&gt;cmds-&gt;query(the_cib, xpath_string, &amp;xml_search,</a>
<a name="ln368">                              cib_sync_call | cib_scope_local | cib_xpath);</a>
<a name="ln369"> </a>
<a name="ln370">    if (rc != pcmk_ok) {</a>
<a name="ln371">        goto bail;</a>
<a name="ln372">    }</a>
<a name="ln373"> </a>
<a name="ln374">    crm_log_xml_debug(xml_search, &quot;Match&quot;);</a>
<a name="ln375">    if (xml_has_children(xml_search)) {</a>
<a name="ln376">        if (ticket_id) {</a>
<a name="ln377">            fprintf(stdout, &quot;Multiple ticket_states match ticket_id=%s\n&quot;, ticket_id);</a>
<a name="ln378">        }</a>
<a name="ln379">        *ticket_state_xml = xml_search;</a>
<a name="ln380">    } else {</a>
<a name="ln381">        *ticket_state_xml = xml_search;</a>
<a name="ln382">    }</a>
<a name="ln383"> </a>
<a name="ln384">  bail:</a>
<a name="ln385">    free(xpath_string);</a>
<a name="ln386">    return rc;</a>
<a name="ln387">}</a>
<a name="ln388"> </a>
<a name="ln389">static int</a>
<a name="ln390">set_ticket_state_attr(const char *ticket_id, const char *attr_name,</a>
<a name="ln391">                      const char *attr_value, cib_t * cib, int cib_options)</a>
<a name="ln392">{</a>
<a name="ln393">    int rc = pcmk_ok;</a>
<a name="ln394">    xmlNode *xml_top = NULL;</a>
<a name="ln395">    xmlNode *ticket_state_xml = NULL;</a>
<a name="ln396"> </a>
<a name="ln397">    rc = find_ticket_state(cib, ticket_id, &amp;ticket_state_xml);</a>
<a name="ln398">    if (rc == pcmk_ok) {</a>
<a name="ln399">        crm_debug(&quot;Found a match state for ticket: id=%s&quot;, ticket_id);</a>
<a name="ln400">        xml_top = ticket_state_xml;</a>
<a name="ln401"> </a>
<a name="ln402">    } else if (rc != -ENXIO) {</a>
<a name="ln403">        return rc;</a>
<a name="ln404"> </a>
<a name="ln405">    } else {</a>
<a name="ln406">        xmlNode *xml_obj = NULL;</a>
<a name="ln407"> </a>
<a name="ln408">        xml_top = create_xml_node(NULL, XML_CIB_TAG_STATUS);</a>
<a name="ln409">        xml_obj = create_xml_node(xml_top, XML_CIB_TAG_TICKETS);</a>
<a name="ln410">        ticket_state_xml = create_xml_node(xml_obj, XML_CIB_TAG_TICKET_STATE);</a>
<a name="ln411">        crm_xml_add(ticket_state_xml, XML_ATTR_ID, ticket_id);</a>
<a name="ln412">    }</a>
<a name="ln413"> </a>
<a name="ln414">    crm_xml_add(ticket_state_xml, attr_name, attr_value);</a>
<a name="ln415"> </a>
<a name="ln416">    crm_log_xml_debug(xml_top, &quot;Update&quot;);</a>
<a name="ln417"> </a>
<a name="ln418">    rc = cib-&gt;cmds-&gt;modify(cib, XML_CIB_TAG_STATUS, xml_top, cib_options);</a>
<a name="ln419"> </a>
<a name="ln420">    free_xml(xml_top);</a>
<a name="ln421"> </a>
<a name="ln422">    return rc;</a>
<a name="ln423">}</a>
<a name="ln424"> </a>
<a name="ln425">void</a>
<a name="ln426">modify_configuration(pe_working_set_t * data_set, cib_t *cib,</a>
<a name="ln427">                     const char *quorum, const char *watchdog, GListPtr node_up, GListPtr node_down, GListPtr node_fail,</a>
<a name="ln428">                     GListPtr op_inject, GListPtr ticket_grant, GListPtr ticket_revoke,</a>
<a name="ln429">                     GListPtr ticket_standby, GListPtr ticket_activate)</a>
<a name="ln430">{</a>
<a name="ln431">    int rc = pcmk_ok;</a>
<a name="ln432">    GListPtr gIter = NULL;</a>
<a name="ln433"> </a>
<a name="ln434">    xmlNode *cib_op = NULL;</a>
<a name="ln435">    xmlNode *cib_node = NULL;</a>
<a name="ln436">    xmlNode *cib_resource = NULL;</a>
<a name="ln437"> </a>
<a name="ln438">    lrmd_event_data_t *op = NULL;</a>
<a name="ln439"> </a>
<a name="ln440">    if (quorum) {</a>
<a name="ln441">        xmlNode *top = create_xml_node(NULL, XML_TAG_CIB);</a>
<a name="ln442"> </a>
<a name="ln443">        quiet_log(&quot; + Setting quorum: %s\n&quot;, quorum);</a>
<a name="ln444">        /* crm_xml_add(top, XML_ATTR_DC_UUID, dc_uuid);      */</a>
<a name="ln445">        crm_xml_add(top, XML_ATTR_HAVE_QUORUM, quorum);</a>
<a name="ln446"> </a>
<a name="ln447">        rc = cib-&gt;cmds-&gt;modify(cib, NULL, top, cib_sync_call | cib_scope_local);</a>
<a name="ln448">        CRM_ASSERT(rc == pcmk_ok);</a>
<a name="ln449">    }</a>
<a name="ln450"> </a>
<a name="ln451">    if (watchdog) {</a>
<a name="ln452">        quiet_log(&quot; + Setting watchdog: %s\n&quot;, watchdog);</a>
<a name="ln453"> </a>
<a name="ln454">        rc = update_attr_delegate(cib, cib_sync_call | cib_scope_local,</a>
<a name="ln455">                             XML_CIB_TAG_CRMCONFIG, NULL, NULL, NULL, NULL,</a>
<a name="ln456">                             XML_ATTR_HAVE_WATCHDOG, watchdog, FALSE, NULL, NULL);</a>
<a name="ln457"> </a>
<a name="ln458">        CRM_ASSERT(rc == pcmk_ok);</a>
<a name="ln459">    }</a>
<a name="ln460"> </a>
<a name="ln461">    for (gIter = node_up; gIter != NULL; gIter = gIter-&gt;next) {</a>
<a name="ln462">        char *node = (char *)gIter-&gt;data;</a>
<a name="ln463"> </a>
<a name="ln464">        quiet_log(&quot; + Bringing node %s online\n&quot;, node);</a>
<a name="ln465">        cib_node = modify_node(cib, node, TRUE);</a>
<a name="ln466">        CRM_ASSERT(cib_node != NULL);</a>
<a name="ln467"> </a>
<a name="ln468">        rc = cib-&gt;cmds-&gt;modify(cib, XML_CIB_TAG_STATUS, cib_node,</a>
<a name="ln469">                                      cib_sync_call | cib_scope_local);</a>
<a name="ln470">        CRM_ASSERT(rc == pcmk_ok);</a>
<a name="ln471">        free_xml(cib_node);</a>
<a name="ln472">    }</a>
<a name="ln473"> </a>
<a name="ln474">    for (gIter = node_down; gIter != NULL; gIter = gIter-&gt;next) {</a>
<a name="ln475">        char xpath[STATUS_PATH_MAX];</a>
<a name="ln476">        char *node = (char *)gIter-&gt;data;</a>
<a name="ln477"> </a>
<a name="ln478">        quiet_log(&quot; + Taking node %s offline\n&quot;, node);</a>
<a name="ln479">        cib_node = modify_node(cib, node, FALSE);</a>
<a name="ln480">        CRM_ASSERT(cib_node != NULL);</a>
<a name="ln481"> </a>
<a name="ln482">        rc = cib-&gt;cmds-&gt;modify(cib, XML_CIB_TAG_STATUS, cib_node,</a>
<a name="ln483">                                      cib_sync_call | cib_scope_local);</a>
<a name="ln484">        CRM_ASSERT(rc == pcmk_ok);</a>
<a name="ln485">        free_xml(cib_node);</a>
<a name="ln486"> </a>
<a name="ln487">        snprintf(xpath, STATUS_PATH_MAX, &quot;//node_state[@uname='%s']/%s&quot;, node, XML_CIB_TAG_LRM);</a>
<a name="ln488">        cib-&gt;cmds-&gt;delete(cib, xpath, NULL,</a>
<a name="ln489">                                      cib_xpath | cib_sync_call | cib_scope_local);</a>
<a name="ln490"> </a>
<a name="ln491">        snprintf(xpath, STATUS_PATH_MAX, &quot;//node_state[@uname='%s']/%s&quot;, node,</a>
<a name="ln492">                 XML_TAG_TRANSIENT_NODEATTRS);</a>
<a name="ln493">        cib-&gt;cmds-&gt;delete(cib, xpath, NULL,</a>
<a name="ln494">                                      cib_xpath | cib_sync_call | cib_scope_local);</a>
<a name="ln495"> </a>
<a name="ln496">    }</a>
<a name="ln497"> </a>
<a name="ln498">    for (gIter = node_fail; gIter != NULL; gIter = gIter-&gt;next) {</a>
<a name="ln499">        char *node = (char *)gIter-&gt;data;</a>
<a name="ln500"> </a>
<a name="ln501">        quiet_log(&quot; + Failing node %s\n&quot;, node);</a>
<a name="ln502">        cib_node = modify_node(cib, node, TRUE);</a>
<a name="ln503">        crm_xml_add(cib_node, XML_NODE_IN_CLUSTER, XML_BOOLEAN_NO);</a>
<a name="ln504">        CRM_ASSERT(cib_node != NULL);</a>
<a name="ln505"> </a>
<a name="ln506">        rc = cib-&gt;cmds-&gt;modify(cib, XML_CIB_TAG_STATUS, cib_node,</a>
<a name="ln507">                                      cib_sync_call | cib_scope_local);</a>
<a name="ln508">        CRM_ASSERT(rc == pcmk_ok);</a>
<a name="ln509">        free_xml(cib_node);</a>
<a name="ln510">    }</a>
<a name="ln511"> </a>
<a name="ln512">    for (gIter = ticket_grant; gIter != NULL; gIter = gIter-&gt;next) {</a>
<a name="ln513">        char *ticket_id = (char *)gIter-&gt;data;</a>
<a name="ln514"> </a>
<a name="ln515">        quiet_log(&quot; + Granting ticket %s\n&quot;, ticket_id);</a>
<a name="ln516">        rc = set_ticket_state_attr(ticket_id, &quot;granted&quot;, &quot;true&quot;,</a>
<a name="ln517">                                   cib, cib_sync_call | cib_scope_local);</a>
<a name="ln518"> </a>
<a name="ln519">        CRM_ASSERT(rc == pcmk_ok);</a>
<a name="ln520">    }</a>
<a name="ln521"> </a>
<a name="ln522">    for (gIter = ticket_revoke; gIter != NULL; gIter = gIter-&gt;next) {</a>
<a name="ln523">        char *ticket_id = (char *)gIter-&gt;data;</a>
<a name="ln524"> </a>
<a name="ln525">        quiet_log(&quot; + Revoking ticket %s\n&quot;, ticket_id);</a>
<a name="ln526">        rc = set_ticket_state_attr(ticket_id, &quot;granted&quot;, &quot;false&quot;,</a>
<a name="ln527">                                   cib, cib_sync_call | cib_scope_local);</a>
<a name="ln528"> </a>
<a name="ln529">        CRM_ASSERT(rc == pcmk_ok);</a>
<a name="ln530">    }</a>
<a name="ln531"> </a>
<a name="ln532">    for (gIter = ticket_standby; gIter != NULL; gIter = gIter-&gt;next) {</a>
<a name="ln533">        char *ticket_id = (char *)gIter-&gt;data;</a>
<a name="ln534"> </a>
<a name="ln535">        quiet_log(&quot; + Making ticket %s standby\n&quot;, ticket_id);</a>
<a name="ln536">        rc = set_ticket_state_attr(ticket_id, &quot;standby&quot;, &quot;true&quot;,</a>
<a name="ln537">                                   cib, cib_sync_call | cib_scope_local);</a>
<a name="ln538"> </a>
<a name="ln539">        CRM_ASSERT(rc == pcmk_ok);</a>
<a name="ln540">    }</a>
<a name="ln541"> </a>
<a name="ln542">    for (gIter = ticket_activate; gIter != NULL; gIter = gIter-&gt;next) {</a>
<a name="ln543">        char *ticket_id = (char *)gIter-&gt;data;</a>
<a name="ln544"> </a>
<a name="ln545">        quiet_log(&quot; + Activating ticket %s\n&quot;, ticket_id);</a>
<a name="ln546">        rc = set_ticket_state_attr(ticket_id, &quot;standby&quot;, &quot;false&quot;,</a>
<a name="ln547">                                   cib, cib_sync_call | cib_scope_local);</a>
<a name="ln548"> </a>
<a name="ln549">        CRM_ASSERT(rc == pcmk_ok);</a>
<a name="ln550">    }</a>
<a name="ln551"> </a>
<a name="ln552">    for (gIter = op_inject; gIter != NULL; gIter = gIter-&gt;next) {</a>
<a name="ln553">        char *spec = (char *)gIter-&gt;data;</a>
<a name="ln554"> </a>
<a name="ln555">        int rc = 0;</a>
<a name="ln556">        int outcome = 0;</a>
<a name="ln557">        int interval = 0;</a>
<a name="ln558"> </a>
<a name="ln559">        char *key = NULL;</a>
<a name="ln560">        char *node = NULL;</a>
<a name="ln561">        char *task = NULL;</a>
<a name="ln562">        char *resource = NULL;</a>
<a name="ln563"> </a>
<a name="ln564">        const char *rtype = NULL;</a>
<a name="ln565">        const char *rclass = NULL;</a>
<a name="ln566">        const char *rprovider = NULL;</a>
<a name="ln567"> </a>
<a name="ln568">        resource_t *rsc = NULL;</a>
<a name="ln569"> </a>
<a name="ln570">        quiet_log(&quot; + Injecting %s into the configuration\n&quot;, spec);</a>
<a name="ln571"> </a>
<a name="ln572">        key = calloc(1, strlen(spec) + 1);</a>
<a name="ln573">        node = calloc(1, strlen(spec) + 1);</a>
<a name="ln574">        rc = sscanf(spec, &quot;%[^@]@%[^=]=%d&quot;, key, node, &amp;outcome);</a>
<a name="ln575">        if (rc != 3) {</a>
<a name="ln576">            fprintf(stderr, &quot;Invalid operation spec: %s.  Only found %d fields\n&quot;, spec, rc);</a>
<a name="ln577">            free(key);</a>
<a name="ln578">            free(node);</a>
<a name="ln579">            continue;</a>
<a name="ln580">        }</a>
<a name="ln581"> </a>
<a name="ln582">        parse_op_key(key, &amp;resource, &amp;task, &amp;interval);</a>
<a name="ln583"> </a>
<a name="ln584">        rsc = pe_find_resource(data_set-&gt;resources, resource);</a>
<a name="ln585">        if (rsc == NULL) {</a>
<a name="ln586">            fprintf(stderr, &quot; - Invalid resource name: %s\n&quot;, resource);</a>
<a name="ln587">        } else {</a>
<a name="ln588">            rclass = crm_element_value(rsc-&gt;xml, XML_AGENT_ATTR_CLASS);</a>
<a name="ln589">            rtype = crm_element_value(rsc-&gt;xml, XML_ATTR_TYPE);</a>
<a name="ln590">            rprovider = crm_element_value(rsc-&gt;xml, XML_AGENT_ATTR_PROVIDER);</a>
<a name="ln591"> </a>
<a name="ln592">            cib_node = inject_node_state(cib, node, NULL);</a>
<a name="ln593">            CRM_ASSERT(cib_node != NULL);</a>
<a name="ln594"> </a>
<a name="ln595">            update_failcounts(cib_node, resource, task, interval, outcome);</a>
<a name="ln596"> </a>
<a name="ln597">            cib_resource = inject_resource(cib_node, resource, rclass, rtype, rprovider);</a>
<a name="ln598">            CRM_ASSERT(cib_resource != NULL);</a>
<a name="ln599"> </a>
<a name="ln600">            op = create_op(cib_resource, task, interval, outcome);</a>
<a name="ln601">            CRM_ASSERT(op != NULL);</a>
<a name="ln602"> </a>
<a name="ln603">            cib_op = inject_op(cib_resource, op, 0);</a>
<a name="ln604">            CRM_ASSERT(cib_op != NULL);</a>
<a name="ln605">            lrmd_free_event(op);</a>
<a name="ln606"> </a>
<a name="ln607">            rc = cib-&gt;cmds-&gt;modify(cib, XML_CIB_TAG_STATUS, cib_node,</a>
<a name="ln608">                                          cib_sync_call | cib_scope_local);</a>
<a name="ln609">            CRM_ASSERT(rc == pcmk_ok);</a>
<a name="ln610">        }</a>
<a name="ln611">        free(task);</a>
<a name="ln612">        free(node);</a>
<a name="ln613">        free(key);</a>
<a name="ln614">    }</a>
<a name="ln615">}</a>
<a name="ln616"> </a>
<a name="ln617">static gboolean</a>
<a name="ln618">exec_pseudo_action(crm_graph_t * graph, crm_action_t * action)</a>
<a name="ln619">{</a>
<a name="ln620">    const char *node = crm_element_value(action-&gt;xml, XML_LRM_ATTR_TARGET);</a>
<a name="ln621">    const char *task = crm_element_value(action-&gt;xml, XML_LRM_ATTR_TASK_KEY);</a>
<a name="ln622"> </a>
<a name="ln623">    action-&gt;confirmed = TRUE;</a>
<a name="ln624"> </a>
<a name="ln625">    quiet_log(&quot; * Pseudo action:   %s%s%s\n&quot;, task, node ? &quot; on &quot; : &quot;&quot;, node ? node : &quot;&quot;);</a>
<a name="ln626">    update_graph(graph, action);</a>
<a name="ln627">    return TRUE;</a>
<a name="ln628">}</a>
<a name="ln629"> </a>
<a name="ln630">static gboolean</a>
<a name="ln631">exec_rsc_action(crm_graph_t * graph, crm_action_t * action)</a>
<a name="ln632">{</a>
<a name="ln633">    int rc = 0;</a>
<a name="ln634">    GListPtr gIter = NULL;</a>
<a name="ln635">    lrmd_event_data_t *op = NULL;</a>
<a name="ln636">    int target_outcome = 0;</a>
<a name="ln637">    gboolean uname_is_uuid = FALSE;</a>
<a name="ln638"> </a>
<a name="ln639">    const char *rtype = NULL;</a>
<a name="ln640">    const char *rclass = NULL;</a>
<a name="ln641">    const char *resource = NULL;</a>
<a name="ln642">    const char *rprovider = NULL;</a>
<a name="ln643">    const char *operation = crm_element_value(action-&gt;xml, &quot;operation&quot;);</a>
<a name="ln644">    const char *target_rc_s = crm_meta_value(action-&gt;params, XML_ATTR_TE_TARGET_RC);</a>
<a name="ln645"> </a>
<a name="ln646">    xmlNode *cib_node = NULL;</a>
<a name="ln647">    xmlNode *cib_resource = NULL;</a>
<a name="ln648">    xmlNode *action_rsc = first_named_child(action-&gt;xml, XML_CIB_TAG_RESOURCE);</a>
<a name="ln649"> </a>
<a name="ln650">    char *node = crm_element_value_copy(action-&gt;xml, XML_LRM_ATTR_TARGET);</a>
<a name="ln651">    char *uuid = crm_element_value_copy(action-&gt;xml, XML_LRM_ATTR_TARGET_UUID);</a>
<a name="ln652">    const char *router_node = crm_element_value(action-&gt;xml, XML_LRM_ATTR_ROUTER_NODE);</a>
<a name="ln653"> </a>
<a name="ln654">    if (safe_str_eq(operation, CRM_OP_PROBED)</a>
<a name="ln655">        || safe_str_eq(operation, CRM_OP_REPROBE)) {</a>
<a name="ln656">        crm_info(&quot;Skipping %s op for %s&quot;, operation, node);</a>
<a name="ln657">        goto done;</a>
<a name="ln658">    }</a>
<a name="ln659"> </a>
<a name="ln660">    if (action_rsc == NULL) {</a>
<a name="ln661">        crm_log_xml_err(action-&gt;xml, &quot;Bad&quot;);</a>
<a name="ln662">        free(node); free(uuid);</a>
<a name="ln663">        return FALSE;</a>
<a name="ln664">    }</a>
<a name="ln665"> </a>
<a name="ln666">    /* Look for the preferred name</a>
<a name="ln667">     * If not found, try the expected 'local' name</a>
<a name="ln668">     * If not found use the preferred name anyway</a>
<a name="ln669">     */</a>
<a name="ln670">    resource = crm_element_value(action_rsc, XML_ATTR_ID);</a>
<a name="ln671">    if (pe_find_resource(fake_resource_list, resource) == NULL) {</a>
<a name="ln672">        const char *longname = crm_element_value(action_rsc, XML_ATTR_ID_LONG);</a>
<a name="ln673"> </a>
<a name="ln674">        if (pe_find_resource(fake_resource_list, longname)) {</a>
<a name="ln675">            resource = longname;</a>
<a name="ln676">        }</a>
<a name="ln677">    }</a>
<a name="ln678"> </a>
<a name="ln679">    if (safe_str_eq(operation, &quot;delete&quot;) || safe_str_eq(operation, RSC_METADATA)) {</a>
<a name="ln680">        quiet_log(&quot; * Resource action: %-15s %s on %s\n&quot;, resource, operation, node);</a>
<a name="ln681">        goto done;</a>
<a name="ln682">    }</a>
<a name="ln683"> </a>
<a name="ln684">    rclass = crm_element_value(action_rsc, XML_AGENT_ATTR_CLASS);</a>
<a name="ln685">    rtype = crm_element_value(action_rsc, XML_ATTR_TYPE);</a>
<a name="ln686">    rprovider = crm_element_value(action_rsc, XML_AGENT_ATTR_PROVIDER);</a>
<a name="ln687"> </a>
<a name="ln688">    if (target_rc_s != NULL) {</a>
<a name="ln689">        target_outcome = crm_parse_int(target_rc_s, &quot;0&quot;);</a>
<a name="ln690">    }</a>
<a name="ln691"> </a>
<a name="ln692">    CRM_ASSERT(fake_cib-&gt;cmds-&gt;query(fake_cib, NULL, NULL, cib_sync_call | cib_scope_local) ==</a>
<a name="ln693">               pcmk_ok);</a>
<a name="ln694"> </a>
<a name="ln695">    if (router_node) {</a>
<a name="ln696">        uname_is_uuid = TRUE;</a>
<a name="ln697">    }</a>
<a name="ln698"> </a>
<a name="ln699">    cib_node = inject_node_state(fake_cib, node, uname_is_uuid ? node : uuid);</a>
<a name="ln700">    CRM_ASSERT(cib_node != NULL);</a>
<a name="ln701"> </a>
<a name="ln702">    cib_resource = inject_resource(cib_node, resource, rclass, rtype, rprovider);</a>
<a name="ln703">    CRM_ASSERT(cib_resource != NULL);</a>
<a name="ln704"> </a>
<a name="ln705">    op = convert_graph_action(cib_resource, action, 0, target_outcome);</a>
<a name="ln706">    if (op-&gt;interval) {</a>
<a name="ln707">        quiet_log(&quot; * Resource action: %-15s %s=%d on %s\n&quot;, resource, op-&gt;op_type, op-&gt;interval,</a>
<a name="ln708">                  node);</a>
<a name="ln709">    } else {</a>
<a name="ln710">        quiet_log(&quot; * Resource action: %-15s %s on %s\n&quot;, resource, op-&gt;op_type, node);</a>
<a name="ln711">    }</a>
<a name="ln712"> </a>
<a name="ln713">    for (gIter = fake_op_fail_list; gIter != NULL; gIter = gIter-&gt;next) {</a>
<a name="ln714">        char *spec = (char *)gIter-&gt;data;</a>
<a name="ln715">        char *key = NULL;</a>
<a name="ln716"> </a>
<a name="ln717">        key = calloc(1, 1 + strlen(spec));</a>
<a name="ln718">        snprintf(key, strlen(spec), &quot;%s_%s_%d@%s=&quot;, resource, op-&gt;op_type, op-&gt;interval, node);</a>
<a name="ln719"> </a>
<a name="ln720">        if (strncasecmp(key, spec, strlen(key)) == 0) {</a>
<a name="ln721">            sscanf(spec, &quot;%*[^=]=%d&quot;, (int *)&amp;op-&gt;rc);</a>
<a name="ln722"> </a>
<a name="ln723">            action-&gt;failed = TRUE;</a>
<a name="ln724">            graph-&gt;abort_priority = INFINITY;</a>
<a name="ln725">            printf(&quot;\tPretending action %d failed with rc=%d\n&quot;, action-&gt;id, op-&gt;rc);</a>
<a name="ln726">            update_failcounts(cib_node, resource, op-&gt;op_type, op-&gt;interval, op-&gt;rc);</a>
<a name="ln727">            free(key);</a>
<a name="ln728">            break;</a>
<a name="ln729">        }</a>
<a name="ln730">        free(key);</a>
<a name="ln731">    }</a>
<a name="ln732"> </a>
<a name="ln733">    inject_op(cib_resource, op, target_outcome);</a>
<a name="ln734">    lrmd_free_event(op);</a>
<a name="ln735"> </a>
<a name="ln736">    rc = fake_cib-&gt;cmds-&gt;modify(fake_cib, XML_CIB_TAG_STATUS, cib_node,</a>
<a name="ln737">                                  cib_sync_call | cib_scope_local);</a>
<a name="ln738">    CRM_ASSERT(rc == pcmk_ok);</a>
<a name="ln739"> </a>
<a name="ln740">  done:</a>
<a name="ln741">    free(node); free(uuid);</a>
<a name="ln742">    free_xml(cib_node);</a>
<a name="ln743">    action-&gt;confirmed = TRUE;</a>
<a name="ln744">    update_graph(graph, action);</a>
<a name="ln745">    return TRUE;</a>
<a name="ln746">}</a>
<a name="ln747"> </a>
<a name="ln748">static gboolean</a>
<a name="ln749">exec_crmd_action(crm_graph_t * graph, crm_action_t * action)</a>
<a name="ln750">{</a>
<a name="ln751">    const char *node = crm_element_value(action-&gt;xml, XML_LRM_ATTR_TARGET);</a>
<a name="ln752">    const char *task = crm_element_value(action-&gt;xml, XML_LRM_ATTR_TASK);</a>
<a name="ln753">    xmlNode *rsc = first_named_child(action-&gt;xml, XML_CIB_TAG_RESOURCE);</a>
<a name="ln754"> </a>
<a name="ln755">    action-&gt;confirmed = TRUE;</a>
<a name="ln756"> </a>
<a name="ln757">    if(rsc) {</a>
<a name="ln758">        quiet_log(&quot; * Cluster action:  %s for %s on %s\n&quot;, task, ID(rsc), node);</a>
<a name="ln759">    } else {</a>
<a name="ln760">        quiet_log(&quot; * Cluster action:  %s on %s\n&quot;, task, node);</a>
<a name="ln761">    }</a>
<a name="ln762">    update_graph(graph, action);</a>
<a name="ln763">    return TRUE;</a>
<a name="ln764">}</a>
<a name="ln765"> </a>
<a name="ln766">static gboolean</a>
<a name="ln767">exec_stonith_action(crm_graph_t * graph, crm_action_t * action)</a>
<a name="ln768">{</a>
<a name="ln769">    const char *op = crm_meta_value(action-&gt;params, &quot;stonith_action&quot;);</a>
<a name="ln770">    char *target = crm_element_value_copy(action-&gt;xml, XML_LRM_ATTR_TARGET);</a>
<a name="ln771"> </a>
<a name="ln772">    quiet_log(&quot; * Fencing %s (%s)\n&quot;, target, op);</a>
<a name="ln773">    if(safe_str_neq(op, &quot;on&quot;)) {</a>
<a name="ln774">        int rc = 0;</a>
<a name="ln775">        char xpath[STATUS_PATH_MAX];</a>
<a name="ln776">        xmlNode *cib_node = modify_node(fake_cib, target, FALSE);</a>
<a name="ln777"> </a>
<a name="ln778">        crm_xml_add(cib_node, XML_ATTR_ORIGIN, __FUNCTION__);</a>
<a name="ln779">        CRM_ASSERT(cib_node != NULL);</a>
<a name="ln780"> </a>
<a name="ln781">        rc = fake_cib-&gt;cmds-&gt;replace(fake_cib, XML_CIB_TAG_STATUS, cib_node,</a>
<a name="ln782">                                   cib_sync_call | cib_scope_local);</a>
<a name="ln783">        CRM_ASSERT(rc == pcmk_ok);</a>
<a name="ln784"> </a>
<a name="ln785">        snprintf(xpath, STATUS_PATH_MAX, &quot;//node_state[@uname='%s']/%s&quot;, target, XML_CIB_TAG_LRM);</a>
<a name="ln786">        fake_cib-&gt;cmds-&gt;delete(fake_cib, xpath, NULL,</a>
<a name="ln787">                                      cib_xpath | cib_sync_call | cib_scope_local);</a>
<a name="ln788"> </a>
<a name="ln789">        snprintf(xpath, STATUS_PATH_MAX, &quot;//node_state[@uname='%s']/%s&quot;, target,</a>
<a name="ln790">                 XML_TAG_TRANSIENT_NODEATTRS);</a>
<a name="ln791">        fake_cib-&gt;cmds-&gt;delete(fake_cib, xpath, NULL,</a>
<a name="ln792">                                      cib_xpath | cib_sync_call | cib_scope_local);</a>
<a name="ln793"> </a>
<a name="ln794">        free_xml(cib_node);</a>
<a name="ln795">    }</a>
<a name="ln796"> </a>
<a name="ln797">    action-&gt;confirmed = TRUE;</a>
<a name="ln798">    update_graph(graph, action);</a>
<a name="ln799">    free(target);</a>
<a name="ln800">    return TRUE;</a>
<a name="ln801">}</a>
<a name="ln802"> </a>
<a name="ln803">int</a>
<a name="ln804">run_simulation(pe_working_set_t * data_set, cib_t *cib, GListPtr op_fail_list, bool quiet)</a>
<a name="ln805">{</a>
<a name="ln806">    crm_graph_t *transition = NULL;</a>
<a name="ln807">    enum transition_status graph_rc = -1;</a>
<a name="ln808"> </a>
<a name="ln809">    crm_graph_functions_t exec_fns = {</a>
<a name="ln810">        exec_pseudo_action,</a>
<a name="ln811">        exec_rsc_action,</a>
<a name="ln812">        exec_crmd_action,</a>
<a name="ln813">        exec_stonith_action,</a>
<a name="ln814">    };</a>
<a name="ln815"> </a>
<a name="ln816">    fake_cib = cib;</a>
<a name="ln817">    fake_quiet = quiet;</a>
<a name="ln818">    fake_op_fail_list = op_fail_list;</a>
<a name="ln819"> </a>
<a name="ln820">    quiet_log(&quot;\nExecuting cluster transition:\n&quot;);</a>
<a name="ln821"> </a>
<a name="ln822">    set_graph_functions(&amp;exec_fns);</a>
<a name="ln823">    transition = unpack_graph(data_set-&gt;graph, crm_system_name);</a>
<a name="ln824">    print_graph(LOG_DEBUG, transition);</a>
<a name="ln825"> </a>
<a name="ln826">    fake_resource_list = data_set-&gt;resources;</a>
<a name="ln827">    do {</a>
<a name="ln828">        graph_rc = run_graph(transition);</a>
<a name="ln829"> </a>
<a name="ln830">    } while (graph_rc == transition_active);</a>
<a name="ln831">    fake_resource_list = NULL;</a>
<a name="ln832"> </a>
<a name="ln833">    if (graph_rc != transition_complete) {</a>
<a name="ln834">        fprintf(stdout, &quot;Transition failed: %s\n&quot;, transition_status(graph_rc));</a>
<a name="ln835">        print_graph(LOG_ERR, transition);</a>
<a name="ln836">    }</a>
<a name="ln837">    destroy_graph(transition);</a>
<a name="ln838">    if (graph_rc != transition_complete) {</a>
<a name="ln839">        fprintf(stdout, &quot;An invalid transition was produced\n&quot;);</a>
<a name="ln840">    }</a>
<a name="ln841"> </a>
<a name="ln842">    if (quiet == FALSE) {</a>
<a name="ln843">        xmlNode *cib_object = NULL;</a>
<a name="ln844">        int rc = fake_cib-&gt;cmds-&gt;query(fake_cib, NULL, &amp;cib_object, cib_sync_call | cib_scope_local);</a>
<a name="ln845"> </a>
<a name="ln846">        CRM_ASSERT(rc == pcmk_ok);</a>
<a name="ln847">        cleanup_alloc_calculations(data_set);</a>
<a name="ln848">        data_set-&gt;input = cib_object;</a>
<a name="ln849">    }</a>
<a name="ln850"> </a>
<a name="ln851">    if (graph_rc != transition_complete) {</a>
<a name="ln852">        return graph_rc;</a>
<a name="ln853">    }</a>
<a name="ln854">    return 0;</a>
<a name="ln855">}</a>

</code></pre>
<div class="balloon" rel="160"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'op'. Check lines: 160, 158.</p></div>
<div class="balloon" rel="360"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V769/" target="_blank">V769</a> The 'xpath_string' pointer in the 'xpath_string + offset' expression could be nullptr. In such case, resulting value will be senseless and it should not be used. Check lines: 360, 359.</p></div>
<div class="balloon" rel="366"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V562/" target="_blank">V562</a> It's odd to compare 0 or 1 with a value of 0: (offset > 0) == (0).</p></div>
<div class="balloon" rel="195"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V522/" target="_blank">V522</a> Dereferencing of the null pointer 'node' might take place. The potential null pointer is passed into 'inject_node_state' function. Inspect the second argument. Check lines: 195, 592, 573.</p></div>
<div class="balloon" rel="574"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V576/" target="_blank">V576</a> Incorrect format. Consider checking the third actual argument of the 'sscanf' function. It's dangerous to use string specifier without width specification. Buffer overflow is possible.</p></div>
<div class="balloon" rel="574"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V576/" target="_blank">V576</a> Incorrect format. Consider checking the fourth actual argument of the 'sscanf' function. It's dangerous to use string specifier without width specification. Buffer overflow is possible.</p></div>
<div class="balloon" rel="720"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V575/" target="_blank">V575</a> The potential null pointer is passed into 'strlen' function. Inspect the first argument. Check lines: 720, 717.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
