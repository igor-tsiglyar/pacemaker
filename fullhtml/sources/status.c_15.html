
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class="cpp">
<a name="ln1"> </a>
<a name="ln2">// This is an open source non-commercial project. Dear PVS-Studio, please check it.</a>
<a name="ln3"> </a>
<a name="ln4">// PVS-Studio Static Code Analyzer for C, C++ and C#: http://www.viva64.com</a>
<a name="ln5">/*</a>
<a name="ln6"> * Copyright (C) 2004 Andrew Beekhof &lt;andrew@beekhof.net&gt;</a>
<a name="ln7"> *</a>
<a name="ln8"> * This library is free software; you can redistribute it and/or</a>
<a name="ln9"> * modify it under the terms of the GNU Lesser General Public</a>
<a name="ln10"> * License as published by the Free Software Foundation; either</a>
<a name="ln11"> * version 2.1 of the License, or (at your option) any later version.</a>
<a name="ln12"> *</a>
<a name="ln13"> * This library is distributed in the hope that it will be useful,</a>
<a name="ln14"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln15"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</a>
<a name="ln16"> * Lesser General Public License for more details.</a>
<a name="ln17"> *</a>
<a name="ln18"> * You should have received a copy of the GNU Lesser General Public</a>
<a name="ln19"> * License along with this library; if not, write to the Free Software</a>
<a name="ln20"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</a>
<a name="ln21"> */</a>
<a name="ln22"> </a>
<a name="ln23">#include &lt;crm_internal.h&gt;</a>
<a name="ln24"> </a>
<a name="ln25">#include &lt;sys/param.h&gt;</a>
<a name="ln26"> </a>
<a name="ln27">#include &lt;crm/crm.h&gt;</a>
<a name="ln28">#include &lt;crm/msg_xml.h&gt;</a>
<a name="ln29">#include &lt;crm/common/xml.h&gt;</a>
<a name="ln30"> </a>
<a name="ln31">#include &lt;glib.h&gt;</a>
<a name="ln32"> </a>
<a name="ln33">#include &lt;crm/pengine/internal.h&gt;</a>
<a name="ln34">#include &lt;unpack.h&gt;</a>
<a name="ln35"> </a>
<a name="ln36">#define MEMCHECK_STAGE_0 0</a>
<a name="ln37"> </a>
<a name="ln38">#define check_and_exit(stage) 	cleanup_calculations(data_set);		\</a>
<a name="ln39">	crm_mem_stats(NULL);						\</a>
<a name="ln40">	crm_err(&quot;Exiting: stage %d&quot;, stage);				\</a>
<a name="ln41">	crm_exit(pcmk_err_generic);</a>
<a name="ln42"> </a>
<a name="ln43">/*</a>
<a name="ln44"> * Unpack everything</a>
<a name="ln45"> * At the end you'll have:</a>
<a name="ln46"> *  - A list of nodes</a>
<a name="ln47"> *  - A list of resources (each with any dependencies on other resources)</a>
<a name="ln48"> *  - A list of constraints between resources and nodes</a>
<a name="ln49"> *  - A list of constraints between start/stop actions</a>
<a name="ln50"> *  - A list of nodes that need to be stonith'd</a>
<a name="ln51"> *  - A list of nodes that need to be shutdown</a>
<a name="ln52"> *  - A list of the possible stop/start actions (without dependencies)</a>
<a name="ln53"> */</a>
<a name="ln54">gboolean</a>
<a name="ln55">cluster_status(pe_working_set_t * data_set)</a>
<a name="ln56">{</a>
<a name="ln57">    xmlNode *config = get_xpath_object(&quot;//&quot;XML_CIB_TAG_CRMCONFIG, data_set-&gt;input, LOG_TRACE);</a>
<a name="ln58">    xmlNode *cib_nodes = get_xpath_object(&quot;//&quot;XML_CIB_TAG_NODES, data_set-&gt;input, LOG_TRACE);</a>
<a name="ln59">    xmlNode *cib_resources = get_xpath_object(&quot;//&quot;XML_CIB_TAG_RESOURCES, data_set-&gt;input, LOG_TRACE);</a>
<a name="ln60">    xmlNode *cib_status = get_xpath_object(&quot;//&quot;XML_CIB_TAG_STATUS, data_set-&gt;input, LOG_TRACE);</a>
<a name="ln61">    xmlNode *cib_tags = get_xpath_object(&quot;//&quot;XML_CIB_TAG_TAGS, data_set-&gt;input, LOG_TRACE);</a>
<a name="ln62">    const char *value = crm_element_value(data_set-&gt;input, XML_ATTR_HAVE_QUORUM);</a>
<a name="ln63"> </a>
<a name="ln64">    crm_trace(&quot;Beginning unpack&quot;);</a>
<a name="ln65">    pe_dataset = data_set;</a>
<a name="ln66"> </a>
<a name="ln67">    /* reset remaining global variables */</a>
<a name="ln68">    data_set-&gt;failed = create_xml_node(NULL, &quot;failed-ops&quot;);</a>
<a name="ln69"> </a>
<a name="ln70">    if (data_set-&gt;input == NULL) {</a>
<a name="ln71">        return FALSE;</a>
<a name="ln72">    }</a>
<a name="ln73"> </a>
<a name="ln74">    if (data_set-&gt;now == NULL) {</a>
<a name="ln75">        data_set-&gt;now = crm_time_new(NULL);</a>
<a name="ln76">    }</a>
<a name="ln77"> </a>
<a name="ln78">    if (data_set-&gt;dc_uuid == NULL</a>
<a name="ln79">        &amp;&amp; data_set-&gt;input != NULL</a>
<a name="ln80">        &amp;&amp; crm_element_value(data_set-&gt;input, XML_ATTR_DC_UUID) != NULL) {</a>
<a name="ln81">        /* this should always be present */</a>
<a name="ln82">        data_set-&gt;dc_uuid = crm_element_value_copy(data_set-&gt;input, XML_ATTR_DC_UUID);</a>
<a name="ln83">    }</a>
<a name="ln84"> </a>
<a name="ln85">    clear_bit(data_set-&gt;flags, pe_flag_have_quorum);</a>
<a name="ln86">    if (crm_is_true(value)) {</a>
<a name="ln87">        set_bit(data_set-&gt;flags, pe_flag_have_quorum);</a>
<a name="ln88">    }</a>
<a name="ln89"> </a>
<a name="ln90">    data_set-&gt;op_defaults = get_xpath_object(&quot;//&quot;XML_CIB_TAG_OPCONFIG, data_set-&gt;input, LOG_TRACE);</a>
<a name="ln91">    data_set-&gt;rsc_defaults = get_xpath_object(&quot;//&quot;XML_CIB_TAG_RSCCONFIG, data_set-&gt;input, LOG_TRACE);</a>
<a name="ln92"> </a>
<a name="ln93">    unpack_config(config, data_set);</a>
<a name="ln94"> </a>
<a name="ln95">   if (is_not_set(data_set-&gt;flags, pe_flag_quick_location)</a>
<a name="ln96">       &amp;&amp; is_not_set(data_set-&gt;flags, pe_flag_have_quorum)</a>
<a name="ln97">       &amp;&amp; data_set-&gt;no_quorum_policy != no_quorum_ignore) {</a>
<a name="ln98">        crm_warn(&quot;Fencing and resource management disabled due to lack of quorum&quot;);</a>
<a name="ln99">    }</a>
<a name="ln100"> </a>
<a name="ln101">    unpack_nodes(cib_nodes, data_set);</a>
<a name="ln102"> </a>
<a name="ln103">    if(is_not_set(data_set-&gt;flags, pe_flag_quick_location)) {</a>
<a name="ln104">        unpack_remote_nodes(cib_resources, data_set);</a>
<a name="ln105">    }</a>
<a name="ln106"> </a>
<a name="ln107">    unpack_resources(cib_resources, data_set);</a>
<a name="ln108">    unpack_tags(cib_tags, data_set);</a>
<a name="ln109"> </a>
<a name="ln110">    if(is_not_set(data_set-&gt;flags, pe_flag_quick_location)) {</a>
<a name="ln111">        unpack_status(cib_status, data_set);</a>
<a name="ln112">    }</a>
<a name="ln113"> </a>
<a name="ln114">    set_bit(data_set-&gt;flags, pe_flag_have_status);</a>
<a name="ln115">    return TRUE;</a>
<a name="ln116">}</a>
<a name="ln117"> </a>
<a name="ln118">static void</a>
<a name="ln119">pe_free_resources(GListPtr resources)</a>
<a name="ln120">{</a>
<a name="ln121">    resource_t *rsc = NULL;</a>
<a name="ln122">    GListPtr iterator = resources;</a>
<a name="ln123"> </a>
<a name="ln124">    while (iterator != NULL) {</a>
<a name="ln125">        rsc = (resource_t *) iterator-&gt;data;</a>
<a name="ln126">        iterator = iterator-&gt;next;</a>
<a name="ln127">        rsc-&gt;fns-&gt;free(rsc);</a>
<a name="ln128">    }</a>
<a name="ln129">    if (resources != NULL) {</a>
<a name="ln130">        g_list_free(resources);</a>
<a name="ln131">    }</a>
<a name="ln132">}</a>
<a name="ln133"> </a>
<a name="ln134">static void</a>
<a name="ln135">pe_free_actions(GListPtr actions)</a>
<a name="ln136">{</a>
<a name="ln137">    GListPtr iterator = actions;</a>
<a name="ln138"> </a>
<a name="ln139">    while (iterator != NULL) {</a>
<a name="ln140">        pe_free_action(iterator-&gt;data);</a>
<a name="ln141">        iterator = iterator-&gt;next;</a>
<a name="ln142">    }</a>
<a name="ln143">    if (actions != NULL) {</a>
<a name="ln144">        g_list_free(actions);</a>
<a name="ln145">    }</a>
<a name="ln146">}</a>
<a name="ln147"> </a>
<a name="ln148">static void</a>
<a name="ln149">pe_free_nodes(GListPtr nodes)</a>
<a name="ln150">{</a>
<a name="ln151">    GListPtr iterator = nodes;</a>
<a name="ln152"> </a>
<a name="ln153">    while (iterator != NULL) {</a>
<a name="ln154">        node_t *node = (node_t *) iterator-&gt;data;</a>
<a name="ln155">        struct node_shared_s *details = node-&gt;details;</a>
<a name="ln156"> </a>
<a name="ln157">        iterator = iterator-&gt;next;</a>
<a name="ln158"> </a>
<a name="ln159">        crm_trace(&quot;deleting node&quot;);</a>
<a name="ln160">        print_node(&quot;delete&quot;, node, FALSE);</a>
<a name="ln161"> </a>
<a name="ln162">        if (details != NULL) {</a>
<a name="ln163">            crm_trace(&quot;%s is being deleted&quot;, details-&gt;uname);</a>
<a name="ln164">            if (details-&gt;attrs != NULL) {</a>
<a name="ln165">                g_hash_table_destroy(details-&gt;attrs);</a>
<a name="ln166">            }</a>
<a name="ln167">            if (details-&gt;utilization != NULL) {</a>
<a name="ln168">                g_hash_table_destroy(details-&gt;utilization);</a>
<a name="ln169">            }</a>
<a name="ln170">            if (details-&gt;digest_cache != NULL) {</a>
<a name="ln171">                g_hash_table_destroy(details-&gt;digest_cache);</a>
<a name="ln172">            }</a>
<a name="ln173">            g_list_free(details-&gt;running_rsc);</a>
<a name="ln174">            g_list_free(details-&gt;allocated_rsc);</a>
<a name="ln175">            free(details);</a>
<a name="ln176">        }</a>
<a name="ln177">        free(node);</a>
<a name="ln178">    }</a>
<a name="ln179">    if (nodes != NULL) {</a>
<a name="ln180">        g_list_free(nodes);</a>
<a name="ln181">    }</a>
<a name="ln182">}</a>
<a name="ln183"> </a>
<a name="ln184">void</a>
<a name="ln185">cleanup_calculations(pe_working_set_t * data_set)</a>
<a name="ln186">{</a>
<a name="ln187">    pe_dataset = NULL;</a>
<a name="ln188">    if (data_set == NULL) {</a>
<a name="ln189">        return;</a>
<a name="ln190">    }</a>
<a name="ln191"> </a>
<a name="ln192">    clear_bit(data_set-&gt;flags, pe_flag_have_status);</a>
<a name="ln193">    if (data_set-&gt;config_hash != NULL) {</a>
<a name="ln194">        g_hash_table_destroy(data_set-&gt;config_hash);</a>
<a name="ln195">    }</a>
<a name="ln196"> </a>
<a name="ln197">    if (data_set-&gt;singletons != NULL) {</a>
<a name="ln198">        g_hash_table_destroy(data_set-&gt;singletons);</a>
<a name="ln199">    }</a>
<a name="ln200"> </a>
<a name="ln201">    if (data_set-&gt;tickets) {</a>
<a name="ln202">        g_hash_table_destroy(data_set-&gt;tickets);</a>
<a name="ln203">    }</a>
<a name="ln204"> </a>
<a name="ln205">    if (data_set-&gt;template_rsc_sets) {</a>
<a name="ln206">        g_hash_table_destroy(data_set-&gt;template_rsc_sets);</a>
<a name="ln207">    }</a>
<a name="ln208"> </a>
<a name="ln209">    if (data_set-&gt;tags) {</a>
<a name="ln210">        g_hash_table_destroy(data_set-&gt;tags);</a>
<a name="ln211">    }</a>
<a name="ln212"> </a>
<a name="ln213">    free(data_set-&gt;dc_uuid);</a>
<a name="ln214"> </a>
<a name="ln215">    crm_trace(&quot;deleting resources&quot;);</a>
<a name="ln216">    pe_free_resources(data_set-&gt;resources);</a>
<a name="ln217"> </a>
<a name="ln218">    crm_trace(&quot;deleting actions&quot;);</a>
<a name="ln219">    pe_free_actions(data_set-&gt;actions);</a>
<a name="ln220"> </a>
<a name="ln221">    crm_trace(&quot;deleting nodes&quot;);</a>
<a name="ln222">    pe_free_nodes(data_set-&gt;nodes);</a>
<a name="ln223"> </a>
<a name="ln224">    free_xml(data_set-&gt;graph);</a>
<a name="ln225">    crm_time_free(data_set-&gt;now);</a>
<a name="ln226">    free_xml(data_set-&gt;input);</a>
<a name="ln227">    free_xml(data_set-&gt;failed);</a>
<a name="ln228"> </a>
<a name="ln229">    set_working_set_defaults(data_set);</a>
<a name="ln230"> </a>
<a name="ln231">    CRM_CHECK(data_set-&gt;ordering_constraints == NULL,;</a>
<a name="ln232">        );</a>
<a name="ln233">    CRM_CHECK(data_set-&gt;placement_constraints == NULL,;</a>
<a name="ln234">        );</a>
<a name="ln235">}</a>
<a name="ln236"> </a>
<a name="ln237">void</a>
<a name="ln238">set_working_set_defaults(pe_working_set_t * data_set)</a>
<a name="ln239">{</a>
<a name="ln240">    pe_dataset = data_set;</a>
<a name="ln241">    memset(data_set, 0, sizeof(pe_working_set_t));</a>
<a name="ln242"> </a>
<a name="ln243">    data_set-&gt;dc_uuid = NULL;</a>
<a name="ln244">    data_set-&gt;order_id = 1;</a>
<a name="ln245">    data_set-&gt;action_id = 1;</a>
<a name="ln246">    data_set-&gt;no_quorum_policy = no_quorum_freeze;</a>
<a name="ln247"> </a>
<a name="ln248">    data_set-&gt;flags = 0x0ULL;</a>
<a name="ln249">    set_bit(data_set-&gt;flags, pe_flag_stop_rsc_orphans);</a>
<a name="ln250">    set_bit(data_set-&gt;flags, pe_flag_symmetric_cluster);</a>
<a name="ln251">    set_bit(data_set-&gt;flags, pe_flag_is_managed_default);</a>
<a name="ln252">    set_bit(data_set-&gt;flags, pe_flag_stop_action_orphans);</a>
<a name="ln253">}</a>
<a name="ln254"> </a>
<a name="ln255">resource_t *</a>
<a name="ln256">pe_find_resource(GListPtr rsc_list, const char *id)</a>
<a name="ln257">{</a>
<a name="ln258">    GListPtr rIter = NULL;</a>
<a name="ln259"> </a>
<a name="ln260">    for (rIter = rsc_list; id &amp;&amp; rIter; rIter = rIter-&gt;next) {</a>
<a name="ln261">        resource_t *parent = rIter-&gt;data;</a>
<a name="ln262"> </a>
<a name="ln263">        resource_t *match =</a>
<a name="ln264">            parent-&gt;fns-&gt;find_rsc(parent, id, NULL, pe_find_renamed | pe_find_current);</a>
<a name="ln265">        if (match != NULL) {</a>
<a name="ln266">            return match;</a>
<a name="ln267">        }</a>
<a name="ln268">    }</a>
<a name="ln269">    crm_trace(&quot;No match for %s&quot;, id);</a>
<a name="ln270">    return NULL;</a>
<a name="ln271">}</a>
<a name="ln272"> </a>
<a name="ln273">node_t *</a>
<a name="ln274">pe_find_node_any(GListPtr nodes, const char *id, const char *uname)</a>
<a name="ln275">{</a>
<a name="ln276">    node_t *match = pe_find_node_id(nodes, id);</a>
<a name="ln277"> </a>
<a name="ln278">    if (match) {</a>
<a name="ln279">        return match;</a>
<a name="ln280">    }</a>
<a name="ln281">    crm_trace(&quot;Looking up %s via its uname instead&quot;, uname);</a>
<a name="ln282">    return pe_find_node(nodes, uname);</a>
<a name="ln283">}</a>
<a name="ln284"> </a>
<a name="ln285">node_t *</a>
<a name="ln286">pe_find_node_id(GListPtr nodes, const char *id)</a>
<a name="ln287">{</a>
<a name="ln288">    GListPtr gIter = nodes;</a>
<a name="ln289"> </a>
<a name="ln290">    for (; gIter != NULL; gIter = gIter-&gt;next) {</a>
<a name="ln291">        node_t *node = (node_t *) gIter-&gt;data;</a>
<a name="ln292"> </a>
<a name="ln293">        if (node &amp;&amp; safe_str_eq(node-&gt;details-&gt;id, id)) {</a>
<a name="ln294">            return node;</a>
<a name="ln295">        }</a>
<a name="ln296">    }</a>
<a name="ln297">    /* error */</a>
<a name="ln298">    return NULL;</a>
<a name="ln299">}</a>
<a name="ln300"> </a>
<a name="ln301">node_t *</a>
<a name="ln302">pe_find_node(GListPtr nodes, const char *uname)</a>
<a name="ln303">{</a>
<a name="ln304">    GListPtr gIter = nodes;</a>
<a name="ln305"> </a>
<a name="ln306">    for (; gIter != NULL; gIter = gIter-&gt;next) {</a>
<a name="ln307">        node_t *node = (node_t *) gIter-&gt;data;</a>
<a name="ln308"> </a>
<a name="ln309">        if (node &amp;&amp; safe_str_eq(node-&gt;details-&gt;uname, uname)) {</a>
<a name="ln310">            return node;</a>
<a name="ln311">        }</a>
<a name="ln312">    }</a>
<a name="ln313">    /* error */</a>
<a name="ln314">    return NULL;</a>
<a name="ln315">}</a>

</code></pre>
<div class="balloon" rel="79"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V560/" target="_blank">V560</a> A part of conditional expression is always true: data_set->input != NULL.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
