
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class="cpp">
<a name="ln1"> </a>
<a name="ln2">// This is an open source non-commercial project. Dear PVS-Studio, please check it.</a>
<a name="ln3"> </a>
<a name="ln4">// PVS-Studio Static Code Analyzer for C, C++ and C#: http://www.viva64.com</a>
<a name="ln5">/*</a>
<a name="ln6"> * Copyright (C) 2004 Andrew Beekhof &lt;andrew@beekhof.net&gt;</a>
<a name="ln7"> *</a>
<a name="ln8"> * This library is free software; you can redistribute it and/or</a>
<a name="ln9"> * modify it under the terms of the GNU Lesser General Public</a>
<a name="ln10"> * License as published by the Free Software Foundation; either</a>
<a name="ln11"> * version 2.1 of the License, or (at your option) any later version.</a>
<a name="ln12"> *</a>
<a name="ln13"> * This library is distributed in the hope that it will be useful,</a>
<a name="ln14"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln15"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</a>
<a name="ln16"> * Lesser General Public License for more details.</a>
<a name="ln17"> *</a>
<a name="ln18"> * You should have received a copy of the GNU Lesser General Public</a>
<a name="ln19"> * License along with this library; if not, write to the Free Software</a>
<a name="ln20"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</a>
<a name="ln21"> */</a>
<a name="ln22"> </a>
<a name="ln23">#include &lt;crm_internal.h&gt;</a>
<a name="ln24"> </a>
<a name="ln25">#include &lt;sys/param.h&gt;</a>
<a name="ln26">#include &lt;stdio.h&gt;</a>
<a name="ln27">#include &lt;sys/types.h&gt;</a>
<a name="ln28">#include &lt;unistd.h&gt;</a>
<a name="ln29">#include &lt;time.h&gt;</a>
<a name="ln30">#include &lt;string.h&gt;</a>
<a name="ln31">#include &lt;stdlib.h&gt;</a>
<a name="ln32">#include &lt;ctype.h&gt;</a>
<a name="ln33"> </a>
<a name="ln34">#include &lt;crm/crm.h&gt;</a>
<a name="ln35">#include &lt;crm/msg_xml.h&gt;</a>
<a name="ln36">#include &lt;crm/common/xml.h&gt;</a>
<a name="ln37"> </a>
<a name="ln38">#if HAVE_BZLIB_H</a>
<a name="ln39">#  include &lt;bzlib.h&gt;</a>
<a name="ln40">#endif</a>
<a name="ln41"> </a>
<a name="ln42">#if HAVE_LIBXML2</a>
<a name="ln43">#  include &lt;libxml/parser.h&gt;</a>
<a name="ln44">#  include &lt;libxml/tree.h&gt;</a>
<a name="ln45">#endif</a>
<a name="ln46"> </a>
<a name="ln47">#define XML_BUFFER_SIZE	4096</a>
<a name="ln48">#define XML_PARSER_DEBUG 0</a>
<a name="ln49"> </a>
<a name="ln50">static inline int</a>
<a name="ln51">__get_prefix(const char *prefix, xmlNode *xml, char *buffer, int offset);</a>
<a name="ln52"> </a>
<a name="ln53">typedef struct {</a>
<a name="ln54">    int found;</a>
<a name="ln55">    const char *string;</a>
<a name="ln56">} filter_t;</a>
<a name="ln57"> </a>
<a name="ln58">enum xml_private_flags {</a>
<a name="ln59">     xpf_none        = 0x0000,</a>
<a name="ln60">     xpf_dirty       = 0x0001,</a>
<a name="ln61">     xpf_deleted     = 0x0002,</a>
<a name="ln62">     xpf_created     = 0x0004,</a>
<a name="ln63">     xpf_modified    = 0x0008,</a>
<a name="ln64"> </a>
<a name="ln65">     xpf_tracking    = 0x0010,</a>
<a name="ln66">     xpf_processed   = 0x0020,</a>
<a name="ln67">     xpf_skip        = 0x0040,</a>
<a name="ln68">     xpf_moved       = 0x0080,</a>
<a name="ln69"> </a>
<a name="ln70">     xpf_acl_enabled = 0x0100,</a>
<a name="ln71">     xpf_acl_read    = 0x0200,</a>
<a name="ln72">     xpf_acl_write   = 0x0400,</a>
<a name="ln73">     xpf_acl_deny    = 0x0800,</a>
<a name="ln74"> </a>
<a name="ln75">     xpf_acl_create  = 0x1000,</a>
<a name="ln76">     xpf_acl_denied  = 0x2000,</a>
<a name="ln77">};</a>
<a name="ln78"> </a>
<a name="ln79">typedef struct xml_private_s </a>
<a name="ln80">{</a>
<a name="ln81">        long check;</a>
<a name="ln82">        uint32_t flags;</a>
<a name="ln83">        char *user;</a>
<a name="ln84">        GListPtr acls;</a>
<a name="ln85">        GListPtr deleted_objs;</a>
<a name="ln86">} xml_private_t;</a>
<a name="ln87"> </a>
<a name="ln88">typedef struct xml_acl_s {</a>
<a name="ln89">        enum xml_private_flags mode;</a>
<a name="ln90">        char *xpath;</a>
<a name="ln91">} xml_acl_t;</a>
<a name="ln92"> </a>
<a name="ln93">typedef struct xml_deleted_obj_s {</a>
<a name="ln94">        char *path;</a>
<a name="ln95">        int position;</a>
<a name="ln96">} xml_deleted_obj_t;</a>
<a name="ln97"> </a>
<a name="ln98">/* *INDENT-OFF* */</a>
<a name="ln99"> </a>
<a name="ln100">static filter_t filter[] = {</a>
<a name="ln101">    { 0, XML_ATTR_ORIGIN },</a>
<a name="ln102">    { 0, XML_CIB_ATTR_WRITTEN },</a>
<a name="ln103">    { 0, XML_ATTR_UPDATE_ORIG },</a>
<a name="ln104">    { 0, XML_ATTR_UPDATE_CLIENT },</a>
<a name="ln105">    { 0, XML_ATTR_UPDATE_USER },</a>
<a name="ln106">};</a>
<a name="ln107">/* *INDENT-ON* */</a>
<a name="ln108"> </a>
<a name="ln109">static xmlNode *subtract_xml_comment(xmlNode * parent, xmlNode * left, xmlNode * right, gboolean * changed);</a>
<a name="ln110">static xmlNode *find_xml_comment(xmlNode * root, xmlNode * search_comment, gboolean exact);</a>
<a name="ln111">static int add_xml_comment(xmlNode * parent, xmlNode * target, xmlNode * update);</a>
<a name="ln112">static bool __xml_acl_check(xmlNode *xml, const char *name, enum xml_private_flags mode);</a>
<a name="ln113">const char *__xml_acl_to_text(enum xml_private_flags flags);</a>
<a name="ln114"> </a>
<a name="ln115">#define CHUNK_SIZE 1024</a>
<a name="ln116">static inline bool TRACKING_CHANGES(xmlNode *xml)</a>
<a name="ln117">{</a>
<a name="ln118">    if(xml == NULL || xml-&gt;doc == NULL || xml-&gt;doc-&gt;_private == NULL) {</a>
<a name="ln119">        return FALSE;</a>
<a name="ln120">    } else if(is_set(((xml_private_t *)xml-&gt;doc-&gt;_private)-&gt;flags, xpf_tracking)) {</a>
<a name="ln121">        return TRUE;</a>
<a name="ln122">    }</a>
<a name="ln123">    return FALSE;</a>
<a name="ln124">}</a>
<a name="ln125"> </a>
<a name="ln126">#define buffer_print(buffer, max, offset, fmt, args...) do {            \</a>
<a name="ln127">        int rc = (max);                                                 \</a>
<a name="ln128">        if(buffer) {                                                    \</a>
<a name="ln129">            rc = snprintf((buffer) + (offset), (max) - (offset), fmt, ##args); \</a>
<a name="ln130">        }                                                               \</a>
<a name="ln131">        if(buffer &amp;&amp; rc &lt; 0) {                                          \</a>
<a name="ln132">            crm_perror(LOG_ERR, &quot;snprintf failed at offset %d&quot;, offset); \</a>
<a name="ln133">            (buffer)[(offset)] = 0;                                     \</a>
<a name="ln134">        } else if(rc &gt;= ((max) - (offset))) {                           \</a>
<a name="ln135">            char *tmp = NULL;                                           \</a>
<a name="ln136">            (max) = QB_MAX(CHUNK_SIZE, (max) * 2);                      \</a>
<a name="ln137">            tmp = realloc_safe((buffer), (max) + 1);                         \</a>
<a name="ln138">            CRM_ASSERT(tmp);                                            \</a>
<a name="ln139">            (buffer) = tmp;                                             \</a>
<a name="ln140">        } else {                                                        \</a>
<a name="ln141">            offset += rc;                                               \</a>
<a name="ln142">            break;                                                      \</a>
<a name="ln143">        }                                                               \</a>
<a name="ln144">    } while(1);</a>
<a name="ln145"> </a>
<a name="ln146">static void</a>
<a name="ln147">insert_prefix(int options, char **buffer, int *offset, int *max, int depth)</a>
<a name="ln148">{</a>
<a name="ln149">    if (options &amp; xml_log_option_formatted) {</a>
<a name="ln150">        size_t spaces = 2 * depth;</a>
<a name="ln151"> </a>
<a name="ln152">        if ((*buffer) == NULL || spaces &gt;= ((*max) - (*offset))) {</a>
<a name="ln153">            (*max) = QB_MAX(CHUNK_SIZE, (*max) * 2);</a>
<a name="ln154">            (*buffer) = realloc_safe((*buffer), (*max) + 1);</a>
<a name="ln155">        }</a>
<a name="ln156">        memset((*buffer) + (*offset), ' ', spaces);</a>
<a name="ln157">        (*offset) += spaces;</a>
<a name="ln158">    }</a>
<a name="ln159">}</a>
<a name="ln160"> </a>
<a name="ln161">static void</a>
<a name="ln162">set_parent_flag(xmlNode *xml, long flag) </a>
<a name="ln163">{</a>
<a name="ln164"> </a>
<a name="ln165">    for(; xml; xml = xml-&gt;parent) {</a>
<a name="ln166">        xml_private_t *p = xml-&gt;_private;</a>
<a name="ln167"> </a>
<a name="ln168">        if(p == NULL) {</a>
<a name="ln169">            /* During calls to xmlDocCopyNode(), _private will be unset for parent nodes */</a>
<a name="ln170">        } else {</a>
<a name="ln171">            p-&gt;flags |= flag;</a>
<a name="ln172">            /* crm_trace(&quot;Setting flag %x due to %s[@id=%s]&quot;, flag, xml-&gt;name, ID(xml)); */</a>
<a name="ln173">        }</a>
<a name="ln174">    }</a>
<a name="ln175">}</a>
<a name="ln176"> </a>
<a name="ln177">static void</a>
<a name="ln178">set_doc_flag(xmlNode *xml, long flag) </a>
<a name="ln179">{</a>
<a name="ln180"> </a>
<a name="ln181">    if(xml &amp;&amp; xml-&gt;doc &amp;&amp; xml-&gt;doc-&gt;_private){</a>
<a name="ln182">        /* During calls to xmlDocCopyNode(), xml-&gt;doc may be unset */</a>
<a name="ln183">        xml_private_t *p = xml-&gt;doc-&gt;_private;</a>
<a name="ln184"> </a>
<a name="ln185">        p-&gt;flags |= flag;</a>
<a name="ln186">        /* crm_trace(&quot;Setting flag %x due to %s[@id=%s]&quot;, flag, xml-&gt;name, ID(xml)); */</a>
<a name="ln187">    }</a>
<a name="ln188">}</a>
<a name="ln189"> </a>
<a name="ln190">static void</a>
<a name="ln191">__xml_node_dirty(xmlNode *xml) </a>
<a name="ln192">{</a>
<a name="ln193">    set_doc_flag(xml, xpf_dirty);</a>
<a name="ln194">    set_parent_flag(xml, xpf_dirty);</a>
<a name="ln195">}</a>
<a name="ln196"> </a>
<a name="ln197">static void</a>
<a name="ln198">__xml_node_clean(xmlNode *xml) </a>
<a name="ln199">{</a>
<a name="ln200">    xmlNode *cIter = NULL;</a>
<a name="ln201">    xml_private_t *p = xml-&gt;_private;</a>
<a name="ln202"> </a>
<a name="ln203">    if(p) {</a>
<a name="ln204">        p-&gt;flags = 0;</a>
<a name="ln205">    }</a>
<a name="ln206"> </a>
<a name="ln207">    for (cIter = __xml_first_child(xml); cIter != NULL; cIter = __xml_next(cIter)) {</a>
<a name="ln208">        __xml_node_clean(cIter);</a>
<a name="ln209">    }</a>
<a name="ln210">}</a>
<a name="ln211"> </a>
<a name="ln212">static void</a>
<a name="ln213">crm_node_created(xmlNode *xml) </a>
<a name="ln214">{</a>
<a name="ln215">    xmlNode *cIter = NULL;</a>
<a name="ln216">    xml_private_t *p = xml-&gt;_private;</a>
<a name="ln217"> </a>
<a name="ln218">    if(p &amp;&amp; TRACKING_CHANGES(xml)) {</a>
<a name="ln219">        if(is_not_set(p-&gt;flags, xpf_created)) {</a>
<a name="ln220">            p-&gt;flags |= xpf_created;</a>
<a name="ln221">            __xml_node_dirty(xml);</a>
<a name="ln222">        }</a>
<a name="ln223"> </a>
<a name="ln224">        for (cIter = __xml_first_child(xml); cIter != NULL; cIter = __xml_next(cIter)) {</a>
<a name="ln225">           crm_node_created(cIter);</a>
<a name="ln226">        }</a>
<a name="ln227">    }</a>
<a name="ln228">}</a>
<a name="ln229"> </a>
<a name="ln230">static void</a>
<a name="ln231">crm_attr_dirty(xmlAttr *a) </a>
<a name="ln232">{</a>
<a name="ln233">    xmlNode *parent = a-&gt;parent;</a>
<a name="ln234">    xml_private_t *p = NULL;</a>
<a name="ln235"> </a>
<a name="ln236">    p = a-&gt;_private;</a>
<a name="ln237">    p-&gt;flags |= (xpf_dirty|xpf_modified);</a>
<a name="ln238">    p-&gt;flags = (p-&gt;flags &amp; ~xpf_deleted);</a>
<a name="ln239">    /* crm_trace(&quot;Setting flag %x due to %s[@id=%s, @%s=%s]&quot;, */</a>
<a name="ln240">    /*           xpf_dirty, parent?parent-&gt;name:NULL, ID(parent), a-&gt;name, a-&gt;children-&gt;content); */</a>
<a name="ln241"> </a>
<a name="ln242">    __xml_node_dirty(parent);</a>
<a name="ln243">}</a>
<a name="ln244"> </a>
<a name="ln245">int get_tag_name(const char *input, size_t offset, size_t max);</a>
<a name="ln246">int get_attr_name(const char *input, size_t offset, size_t max);</a>
<a name="ln247">int get_attr_value(const char *input, size_t offset, size_t max);</a>
<a name="ln248">gboolean can_prune_leaf(xmlNode * xml_node);</a>
<a name="ln249"> </a>
<a name="ln250">void diff_filter_context(int context, int upper_bound, int lower_bound,</a>
<a name="ln251">                         xmlNode * xml_node, xmlNode * parent);</a>
<a name="ln252">int in_upper_context(int depth, int context, xmlNode * xml_node);</a>
<a name="ln253">int add_xml_object(xmlNode * parent, xmlNode * target, xmlNode * update, gboolean as_diff);</a>
<a name="ln254"> </a>
<a name="ln255">static inline const char *</a>
<a name="ln256">crm_attr_value(xmlAttr * attr)</a>
<a name="ln257">{</a>
<a name="ln258">    if (attr == NULL || attr-&gt;children == NULL) {</a>
<a name="ln259">        return NULL;</a>
<a name="ln260">    }</a>
<a name="ln261">    return (const char *)attr-&gt;children-&gt;content;</a>
<a name="ln262">}</a>
<a name="ln263"> </a>
<a name="ln264">static inline xmlAttr *</a>
<a name="ln265">crm_first_attr(xmlNode * xml)</a>
<a name="ln266">{</a>
<a name="ln267">    if (xml == NULL) {</a>
<a name="ln268">        return NULL;</a>
<a name="ln269">    }</a>
<a name="ln270">    return xml-&gt;properties;</a>
<a name="ln271">}</a>
<a name="ln272"> </a>
<a name="ln273">#define XML_PRIVATE_MAGIC (long) 0x81726354</a>
<a name="ln274"> </a>
<a name="ln275">static void</a>
<a name="ln276">__xml_acl_free(void *data)</a>
<a name="ln277">{</a>
<a name="ln278">    if(data) {</a>
<a name="ln279">        xml_acl_t *acl = data;</a>
<a name="ln280"> </a>
<a name="ln281">        free(acl-&gt;xpath);</a>
<a name="ln282">        free(acl);</a>
<a name="ln283">    }</a>
<a name="ln284">}</a>
<a name="ln285"> </a>
<a name="ln286">static void</a>
<a name="ln287">__xml_deleted_obj_free(void *data)</a>
<a name="ln288">{</a>
<a name="ln289">    if(data) {</a>
<a name="ln290">        xml_deleted_obj_t *deleted_obj = data;</a>
<a name="ln291"> </a>
<a name="ln292">        free(deleted_obj-&gt;path);</a>
<a name="ln293">        free(deleted_obj);</a>
<a name="ln294">    }</a>
<a name="ln295">}</a>
<a name="ln296"> </a>
<a name="ln297">static void</a>
<a name="ln298">__xml_private_clean(xml_private_t *p)</a>
<a name="ln299">{</a>
<a name="ln300">    if(p) {</a>
<a name="ln301">        CRM_ASSERT(p-&gt;check == XML_PRIVATE_MAGIC);</a>
<a name="ln302"> </a>
<a name="ln303">        free(p-&gt;user);</a>
<a name="ln304">        p-&gt;user = NULL;</a>
<a name="ln305"> </a>
<a name="ln306">        if(p-&gt;acls) {</a>
<a name="ln307">            g_list_free_full(p-&gt;acls, __xml_acl_free);</a>
<a name="ln308">            p-&gt;acls = NULL;</a>
<a name="ln309">        }</a>
<a name="ln310"> </a>
<a name="ln311">        if(p-&gt;deleted_objs) {</a>
<a name="ln312">            g_list_free_full(p-&gt;deleted_objs, __xml_deleted_obj_free);</a>
<a name="ln313">            p-&gt;deleted_objs = NULL;</a>
<a name="ln314">        }</a>
<a name="ln315">    }</a>
<a name="ln316">}</a>
<a name="ln317"> </a>
<a name="ln318"> </a>
<a name="ln319">static void</a>
<a name="ln320">__xml_private_free(xml_private_t *p)</a>
<a name="ln321">{</a>
<a name="ln322">    __xml_private_clean(p);</a>
<a name="ln323">    free(p);</a>
<a name="ln324">}</a>
<a name="ln325"> </a>
<a name="ln326">static void</a>
<a name="ln327">pcmkDeregisterNode(xmlNodePtr node)</a>
<a name="ln328">{</a>
<a name="ln329">    __xml_private_free(node-&gt;_private);</a>
<a name="ln330">}</a>
<a name="ln331"> </a>
<a name="ln332">static void</a>
<a name="ln333">pcmkRegisterNode(xmlNodePtr node)</a>
<a name="ln334">{</a>
<a name="ln335">    xml_private_t *p = NULL;</a>
<a name="ln336"> </a>
<a name="ln337">    switch(node-&gt;type) {</a>
<a name="ln338">        case XML_ELEMENT_NODE:</a>
<a name="ln339">        case XML_DOCUMENT_NODE:</a>
<a name="ln340">        case XML_ATTRIBUTE_NODE:</a>
<a name="ln341">        case XML_COMMENT_NODE:</a>
<a name="ln342">            p = calloc(1, sizeof(xml_private_t));</a>
<a name="ln343">            p-&gt;check = XML_PRIVATE_MAGIC;</a>
<a name="ln344">            /* Flags will be reset if necessary when tracking is enabled */</a>
<a name="ln345">            p-&gt;flags |= (xpf_dirty|xpf_created);</a>
<a name="ln346">            node-&gt;_private = p;</a>
<a name="ln347">            break;</a>
<a name="ln348">        case XML_TEXT_NODE:</a>
<a name="ln349">        case XML_DTD_NODE:</a>
<a name="ln350">        case XML_CDATA_SECTION_NODE:</a>
<a name="ln351">            break;</a>
<a name="ln352">        default:</a>
<a name="ln353">            /* Ignore */</a>
<a name="ln354">            crm_trace(&quot;Ignoring %p %d&quot;, node, node-&gt;type);</a>
<a name="ln355">            CRM_LOG_ASSERT(node-&gt;type == XML_ELEMENT_NODE);</a>
<a name="ln356">            break;</a>
<a name="ln357">    }</a>
<a name="ln358"> </a>
<a name="ln359">    if(p &amp;&amp; TRACKING_CHANGES(node)) {</a>
<a name="ln360">        /* XML_ELEMENT_NODE doesn't get picked up here, node-&gt;doc is</a>
<a name="ln361">         * not hooked up at the point we are called</a>
<a name="ln362">         */</a>
<a name="ln363">        set_doc_flag(node, xpf_dirty);</a>
<a name="ln364">        __xml_node_dirty(node);</a>
<a name="ln365">    }</a>
<a name="ln366">}</a>
<a name="ln367"> </a>
<a name="ln368">static xml_acl_t *</a>
<a name="ln369">__xml_acl_create(xmlNode * xml, xmlNode *target, enum xml_private_flags mode)</a>
<a name="ln370">{</a>
<a name="ln371">    xml_acl_t *acl = NULL;</a>
<a name="ln372"> </a>
<a name="ln373">    xml_private_t *p = NULL;</a>
<a name="ln374">    const char *tag = crm_element_value(xml, XML_ACL_ATTR_TAG);</a>
<a name="ln375">    const char *ref = crm_element_value(xml, XML_ACL_ATTR_REF);</a>
<a name="ln376">    const char *xpath = crm_element_value(xml, XML_ACL_ATTR_XPATH);</a>
<a name="ln377"> </a>
<a name="ln378">    if(tag == NULL) {</a>
<a name="ln379">        /* Compatibility handling for pacemaker &lt; 1.1.12 */</a>
<a name="ln380">        tag = crm_element_value(xml, XML_ACL_ATTR_TAGv1);</a>
<a name="ln381">    }</a>
<a name="ln382">    if(ref == NULL) {</a>
<a name="ln383">        /* Compatibility handling for pacemaker &lt; 1.1.12 */</a>
<a name="ln384">        ref = crm_element_value(xml, XML_ACL_ATTR_REFv1);</a>
<a name="ln385">    }</a>
<a name="ln386"> </a>
<a name="ln387">    if(target == NULL || target-&gt;doc == NULL || target-&gt;doc-&gt;_private == NULL){</a>
<a name="ln388">        CRM_ASSERT(target);</a>
<a name="ln389">        CRM_ASSERT(target-&gt;doc);</a>
<a name="ln390">        CRM_ASSERT(target-&gt;doc-&gt;_private);</a>
<a name="ln391">        return NULL;</a>
<a name="ln392"> </a>
<a name="ln393">    } else if (tag == NULL &amp;&amp; ref == NULL &amp;&amp; xpath == NULL) {</a>
<a name="ln394">        crm_trace(&quot;No criteria %p&quot;, xml);</a>
<a name="ln395">        return NULL;</a>
<a name="ln396">    }</a>
<a name="ln397"> </a>
<a name="ln398">    p = target-&gt;doc-&gt;_private;</a>
<a name="ln399">    acl = calloc(1, sizeof(xml_acl_t));</a>
<a name="ln400">    if (acl) {</a>
<a name="ln401">        const char *attr = crm_element_value(xml, XML_ACL_ATTR_ATTRIBUTE);</a>
<a name="ln402"> </a>
<a name="ln403">        acl-&gt;mode = mode;</a>
<a name="ln404">        if(xpath) {</a>
<a name="ln405">            acl-&gt;xpath = strdup(xpath);</a>
<a name="ln406">            crm_trace(&quot;Using xpath: %s&quot;, acl-&gt;xpath);</a>
<a name="ln407"> </a>
<a name="ln408">        } else {</a>
<a name="ln409">            int offset = 0;</a>
<a name="ln410">            char buffer[XML_BUFFER_SIZE];</a>
<a name="ln411"> </a>
<a name="ln412">            if(tag) {</a>
<a name="ln413">                offset += snprintf(buffer + offset, XML_BUFFER_SIZE - offset, &quot;//%s&quot;, tag);</a>
<a name="ln414">            } else {</a>
<a name="ln415">                offset += snprintf(buffer + offset, XML_BUFFER_SIZE - offset, &quot;//*&quot;);</a>
<a name="ln416">            }</a>
<a name="ln417"> </a>
<a name="ln418">            if(ref || attr) {</a>
<a name="ln419">                offset += snprintf(buffer + offset, XML_BUFFER_SIZE - offset, &quot;[&quot;);</a>
<a name="ln420">            }</a>
<a name="ln421"> </a>
<a name="ln422">            if(ref) {</a>
<a name="ln423">                offset += snprintf(buffer + offset, XML_BUFFER_SIZE - offset, &quot;@id='%s'&quot;, ref);</a>
<a name="ln424">            }</a>
<a name="ln425"> </a>
<a name="ln426">            if(ref &amp;&amp; attr) {</a>
<a name="ln427">                offset += snprintf(buffer + offset, XML_BUFFER_SIZE - offset, &quot; and &quot;);</a>
<a name="ln428">            }</a>
<a name="ln429"> </a>
<a name="ln430">            if(attr) {</a>
<a name="ln431">                offset += snprintf(buffer + offset, XML_BUFFER_SIZE - offset, &quot;@%s&quot;, attr);</a>
<a name="ln432">            }</a>
<a name="ln433"> </a>
<a name="ln434">            if(ref || attr) {</a>
<a name="ln435">                offset += snprintf(buffer + offset, XML_BUFFER_SIZE - offset, &quot;]&quot;);</a>
<a name="ln436">            }</a>
<a name="ln437"> </a>
<a name="ln438">            CRM_LOG_ASSERT(offset &gt; 0);</a>
<a name="ln439">            acl-&gt;xpath = strdup(buffer);</a>
<a name="ln440">            crm_trace(&quot;Built xpath: %s&quot;, acl-&gt;xpath);</a>
<a name="ln441">        }</a>
<a name="ln442"> </a>
<a name="ln443">        p-&gt;acls = g_list_append(p-&gt;acls, acl);</a>
<a name="ln444">    }</a>
<a name="ln445">    return acl;</a>
<a name="ln446">}</a>
<a name="ln447"> </a>
<a name="ln448">static gboolean</a>
<a name="ln449">__xml_acl_parse_entry(xmlNode * acl_top, xmlNode * acl_entry, xmlNode *target)</a>
<a name="ln450">{</a>
<a name="ln451">    xmlNode *child = NULL;</a>
<a name="ln452"> </a>
<a name="ln453">    for (child = __xml_first_child(acl_entry); child; child = __xml_next(child)) {</a>
<a name="ln454">        const char *tag = crm_element_name(child);</a>
<a name="ln455">        const char *kind = crm_element_value(child, XML_ACL_ATTR_KIND);</a>
<a name="ln456"> </a>
<a name="ln457">        if (strcmp(XML_ACL_TAG_PERMISSION, tag) == 0){</a>
<a name="ln458">            tag = kind;</a>
<a name="ln459">        }</a>
<a name="ln460"> </a>
<a name="ln461">        crm_trace(&quot;Processing %s %p&quot;, tag, child);</a>
<a name="ln462">        if(tag == NULL) {</a>
<a name="ln463">            CRM_ASSERT(tag != NULL);</a>
<a name="ln464"> </a>
<a name="ln465">        } else if (strcmp(XML_ACL_TAG_ROLE_REF, tag) == 0</a>
<a name="ln466">                   || strcmp(XML_ACL_TAG_ROLE_REFv1, tag) == 0) {</a>
<a name="ln467">            const char *ref_role = crm_element_value(child, XML_ATTR_ID);</a>
<a name="ln468"> </a>
<a name="ln469">            if (ref_role) {</a>
<a name="ln470">                xmlNode *role = NULL;</a>
<a name="ln471"> </a>
<a name="ln472">                for (role = __xml_first_child(acl_top); role; role = __xml_next(role)) {</a>
<a name="ln473">                    if (strcmp(XML_ACL_TAG_ROLE, (const char *)role-&gt;name) == 0) {</a>
<a name="ln474">                        const char *role_id = crm_element_value(role, XML_ATTR_ID);</a>
<a name="ln475"> </a>
<a name="ln476">                        if (role_id &amp;&amp; strcmp(ref_role, role_id) == 0) {</a>
<a name="ln477">                            crm_debug(&quot;Unpacking referenced role: %s&quot;, role_id);</a>
<a name="ln478">                            __xml_acl_parse_entry(acl_top, role, target);</a>
<a name="ln479">                            break;</a>
<a name="ln480">                        }</a>
<a name="ln481">                    }</a>
<a name="ln482">                }</a>
<a name="ln483">            }</a>
<a name="ln484"> </a>
<a name="ln485">        } else if (strcmp(XML_ACL_TAG_READ, tag) == 0) {</a>
<a name="ln486">            __xml_acl_create(child, target, xpf_acl_read);</a>
<a name="ln487"> </a>
<a name="ln488">        } else if (strcmp(XML_ACL_TAG_WRITE, tag) == 0) {</a>
<a name="ln489">            __xml_acl_create(child, target, xpf_acl_write);</a>
<a name="ln490"> </a>
<a name="ln491">        } else if (strcmp(XML_ACL_TAG_DENY, tag) == 0) {</a>
<a name="ln492">            __xml_acl_create(child, target, xpf_acl_deny);</a>
<a name="ln493"> </a>
<a name="ln494">        } else {</a>
<a name="ln495">            crm_warn(&quot;Unknown ACL entry: %s/%s&quot;, tag, kind);</a>
<a name="ln496">        }</a>
<a name="ln497">    }</a>
<a name="ln498"> </a>
<a name="ln499">    return TRUE;</a>
<a name="ln500">}</a>
<a name="ln501"> </a>
<a name="ln502">/*</a>
<a name="ln503">    &lt;acls&gt;</a>
<a name="ln504">      &lt;acl_target id=&quot;l33t-haxor&quot;&gt;&lt;role id=&quot;auto-l33t-haxor&quot;/&gt;&lt;/acl_target&gt;</a>
<a name="ln505">      &lt;acl_role id=&quot;auto-l33t-haxor&quot;&gt;</a>
<a name="ln506">        &lt;acl_permission id=&quot;crook-nothing&quot; kind=&quot;deny&quot; xpath=&quot;/cib&quot;/&gt;</a>
<a name="ln507">      &lt;/acl_role&gt;</a>
<a name="ln508">      &lt;acl_target id=&quot;niceguy&quot;&gt;</a>
<a name="ln509">        &lt;role id=&quot;observer&quot;/&gt;</a>
<a name="ln510">      &lt;/acl_target&gt;</a>
<a name="ln511">      &lt;acl_role id=&quot;observer&quot;&gt;</a>
<a name="ln512">        &lt;acl_permission id=&quot;observer-read-1&quot; kind=&quot;read&quot; xpath=&quot;/cib&quot;/&gt;</a>
<a name="ln513">        &lt;acl_permission id=&quot;observer-write-1&quot; kind=&quot;write&quot; xpath=&quot;//nvpair[@name='stonith-enabled']&quot;/&gt;</a>
<a name="ln514">        &lt;acl_permission id=&quot;observer-write-2&quot; kind=&quot;write&quot; xpath=&quot;//nvpair[@name='target-role']&quot;/&gt;</a>
<a name="ln515">      &lt;/acl_role&gt;</a>
<a name="ln516">      &lt;acl_target id=&quot;badidea&quot;&gt;&lt;role id=&quot;auto-badidea&quot;/&gt;&lt;/acl_target&gt;</a>
<a name="ln517">      &lt;acl_role id=&quot;auto-badidea&quot;&gt;</a>
<a name="ln518">        &lt;acl_permission id=&quot;badidea-resources&quot; kind=&quot;read&quot; xpath=&quot;//meta_attributes&quot;/&gt;</a>
<a name="ln519">        &lt;acl_permission id=&quot;badidea-resources-2&quot; kind=&quot;deny&quot; reference=&quot;dummy-meta_attributes&quot;/&gt;</a>
<a name="ln520">      &lt;/acl_role&gt;</a>
<a name="ln521">    &lt;/acls&gt;</a>
<a name="ln522">*/</a>
<a name="ln523"> </a>
<a name="ln524">const char *</a>
<a name="ln525">__xml_acl_to_text(enum xml_private_flags flags)</a>
<a name="ln526">{</a>
<a name="ln527">    if(is_set(flags, xpf_acl_deny)) {</a>
<a name="ln528">        return &quot;deny&quot;;</a>
<a name="ln529">    }</a>
<a name="ln530">    if(is_set(flags, xpf_acl_write)) {</a>
<a name="ln531">        return &quot;read/write&quot;;</a>
<a name="ln532">    }</a>
<a name="ln533">    if(is_set(flags, xpf_acl_read)) {</a>
<a name="ln534">        return &quot;read&quot;;</a>
<a name="ln535">    }</a>
<a name="ln536"> </a>
<a name="ln537">    return &quot;none&quot;;</a>
<a name="ln538">}</a>
<a name="ln539"> </a>
<a name="ln540">static void</a>
<a name="ln541">__xml_acl_apply(xmlNode *xml) </a>
<a name="ln542">{</a>
<a name="ln543">    GListPtr aIter = NULL;</a>
<a name="ln544">    xml_private_t *p = NULL;</a>
<a name="ln545">    xmlXPathObjectPtr xpathObj = NULL;</a>
<a name="ln546"> </a>
<a name="ln547">    if(xml_acl_enabled(xml) == FALSE) {</a>
<a name="ln548">        p = xml-&gt;doc-&gt;_private;</a>
<a name="ln549">        crm_trace(&quot;Not applying ACLs for %s&quot;, p-&gt;user);</a>
<a name="ln550">        return;</a>
<a name="ln551">    }</a>
<a name="ln552"> </a>
<a name="ln553">    p = xml-&gt;doc-&gt;_private;</a>
<a name="ln554">    for(aIter = p-&gt;acls; aIter != NULL; aIter = aIter-&gt;next) {</a>
<a name="ln555">        int max = 0, lpc = 0;</a>
<a name="ln556">        xml_acl_t *acl = aIter-&gt;data;</a>
<a name="ln557"> </a>
<a name="ln558">        xpathObj = xpath_search(xml, acl-&gt;xpath);</a>
<a name="ln559">        max = numXpathResults(xpathObj);</a>
<a name="ln560"> </a>
<a name="ln561">        for(lpc = 0; lpc &lt; max; lpc++) {</a>
<a name="ln562">            xmlNode *match = getXpathResult(xpathObj, lpc);</a>
<a name="ln563">            char *path = xml_get_path(match);</a>
<a name="ln564"> </a>
<a name="ln565">            p = match-&gt;_private;</a>
<a name="ln566">            crm_trace(&quot;Applying %x to %s for %s&quot;, acl-&gt;mode, path, acl-&gt;xpath);</a>
<a name="ln567"> </a>
<a name="ln568">#ifdef SUSE_ACL_COMPAT</a>
<a name="ln569">            if(is_not_set(p-&gt;flags, acl-&gt;mode)) {</a>
<a name="ln570">                if(is_set(p-&gt;flags, xpf_acl_read)</a>
<a name="ln571">                   || is_set(p-&gt;flags, xpf_acl_write)</a>
<a name="ln572">                   || is_set(p-&gt;flags, xpf_acl_deny)) {</a>
<a name="ln573">                    crm_config_warn(&quot;Configuration element %s is matched by multiple ACL rules, only the first applies ('%s' wins over '%s')&quot;,</a>
<a name="ln574">                                    path, __xml_acl_to_text(p-&gt;flags), __xml_acl_to_text(acl-&gt;mode));</a>
<a name="ln575">                    free(path);</a>
<a name="ln576">                    continue;</a>
<a name="ln577">                }</a>
<a name="ln578">            }</a>
<a name="ln579">#endif</a>
<a name="ln580"> </a>
<a name="ln581">            p-&gt;flags |= acl-&gt;mode;</a>
<a name="ln582">            free(path);</a>
<a name="ln583">        }</a>
<a name="ln584">        crm_trace(&quot;Now enforcing ACL: %s (%d matches)&quot;, acl-&gt;xpath, max);</a>
<a name="ln585">        freeXpathObject(xpathObj);</a>
<a name="ln586">    }</a>
<a name="ln587"> </a>
<a name="ln588">    p = xml-&gt;_private;</a>
<a name="ln589">    if(is_not_set(p-&gt;flags, xpf_acl_read) &amp;&amp; is_not_set(p-&gt;flags, xpf_acl_write)) {</a>
<a name="ln590">        p-&gt;flags |= xpf_acl_deny;</a>
<a name="ln591">        p = xml-&gt;doc-&gt;_private;</a>
<a name="ln592">        crm_info(&quot;Enforcing default ACL for %s to %s&quot;, p-&gt;user, crm_element_name(xml));</a>
<a name="ln593">    }</a>
<a name="ln594"> </a>
<a name="ln595">}</a>
<a name="ln596"> </a>
<a name="ln597">static void</a>
<a name="ln598">__xml_acl_unpack(xmlNode *source, xmlNode *target, const char *user)</a>
<a name="ln599">{</a>
<a name="ln600">#if ENABLE_ACL</a>
<a name="ln601">    xml_private_t *p = NULL;</a>
<a name="ln602"> </a>
<a name="ln603">    if(target == NULL || target-&gt;doc == NULL || target-&gt;doc-&gt;_private == NULL) {</a>
<a name="ln604">        return;</a>
<a name="ln605">    }</a>
<a name="ln606"> </a>
<a name="ln607">    p = target-&gt;doc-&gt;_private;</a>
<a name="ln608">    if(pcmk_acl_required(user) == FALSE) {</a>
<a name="ln609">        crm_trace(&quot;no acls needed for '%s'&quot;, user);</a>
<a name="ln610"> </a>
<a name="ln611">    } else if(p-&gt;acls == NULL) {</a>
<a name="ln612">        xmlNode *acls = get_xpath_object(&quot;//&quot;XML_CIB_TAG_ACLS, source, LOG_TRACE);</a>
<a name="ln613"> </a>
<a name="ln614">        free(p-&gt;user);</a>
<a name="ln615">        p-&gt;user = strdup(user);</a>
<a name="ln616"> </a>
<a name="ln617">        if(acls) {</a>
<a name="ln618">            xmlNode *child = NULL;</a>
<a name="ln619"> </a>
<a name="ln620">            for (child = __xml_first_child(acls); child; child = __xml_next(child)) {</a>
<a name="ln621">                const char *tag = crm_element_name(child);</a>
<a name="ln622"> </a>
<a name="ln623">                if (strcmp(tag, XML_ACL_TAG_USER) == 0 || strcmp(tag, XML_ACL_TAG_USERv1) == 0) {</a>
<a name="ln624">                    const char *id = crm_element_value(child, XML_ATTR_ID);</a>
<a name="ln625"> </a>
<a name="ln626">                    if(id &amp;&amp; strcmp(id, user) == 0) {</a>
<a name="ln627">                        crm_debug(&quot;Unpacking ACLs for %s&quot;, id);</a>
<a name="ln628">                        __xml_acl_parse_entry(acls, child, target);</a>
<a name="ln629">                    }</a>
<a name="ln630">                }</a>
<a name="ln631">            }</a>
<a name="ln632">        }</a>
<a name="ln633">    }</a>
<a name="ln634">#endif</a>
<a name="ln635">}</a>
<a name="ln636"> </a>
<a name="ln637">static inline bool</a>
<a name="ln638">__xml_acl_mode_test(enum xml_private_flags allowed, enum xml_private_flags requested)</a>
<a name="ln639">{</a>
<a name="ln640">    if(is_set(allowed, xpf_acl_deny)) {</a>
<a name="ln641">        return FALSE;</a>
<a name="ln642"> </a>
<a name="ln643">    } else if(is_set(allowed, requested)) {</a>
<a name="ln644">        return TRUE;</a>
<a name="ln645"> </a>
<a name="ln646">    } else if(is_set(requested, xpf_acl_read) &amp;&amp; is_set(allowed, xpf_acl_write)) {</a>
<a name="ln647">        return TRUE;</a>
<a name="ln648"> </a>
<a name="ln649">    } else if(is_set(requested, xpf_acl_create) &amp;&amp; is_set(allowed, xpf_acl_write)) {</a>
<a name="ln650">        return TRUE;</a>
<a name="ln651"> </a>
<a name="ln652">    } else if(is_set(requested, xpf_acl_create) &amp;&amp; is_set(allowed, xpf_created)) {</a>
<a name="ln653">        return TRUE;</a>
<a name="ln654">    }</a>
<a name="ln655">    return FALSE;</a>
<a name="ln656">}</a>
<a name="ln657"> </a>
<a name="ln658">/* rc = TRUE if orig_cib has been filtered</a>
<a name="ln659"> * That means '*result' rather than 'xml' should be exploited afterwards</a>
<a name="ln660"> */</a>
<a name="ln661">static bool</a>
<a name="ln662">__xml_purge_attributes(xmlNode *xml)</a>
<a name="ln663">{</a>
<a name="ln664">    xmlNode *child = NULL;</a>
<a name="ln665">    xmlAttr *xIter = NULL;</a>
<a name="ln666">    bool readable_children = FALSE;</a>
<a name="ln667">    xml_private_t *p = xml-&gt;_private;</a>
<a name="ln668"> </a>
<a name="ln669">    if(__xml_acl_mode_test(p-&gt;flags, xpf_acl_read)) {</a>
<a name="ln670">        crm_trace(&quot;%s[@id=%s] is readable&quot;, crm_element_name(xml), ID(xml));</a>
<a name="ln671">        return TRUE;</a>
<a name="ln672">    }</a>
<a name="ln673"> </a>
<a name="ln674">    xIter = crm_first_attr(xml);</a>
<a name="ln675">    while(xIter != NULL) {</a>
<a name="ln676">        xmlAttr *tmp = xIter;</a>
<a name="ln677">        const char *prop_name = (const char *)xIter-&gt;name;</a>
<a name="ln678"> </a>
<a name="ln679">        xIter = xIter-&gt;next;</a>
<a name="ln680">        if (strcmp(prop_name, XML_ATTR_ID) == 0) {</a>
<a name="ln681">            continue;</a>
<a name="ln682">        }</a>
<a name="ln683"> </a>
<a name="ln684">        xmlUnsetProp(xml, tmp-&gt;name);</a>
<a name="ln685">    }</a>
<a name="ln686"> </a>
<a name="ln687">    child = __xml_first_child(xml);</a>
<a name="ln688">    while ( child != NULL ) {</a>
<a name="ln689">        xmlNode *tmp = child;</a>
<a name="ln690"> </a>
<a name="ln691">        child = __xml_next(child);</a>
<a name="ln692">        readable_children |= __xml_purge_attributes(tmp);</a>
<a name="ln693">    }</a>
<a name="ln694"> </a>
<a name="ln695">    if(readable_children == FALSE) {</a>
<a name="ln696">        free_xml(xml); /* Nothing readable under here, purge completely */</a>
<a name="ln697">    }</a>
<a name="ln698">    return readable_children;</a>
<a name="ln699">}</a>
<a name="ln700"> </a>
<a name="ln701">bool</a>
<a name="ln702">xml_acl_filtered_copy(const char *user, xmlNode* acl_source, xmlNode *xml, xmlNode ** result)</a>
<a name="ln703">{</a>
<a name="ln704">    GListPtr aIter = NULL;</a>
<a name="ln705">    xmlNode *target = NULL;</a>
<a name="ln706">    xml_private_t *p = NULL;</a>
<a name="ln707">    xml_private_t *doc = NULL;</a>
<a name="ln708"> </a>
<a name="ln709">    *result = NULL;</a>
<a name="ln710">    if(xml == NULL || pcmk_acl_required(user) == FALSE) {</a>
<a name="ln711">        crm_trace(&quot;no acls needed for '%s'&quot;, user);</a>
<a name="ln712">        return FALSE;</a>
<a name="ln713">    }</a>
<a name="ln714"> </a>
<a name="ln715">    crm_trace(&quot;filtering copy of %p for '%s'&quot;, xml, user);</a>
<a name="ln716">    target = copy_xml(xml);</a>
<a name="ln717">    if(target == NULL) {</a>
<a name="ln718">        return TRUE;</a>
<a name="ln719">    }</a>
<a name="ln720"> </a>
<a name="ln721">    __xml_acl_unpack(acl_source, target, user);</a>
<a name="ln722">    set_doc_flag(target, xpf_acl_enabled);</a>
<a name="ln723">    __xml_acl_apply(target);</a>
<a name="ln724"> </a>
<a name="ln725">    doc = target-&gt;doc-&gt;_private;</a>
<a name="ln726">    for(aIter = doc-&gt;acls; aIter != NULL &amp;&amp; target; aIter = aIter-&gt;next) {</a>
<a name="ln727">        int max = 0;</a>
<a name="ln728">        xml_acl_t *acl = aIter-&gt;data;</a>
<a name="ln729"> </a>
<a name="ln730">        if(acl-&gt;mode != xpf_acl_deny) {</a>
<a name="ln731">            /* Nothing to do */</a>
<a name="ln732"> </a>
<a name="ln733">        } else if(acl-&gt;xpath) {</a>
<a name="ln734">            int lpc = 0;</a>
<a name="ln735">            xmlXPathObjectPtr xpathObj = xpath_search(target, acl-&gt;xpath);</a>
<a name="ln736"> </a>
<a name="ln737">            max = numXpathResults(xpathObj);</a>
<a name="ln738">            for(lpc = 0; lpc &lt; max; lpc++) {</a>
<a name="ln739">                xmlNode *match = getXpathResult(xpathObj, lpc);</a>
<a name="ln740"> </a>
<a name="ln741">                crm_trace(&quot;Purging attributes from %s&quot;, acl-&gt;xpath);</a>
<a name="ln742">                if(__xml_purge_attributes(match) == FALSE &amp;&amp; match == target) {</a>
<a name="ln743">                    crm_trace(&quot;No access to the entire document for %s&quot;, user);</a>
<a name="ln744">                    freeXpathObject(xpathObj);</a>
<a name="ln745">                    return TRUE;</a>
<a name="ln746">                }</a>
<a name="ln747">            }</a>
<a name="ln748">            crm_trace(&quot;Enforced ACL %s (%d matches)&quot;, acl-&gt;xpath, max);</a>
<a name="ln749">            freeXpathObject(xpathObj);</a>
<a name="ln750">        }</a>
<a name="ln751">    }</a>
<a name="ln752"> </a>
<a name="ln753">    p = target-&gt;_private;</a>
<a name="ln754">    if(is_set(p-&gt;flags, xpf_acl_deny) &amp;&amp; __xml_purge_attributes(target) == FALSE) {</a>
<a name="ln755">        crm_trace(&quot;No access to the entire document for %s&quot;, user);</a>
<a name="ln756">        return TRUE;</a>
<a name="ln757">    }</a>
<a name="ln758"> </a>
<a name="ln759">    if(doc-&gt;acls) {</a>
<a name="ln760">        g_list_free_full(doc-&gt;acls, __xml_acl_free);</a>
<a name="ln761">        doc-&gt;acls = NULL;</a>
<a name="ln762"> </a>
<a name="ln763">    } else {</a>
<a name="ln764">        crm_trace(&quot;Ordinary user '%s' cannot access the CIB without any defined ACLs&quot;, doc-&gt;user);</a>
<a name="ln765">        free_xml(target);</a>
<a name="ln766">        target = NULL;</a>
<a name="ln767">    }</a>
<a name="ln768"> </a>
<a name="ln769">    if(target) {</a>
<a name="ln770">        *result = target;</a>
<a name="ln771">    }</a>
<a name="ln772"> </a>
<a name="ln773">    return TRUE;</a>
<a name="ln774">}</a>
<a name="ln775"> </a>
<a name="ln776">static void</a>
<a name="ln777">__xml_acl_post_process(xmlNode * xml)</a>
<a name="ln778">{</a>
<a name="ln779">    xmlNode *cIter = __xml_first_child(xml);</a>
<a name="ln780">    xml_private_t *p = xml-&gt;_private;</a>
<a name="ln781"> </a>
<a name="ln782">    if(is_set(p-&gt;flags, xpf_created)) {</a>
<a name="ln783">        xmlAttr *xIter = NULL;</a>
<a name="ln784">        char *path = xml_get_path(xml);</a>
<a name="ln785"> </a>
<a name="ln786">        /* Always allow new scaffolding, ie. node with no attributes or only an 'id'</a>
<a name="ln787">         * Except in the ACLs section</a>
<a name="ln788">         */</a>
<a name="ln789"> </a>
<a name="ln790">        for (xIter = crm_first_attr(xml); xIter != NULL; xIter = xIter-&gt;next) {</a>
<a name="ln791">            const char *prop_name = (const char *)xIter-&gt;name;</a>
<a name="ln792"> </a>
<a name="ln793">            if (strcmp(prop_name, XML_ATTR_ID) == 0 &amp;&amp; strstr(path, &quot;/&quot;XML_CIB_TAG_ACLS&quot;/&quot;) == NULL) {</a>
<a name="ln794">                /* Delay the acl check */</a>
<a name="ln795">                continue;</a>
<a name="ln796"> </a>
<a name="ln797">            } else if(__xml_acl_check(xml, NULL, xpf_acl_write)) {</a>
<a name="ln798">                crm_trace(&quot;Creation of %s=%s is allowed&quot;, crm_element_name(xml), ID(xml));</a>
<a name="ln799">                break;</a>
<a name="ln800"> </a>
<a name="ln801">            } else {</a>
<a name="ln802">                crm_trace(&quot;Cannot add new node %s at %s&quot;, crm_element_name(xml), path);</a>
<a name="ln803"> </a>
<a name="ln804">                if(xml != xmlDocGetRootElement(xml-&gt;doc)) {</a>
<a name="ln805">                    xmlUnlinkNode(xml);</a>
<a name="ln806">                    xmlFreeNode(xml);</a>
<a name="ln807">                }</a>
<a name="ln808">                free(path);</a>
<a name="ln809">                return;</a>
<a name="ln810">            }</a>
<a name="ln811">        }</a>
<a name="ln812">        free(path);</a>
<a name="ln813">    }</a>
<a name="ln814"> </a>
<a name="ln815">    while (cIter != NULL) {</a>
<a name="ln816">        xmlNode *child = cIter;</a>
<a name="ln817">        cIter = __xml_next(cIter); /* In case it is free'd */</a>
<a name="ln818">        __xml_acl_post_process(child);</a>
<a name="ln819">    }</a>
<a name="ln820">}</a>
<a name="ln821"> </a>
<a name="ln822">bool</a>
<a name="ln823">xml_acl_denied(xmlNode *xml) </a>
<a name="ln824">{</a>
<a name="ln825">    if(xml &amp;&amp; xml-&gt;doc &amp;&amp; xml-&gt;doc-&gt;_private){</a>
<a name="ln826">        xml_private_t *p = xml-&gt;doc-&gt;_private;</a>
<a name="ln827"> </a>
<a name="ln828">        return is_set(p-&gt;flags, xpf_acl_denied);</a>
<a name="ln829">    }</a>
<a name="ln830">    return FALSE;</a>
<a name="ln831">}</a>
<a name="ln832"> </a>
<a name="ln833">void</a>
<a name="ln834">xml_acl_disable(xmlNode *xml)</a>
<a name="ln835">{</a>
<a name="ln836">    if(xml_acl_enabled(xml)) {</a>
<a name="ln837">        xml_private_t *p = xml-&gt;doc-&gt;_private;</a>
<a name="ln838"> </a>
<a name="ln839">        /* Catch anything that was created but shouldn't have been */</a>
<a name="ln840">        __xml_acl_apply(xml);</a>
<a name="ln841">        __xml_acl_post_process(xml);</a>
<a name="ln842">        clear_bit(p-&gt;flags, xpf_acl_enabled);</a>
<a name="ln843">    }</a>
<a name="ln844">}</a>
<a name="ln845"> </a>
<a name="ln846">bool</a>
<a name="ln847">xml_acl_enabled(xmlNode *xml)</a>
<a name="ln848">{</a>
<a name="ln849">    if(xml &amp;&amp; xml-&gt;doc &amp;&amp; xml-&gt;doc-&gt;_private){</a>
<a name="ln850">        xml_private_t *p = xml-&gt;doc-&gt;_private;</a>
<a name="ln851"> </a>
<a name="ln852">        return is_set(p-&gt;flags, xpf_acl_enabled);</a>
<a name="ln853">    }</a>
<a name="ln854">    return FALSE;</a>
<a name="ln855">}</a>
<a name="ln856"> </a>
<a name="ln857">void</a>
<a name="ln858">xml_track_changes(xmlNode * xml, const char *user, xmlNode *acl_source, bool enforce_acls) </a>
<a name="ln859">{</a>
<a name="ln860">    xml_accept_changes(xml);</a>
<a name="ln861">    crm_trace(&quot;Tracking changes%s to %p&quot;, enforce_acls?&quot; with ACLs&quot;:&quot;&quot;, xml);</a>
<a name="ln862">    set_doc_flag(xml, xpf_tracking);</a>
<a name="ln863">    if(enforce_acls) {</a>
<a name="ln864">        if(acl_source == NULL) {</a>
<a name="ln865">            acl_source = xml;</a>
<a name="ln866">        }</a>
<a name="ln867">        set_doc_flag(xml, xpf_acl_enabled);</a>
<a name="ln868">        __xml_acl_unpack(acl_source, xml, user);</a>
<a name="ln869">        __xml_acl_apply(xml);</a>
<a name="ln870">    }</a>
<a name="ln871">}</a>
<a name="ln872"> </a>
<a name="ln873">bool xml_tracking_changes(xmlNode * xml)</a>
<a name="ln874">{</a>
<a name="ln875">    if(xml == NULL) {</a>
<a name="ln876">        return FALSE;</a>
<a name="ln877"> </a>
<a name="ln878">    } else if(is_set(((xml_private_t *)xml-&gt;doc-&gt;_private)-&gt;flags, xpf_tracking)) {</a>
<a name="ln879">        return TRUE;</a>
<a name="ln880">    }</a>
<a name="ln881">    return FALSE;</a>
<a name="ln882">}</a>
<a name="ln883"> </a>
<a name="ln884">bool xml_document_dirty(xmlNode *xml) </a>
<a name="ln885">{</a>
<a name="ln886">    if(xml != NULL &amp;&amp; xml-&gt;doc &amp;&amp; xml-&gt;doc-&gt;_private) {</a>
<a name="ln887">        xml_private_t *doc = xml-&gt;doc-&gt;_private;</a>
<a name="ln888"> </a>
<a name="ln889">        return is_set(doc-&gt;flags, xpf_dirty);</a>
<a name="ln890">    }</a>
<a name="ln891">    return FALSE;</a>
<a name="ln892">}</a>
<a name="ln893"> </a>
<a name="ln894">/*</a>
<a name="ln895">&lt;diff format=&quot;2.0&quot;&gt;</a>
<a name="ln896">  &lt;version&gt;</a>
<a name="ln897">    &lt;source admin_epoch=&quot;1&quot; epoch=&quot;2&quot; num_updates=&quot;3&quot;/&gt;</a>
<a name="ln898">    &lt;target admin_epoch=&quot;1&quot; epoch=&quot;3&quot; num_updates=&quot;0&quot;/&gt;</a>
<a name="ln899">  &lt;/version&gt;</a>
<a name="ln900">  &lt;change operation=&quot;add&quot; xpath=&quot;/cib/configuration/nodes&quot;&gt;</a>
<a name="ln901">    &lt;node id=&quot;node2&quot; uname=&quot;node2&quot; description=&quot;foo&quot;/&gt;</a>
<a name="ln902">  &lt;/change&gt;</a>
<a name="ln903">  &lt;change operation=&quot;add&quot; xpath=&quot;/cib/configuration/nodes/node[node2]&quot;&gt;</a>
<a name="ln904">    &lt;instance_attributes id=&quot;nodes-node&quot;&gt;&lt;!-- NOTE: can be a full tree --&gt;</a>
<a name="ln905">      &lt;nvpair id=&quot;nodes-node2-ram&quot; name=&quot;ram&quot; value=&quot;1024M&quot;/&gt;</a>
<a name="ln906">    &lt;/instance_attributes&gt;</a>
<a name="ln907">  &lt;/change&gt;</a>
<a name="ln908">  &lt;change operation=&quot;update&quot; xpath=&quot;/cib/configuration/nodes[@id='node2']&quot;&gt;</a>
<a name="ln909">    &lt;change-list&gt;</a>
<a name="ln910">      &lt;change-attr operation=&quot;set&quot; name=&quot;type&quot; value=&quot;member&quot;/&gt;</a>
<a name="ln911">      &lt;change-attr operation=&quot;unset&quot; name=&quot;description&quot;/&gt;</a>
<a name="ln912">    &lt;/change-list&gt;</a>
<a name="ln913">    &lt;change-result&gt;</a>
<a name="ln914">      &lt;node id=&quot;node2&quot; uname=&quot;node2&quot; type=&quot;member&quot;/&gt;&lt;!-- NOTE: not recursive --&gt;</a>
<a name="ln915">    &lt;/change-result&gt;</a>
<a name="ln916">  &lt;/change&gt;</a>
<a name="ln917">  &lt;change operation=&quot;delete&quot; xpath=&quot;/cib/configuration/nodes/node[@id='node3'] /&quot;&gt;</a>
<a name="ln918">  &lt;change operation=&quot;update&quot; xpath=&quot;/cib/configuration/resources/group[@id='g1']&quot;&gt;</a>
<a name="ln919">    &lt;change-list&gt;</a>
<a name="ln920">      &lt;change-attr operation=&quot;set&quot; name=&quot;description&quot; value=&quot;some grabage here&quot;/&gt;</a>
<a name="ln921">    &lt;/change-list&gt;</a>
<a name="ln922">    &lt;change-result&gt;</a>
<a name="ln923">      &lt;group id=&quot;g1&quot; description=&quot;some grabage here&quot;/&gt;&lt;!-- NOTE: not recursive --&gt;</a>
<a name="ln924">    &lt;/change-result&gt;</a>
<a name="ln925">  &lt;/change&gt;</a>
<a name="ln926">  &lt;change operation=&quot;update&quot; xpath=&quot;/cib/status/node_state[@id='node2]/lrm[@id='node2']/lrm_resources/lrm_resource[@id='Fence']&quot;&gt;</a>
<a name="ln927">    &lt;change-list&gt;</a>
<a name="ln928">      &lt;change-attr operation=&quot;set&quot; name=&quot;oper&quot; value=&quot;member&quot;/&gt;</a>
<a name="ln929">      &lt;change-attr operation=&quot;set&quot; name=&quot;operation_key&quot; value=&quot;Fence_start_0&quot;/&gt;</a>
<a name="ln930">      &lt;change-attr operation=&quot;set&quot; name=&quot;operation&quot; value=&quot;start&quot;/&gt;</a>
<a name="ln931">      &lt;change-attr operation=&quot;set&quot; name=&quot;transition-key&quot; value=&quot;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;/&gt;</a>
<a name="ln932">      &lt;change-attr operation=&quot;set&quot; name=&quot;transition-magic&quot; value=&quot;0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;/&gt;</a>
<a name="ln933">      &lt;change-attr operation=&quot;set&quot; name=&quot;call-id&quot; value=&quot;2&quot;/&gt;</a>
<a name="ln934">      &lt;change-attr operation=&quot;set&quot; name=&quot;rc-code&quot; value=&quot;0&quot;/&gt;</a>
<a name="ln935">    &lt;/change-list&gt;</a>
<a name="ln936">    &lt;change-result&gt;</a>
<a name="ln937">      &lt;lrm_rsc_op id=&quot;Fence_last_0&quot; operation_key=&quot;Fence_start_0&quot; operation=&quot;start&quot; crm-debug-origin=&quot;crm_simulate&quot;  transition-key=&quot;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot; transition-magic=&quot;0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot; call-id=&quot;2&quot; rc-code=&quot;0&quot; op-status=&quot;0&quot; interval=&quot;0&quot; exec-time=&quot;0&quot; queue-time=&quot;0&quot; op-digest=&quot;f2317cad3d54cec5d7d7aa7d0bf35cf8&quot;/&gt;</a>
<a name="ln938">    &lt;/change-result&gt;</a>
<a name="ln939">  &lt;/change&gt;</a>
<a name="ln940">&lt;/diff&gt;</a>
<a name="ln941"> */</a>
<a name="ln942">static int __xml_offset(xmlNode *xml) </a>
<a name="ln943">{</a>
<a name="ln944">    int position = 0;</a>
<a name="ln945">    xmlNode *cIter = NULL;</a>
<a name="ln946"> </a>
<a name="ln947">    for(cIter = xml; cIter-&gt;prev; cIter = cIter-&gt;prev) {</a>
<a name="ln948">        xml_private_t *p = ((xmlNode*)cIter-&gt;prev)-&gt;_private;</a>
<a name="ln949"> </a>
<a name="ln950">        if(is_not_set(p-&gt;flags, xpf_skip)) {</a>
<a name="ln951">            position++;</a>
<a name="ln952">        }</a>
<a name="ln953">    }</a>
<a name="ln954"> </a>
<a name="ln955">    return position;</a>
<a name="ln956">}</a>
<a name="ln957"> </a>
<a name="ln958">static int __xml_offset_no_deletions(xmlNode *xml) </a>
<a name="ln959">{</a>
<a name="ln960">    int position = 0;</a>
<a name="ln961">    xmlNode *cIter = NULL;</a>
<a name="ln962"> </a>
<a name="ln963">    for(cIter = xml; cIter-&gt;prev; cIter = cIter-&gt;prev) {</a>
<a name="ln964">        xml_private_t *p = ((xmlNode*)cIter-&gt;prev)-&gt;_private;</a>
<a name="ln965"> </a>
<a name="ln966">        if(is_not_set(p-&gt;flags, xpf_deleted)) {</a>
<a name="ln967">            position++;</a>
<a name="ln968">        }</a>
<a name="ln969">    }</a>
<a name="ln970"> </a>
<a name="ln971">    return position;</a>
<a name="ln972">}</a>
<a name="ln973"> </a>
<a name="ln974">static void</a>
<a name="ln975">__xml_build_changes(xmlNode * xml, xmlNode *patchset)</a>
<a name="ln976">{</a>
<a name="ln977">    xmlNode *cIter = NULL;</a>
<a name="ln978">    xmlAttr *pIter = NULL;</a>
<a name="ln979">    xmlNode *change = NULL;</a>
<a name="ln980">    xml_private_t *p = xml-&gt;_private;</a>
<a name="ln981"> </a>
<a name="ln982">    if(patchset &amp;&amp; is_set(p-&gt;flags, xpf_created)) {</a>
<a name="ln983">        int offset = 0;</a>
<a name="ln984">        char buffer[XML_BUFFER_SIZE];</a>
<a name="ln985"> </a>
<a name="ln986">        if(__get_prefix(NULL, xml-&gt;parent, buffer, offset) &gt; 0) {</a>
<a name="ln987">            int position = __xml_offset_no_deletions(xml);</a>
<a name="ln988"> </a>
<a name="ln989">            change = create_xml_node(patchset, XML_DIFF_CHANGE);</a>
<a name="ln990"> </a>
<a name="ln991">            crm_xml_add(change, XML_DIFF_OP, &quot;create&quot;);</a>
<a name="ln992">            crm_xml_add(change, XML_DIFF_PATH, buffer);</a>
<a name="ln993">            crm_xml_add_int(change, XML_DIFF_POSITION, position);</a>
<a name="ln994">            add_node_copy(change, xml);</a>
<a name="ln995">        }</a>
<a name="ln996"> </a>
<a name="ln997">        return;</a>
<a name="ln998">    }</a>
<a name="ln999"> </a>
<a name="ln1000">    for (pIter = crm_first_attr(xml); pIter != NULL; pIter = pIter-&gt;next) {</a>
<a name="ln1001">        xmlNode *attr = NULL;</a>
<a name="ln1002"> </a>
<a name="ln1003">        p = pIter-&gt;_private;</a>
<a name="ln1004">        if(is_not_set(p-&gt;flags, xpf_deleted) &amp;&amp; is_not_set(p-&gt;flags, xpf_dirty)) {</a>
<a name="ln1005">            continue;</a>
<a name="ln1006">        }</a>
<a name="ln1007"> </a>
<a name="ln1008">        if(change == NULL) {</a>
<a name="ln1009">            int offset = 0;</a>
<a name="ln1010">            char buffer[XML_BUFFER_SIZE];</a>
<a name="ln1011"> </a>
<a name="ln1012">            if(__get_prefix(NULL, xml, buffer, offset) &gt; 0) {</a>
<a name="ln1013">                change = create_xml_node(patchset, XML_DIFF_CHANGE);</a>
<a name="ln1014"> </a>
<a name="ln1015">                crm_xml_add(change, XML_DIFF_OP, &quot;modify&quot;);</a>
<a name="ln1016">                crm_xml_add(change, XML_DIFF_PATH, buffer);</a>
<a name="ln1017"> </a>
<a name="ln1018">                change = create_xml_node(change, XML_DIFF_LIST);</a>
<a name="ln1019">            }</a>
<a name="ln1020">        }</a>
<a name="ln1021"> </a>
<a name="ln1022">        attr = create_xml_node(change, XML_DIFF_ATTR);</a>
<a name="ln1023"> </a>
<a name="ln1024">        crm_xml_add(attr, XML_NVPAIR_ATTR_NAME, (const char *)pIter-&gt;name);</a>
<a name="ln1025">        if(p-&gt;flags &amp; xpf_deleted) {</a>
<a name="ln1026">            crm_xml_add(attr, XML_DIFF_OP, &quot;unset&quot;);</a>
<a name="ln1027"> </a>
<a name="ln1028">        } else {</a>
<a name="ln1029">            const char *value = crm_element_value(xml, (const char *)pIter-&gt;name);</a>
<a name="ln1030"> </a>
<a name="ln1031">            crm_xml_add(attr, XML_DIFF_OP, &quot;set&quot;);</a>
<a name="ln1032">            crm_xml_add(attr, XML_NVPAIR_ATTR_VALUE, value);</a>
<a name="ln1033">        }</a>
<a name="ln1034">    }</a>
<a name="ln1035"> </a>
<a name="ln1036">    if(change) {</a>
<a name="ln1037">        xmlNode *result = NULL;</a>
<a name="ln1038"> </a>
<a name="ln1039">        change = create_xml_node(change-&gt;parent, XML_DIFF_RESULT);</a>
<a name="ln1040">        result = create_xml_node(change, (const char *)xml-&gt;name);</a>
<a name="ln1041"> </a>
<a name="ln1042">        for (pIter = crm_first_attr(xml); pIter != NULL; pIter = pIter-&gt;next) {</a>
<a name="ln1043">            const char *value = crm_element_value(xml, (const char *)pIter-&gt;name);</a>
<a name="ln1044"> </a>
<a name="ln1045">            p = pIter-&gt;_private;</a>
<a name="ln1046">            if (is_not_set(p-&gt;flags, xpf_deleted)) {</a>
<a name="ln1047">                crm_xml_add(result, (const char *)pIter-&gt;name, value);</a>
<a name="ln1048">            }</a>
<a name="ln1049">        }</a>
<a name="ln1050">    }</a>
<a name="ln1051"> </a>
<a name="ln1052">    for (cIter = __xml_first_child(xml); cIter != NULL; cIter = __xml_next(cIter)) {</a>
<a name="ln1053">        __xml_build_changes(cIter, patchset);</a>
<a name="ln1054">    }</a>
<a name="ln1055"> </a>
<a name="ln1056">    p = xml-&gt;_private;</a>
<a name="ln1057">    if(patchset &amp;&amp; is_set(p-&gt;flags, xpf_moved)) {</a>
<a name="ln1058">        int offset = 0;</a>
<a name="ln1059">        char buffer[XML_BUFFER_SIZE];</a>
<a name="ln1060"> </a>
<a name="ln1061">        crm_trace(&quot;%s.%s moved to position %d&quot;, xml-&gt;name, ID(xml), __xml_offset(xml));</a>
<a name="ln1062">        if(__get_prefix(NULL, xml, buffer, offset) &gt; 0) {</a>
<a name="ln1063">            change = create_xml_node(patchset, XML_DIFF_CHANGE);</a>
<a name="ln1064"> </a>
<a name="ln1065">            crm_xml_add(change, XML_DIFF_OP, &quot;move&quot;);</a>
<a name="ln1066">            crm_xml_add(change, XML_DIFF_PATH, buffer);</a>
<a name="ln1067">            crm_xml_add_int(change, XML_DIFF_POSITION, __xml_offset_no_deletions(xml));</a>
<a name="ln1068">        }</a>
<a name="ln1069">    }</a>
<a name="ln1070">}</a>
<a name="ln1071"> </a>
<a name="ln1072">static void</a>
<a name="ln1073">__xml_accept_changes(xmlNode * xml)</a>
<a name="ln1074">{</a>
<a name="ln1075">    xmlNode *cIter = NULL;</a>
<a name="ln1076">    xmlAttr *pIter = NULL;</a>
<a name="ln1077">    xml_private_t *p = xml-&gt;_private;</a>
<a name="ln1078"> </a>
<a name="ln1079">    p-&gt;flags = xpf_none;</a>
<a name="ln1080">    pIter = crm_first_attr(xml);</a>
<a name="ln1081"> </a>
<a name="ln1082">    while (pIter != NULL) {</a>
<a name="ln1083">        const xmlChar *name = pIter-&gt;name;</a>
<a name="ln1084"> </a>
<a name="ln1085">        p = pIter-&gt;_private;</a>
<a name="ln1086">        pIter = pIter-&gt;next;</a>
<a name="ln1087"> </a>
<a name="ln1088">        if(p-&gt;flags &amp; xpf_deleted) {</a>
<a name="ln1089">            xml_remove_prop(xml, (const char *)name);</a>
<a name="ln1090"> </a>
<a name="ln1091">        } else {</a>
<a name="ln1092">            p-&gt;flags = xpf_none;</a>
<a name="ln1093">        }</a>
<a name="ln1094">    }</a>
<a name="ln1095"> </a>
<a name="ln1096">    for (cIter = __xml_first_child(xml); cIter != NULL; cIter = __xml_next(cIter)) {</a>
<a name="ln1097">        __xml_accept_changes(cIter);</a>
<a name="ln1098">    }</a>
<a name="ln1099">}</a>
<a name="ln1100"> </a>
<a name="ln1101">static bool</a>
<a name="ln1102">is_config_change(xmlNode *xml)</a>
<a name="ln1103">{</a>
<a name="ln1104">    GListPtr gIter = NULL;</a>
<a name="ln1105">    xml_private_t *p = NULL;</a>
<a name="ln1106">    xmlNode *config = first_named_child(xml, XML_CIB_TAG_CONFIGURATION);</a>
<a name="ln1107"> </a>
<a name="ln1108">    if(config) {</a>
<a name="ln1109">        p = config-&gt;_private;</a>
<a name="ln1110">    }</a>
<a name="ln1111">    if(p &amp;&amp; is_set(p-&gt;flags, xpf_dirty)) {</a>
<a name="ln1112">        return TRUE;</a>
<a name="ln1113">    }</a>
<a name="ln1114"> </a>
<a name="ln1115">    if(xml-&gt;doc &amp;&amp; xml-&gt;doc-&gt;_private) {</a>
<a name="ln1116">        p = xml-&gt;doc-&gt;_private;</a>
<a name="ln1117">        for(gIter = p-&gt;deleted_objs; gIter; gIter = gIter-&gt;next) {</a>
<a name="ln1118">            xml_deleted_obj_t *deleted_obj = gIter-&gt;data;</a>
<a name="ln1119"> </a>
<a name="ln1120">            if(strstr(deleted_obj-&gt;path, &quot;/&quot;XML_TAG_CIB&quot;/&quot;XML_CIB_TAG_CONFIGURATION) != NULL) {</a>
<a name="ln1121">                return TRUE;</a>
<a name="ln1122">            }</a>
<a name="ln1123">        }</a>
<a name="ln1124">    }</a>
<a name="ln1125"> </a>
<a name="ln1126">    return FALSE;</a>
<a name="ln1127">}</a>
<a name="ln1128"> </a>
<a name="ln1129">static void</a>
<a name="ln1130">xml_repair_v1_diff(xmlNode * last, xmlNode * next, xmlNode * local_diff, gboolean changed)</a>
<a name="ln1131">{</a>
<a name="ln1132">    int lpc = 0;</a>
<a name="ln1133">    xmlNode *cib = NULL;</a>
<a name="ln1134">    xmlNode *diff_child = NULL;</a>
<a name="ln1135"> </a>
<a name="ln1136">    const char *tag = NULL;</a>
<a name="ln1137"> </a>
<a name="ln1138">    const char *vfields[] = {</a>
<a name="ln1139">        XML_ATTR_GENERATION_ADMIN,</a>
<a name="ln1140">        XML_ATTR_GENERATION,</a>
<a name="ln1141">        XML_ATTR_NUMUPDATES,</a>
<a name="ln1142">    };</a>
<a name="ln1143"> </a>
<a name="ln1144">    if (local_diff == NULL) {</a>
<a name="ln1145">        crm_trace(&quot;Nothing to do&quot;);</a>
<a name="ln1146">        return;</a>
<a name="ln1147">    }</a>
<a name="ln1148"> </a>
<a name="ln1149">    tag = &quot;diff-removed&quot;;</a>
<a name="ln1150">    diff_child = find_xml_node(local_diff, tag, FALSE);</a>
<a name="ln1151">    if (diff_child == NULL) {</a>
<a name="ln1152">        diff_child = create_xml_node(local_diff, tag);</a>
<a name="ln1153">    }</a>
<a name="ln1154"> </a>
<a name="ln1155">    tag = XML_TAG_CIB;</a>
<a name="ln1156">    cib = find_xml_node(diff_child, tag, FALSE);</a>
<a name="ln1157">    if (cib == NULL) {</a>
<a name="ln1158">        cib = create_xml_node(diff_child, tag);</a>
<a name="ln1159">    }</a>
<a name="ln1160"> </a>
<a name="ln1161">    for(lpc = 0; last &amp;&amp; lpc &lt; DIMOF(vfields); lpc++){</a>
<a name="ln1162">        const char *value = crm_element_value(last, vfields[lpc]);</a>
<a name="ln1163"> </a>
<a name="ln1164">        crm_xml_add(diff_child, vfields[lpc], value);</a>
<a name="ln1165">        if(changed || lpc == 2) {</a>
<a name="ln1166">            crm_xml_add(cib, vfields[lpc], value);</a>
<a name="ln1167">        }</a>
<a name="ln1168">    }</a>
<a name="ln1169"> </a>
<a name="ln1170">    tag = &quot;diff-added&quot;;</a>
<a name="ln1171">    diff_child = find_xml_node(local_diff, tag, FALSE);</a>
<a name="ln1172">    if (diff_child == NULL) {</a>
<a name="ln1173">        diff_child = create_xml_node(local_diff, tag);</a>
<a name="ln1174">    }</a>
<a name="ln1175"> </a>
<a name="ln1176">    tag = XML_TAG_CIB;</a>
<a name="ln1177">    cib = find_xml_node(diff_child, tag, FALSE);</a>
<a name="ln1178">    if (cib == NULL) {</a>
<a name="ln1179">        cib = create_xml_node(diff_child, tag);</a>
<a name="ln1180">    }</a>
<a name="ln1181"> </a>
<a name="ln1182">    for(lpc = 0; next &amp;&amp; lpc &lt; DIMOF(vfields); lpc++){</a>
<a name="ln1183">        const char *value = crm_element_value(next, vfields[lpc]);</a>
<a name="ln1184"> </a>
<a name="ln1185">        crm_xml_add(diff_child, vfields[lpc], value);</a>
<a name="ln1186">    }</a>
<a name="ln1187"> </a>
<a name="ln1188">    if (next) {</a>
<a name="ln1189">        xmlAttrPtr xIter = NULL;</a>
<a name="ln1190"> </a>
<a name="ln1191">        for (xIter = next-&gt;properties; xIter; xIter = xIter-&gt;next) {</a>
<a name="ln1192">            const char *p_name = (const char *)xIter-&gt;name;</a>
<a name="ln1193">            const char *p_value = crm_element_value(next, p_name);</a>
<a name="ln1194"> </a>
<a name="ln1195">            xmlSetProp(cib, (const xmlChar *)p_name, (const xmlChar *)p_value);</a>
<a name="ln1196">        }</a>
<a name="ln1197">    }</a>
<a name="ln1198"> </a>
<a name="ln1199">    crm_log_xml_explicit(local_diff, &quot;Repaired-diff&quot;);</a>
<a name="ln1200">}</a>
<a name="ln1201"> </a>
<a name="ln1202">static xmlNode *</a>
<a name="ln1203">xml_create_patchset_v1(xmlNode *source, xmlNode *target, bool config, bool suppress)</a>
<a name="ln1204">{</a>
<a name="ln1205">    xmlNode *patchset = diff_xml_object(source, target, suppress);</a>
<a name="ln1206"> </a>
<a name="ln1207">    if(patchset) {</a>
<a name="ln1208">        CRM_LOG_ASSERT(xml_document_dirty(target));</a>
<a name="ln1209">        xml_repair_v1_diff(source, target, patchset, config);</a>
<a name="ln1210">        crm_xml_add(patchset, &quot;format&quot;, &quot;1&quot;);</a>
<a name="ln1211">    }</a>
<a name="ln1212">    return patchset;</a>
<a name="ln1213">}</a>
<a name="ln1214"> </a>
<a name="ln1215">static xmlNode *</a>
<a name="ln1216">xml_create_patchset_v2(xmlNode *source, xmlNode *target)</a>
<a name="ln1217">{</a>
<a name="ln1218">    int lpc = 0;</a>
<a name="ln1219">    GListPtr gIter = NULL;</a>
<a name="ln1220">    xml_private_t *doc = NULL;</a>
<a name="ln1221"> </a>
<a name="ln1222">    xmlNode *v = NULL;</a>
<a name="ln1223">    xmlNode *version = NULL;</a>
<a name="ln1224">    xmlNode *patchset = NULL;</a>
<a name="ln1225">    const char *vfields[] = {</a>
<a name="ln1226">        XML_ATTR_GENERATION_ADMIN,</a>
<a name="ln1227">        XML_ATTR_GENERATION,</a>
<a name="ln1228">        XML_ATTR_NUMUPDATES,</a>
<a name="ln1229">    };</a>
<a name="ln1230"> </a>
<a name="ln1231">    CRM_ASSERT(target);</a>
<a name="ln1232">    if(xml_document_dirty(target) == FALSE) {</a>
<a name="ln1233">        return NULL;</a>
<a name="ln1234">    }</a>
<a name="ln1235"> </a>
<a name="ln1236">    CRM_ASSERT(target-&gt;doc);</a>
<a name="ln1237">    doc = target-&gt;doc-&gt;_private;</a>
<a name="ln1238"> </a>
<a name="ln1239">    patchset = create_xml_node(NULL, XML_TAG_DIFF);</a>
<a name="ln1240">    crm_xml_add_int(patchset, &quot;format&quot;, 2);</a>
<a name="ln1241"> </a>
<a name="ln1242">    version = create_xml_node(patchset, XML_DIFF_VERSION);</a>
<a name="ln1243"> </a>
<a name="ln1244">    v = create_xml_node(version, XML_DIFF_VSOURCE);</a>
<a name="ln1245">    for(lpc = 0; lpc &lt; DIMOF(vfields); lpc++){</a>
<a name="ln1246">        const char *value = crm_element_value(source, vfields[lpc]);</a>
<a name="ln1247"> </a>
<a name="ln1248">        if(value == NULL) {</a>
<a name="ln1249">            value = &quot;1&quot;;</a>
<a name="ln1250">        }</a>
<a name="ln1251">        crm_xml_add(v, vfields[lpc], value);</a>
<a name="ln1252">    }</a>
<a name="ln1253"> </a>
<a name="ln1254">    v = create_xml_node(version, XML_DIFF_VTARGET);</a>
<a name="ln1255">    for(lpc = 0; lpc &lt; DIMOF(vfields); lpc++){</a>
<a name="ln1256">        const char *value = crm_element_value(target, vfields[lpc]);</a>
<a name="ln1257"> </a>
<a name="ln1258">        if(value == NULL) {</a>
<a name="ln1259">            value = &quot;1&quot;;</a>
<a name="ln1260">        }</a>
<a name="ln1261">        crm_xml_add(v, vfields[lpc], value);</a>
<a name="ln1262">    }</a>
<a name="ln1263"> </a>
<a name="ln1264">    for(gIter = doc-&gt;deleted_objs; gIter; gIter = gIter-&gt;next) {</a>
<a name="ln1265">        xml_deleted_obj_t *deleted_obj = gIter-&gt;data;</a>
<a name="ln1266">        xmlNode *change = create_xml_node(patchset, XML_DIFF_CHANGE);</a>
<a name="ln1267"> </a>
<a name="ln1268">        crm_xml_add(change, XML_DIFF_OP, &quot;delete&quot;);</a>
<a name="ln1269">        crm_xml_add(change, XML_DIFF_PATH, deleted_obj-&gt;path);</a>
<a name="ln1270">        if (deleted_obj-&gt;position &gt;= 0) {</a>
<a name="ln1271">            crm_xml_add_int(change, XML_DIFF_POSITION, deleted_obj-&gt;position);</a>
<a name="ln1272">        }</a>
<a name="ln1273">    }</a>
<a name="ln1274"> </a>
<a name="ln1275">    __xml_build_changes(target, patchset);</a>
<a name="ln1276">    return patchset;</a>
<a name="ln1277">}</a>
<a name="ln1278"> </a>
<a name="ln1279">static gboolean patch_legacy_mode(void)</a>
<a name="ln1280">{</a>
<a name="ln1281">    static gboolean init = TRUE;</a>
<a name="ln1282">    static gboolean legacy = FALSE;</a>
<a name="ln1283"> </a>
<a name="ln1284">    if(init) {</a>
<a name="ln1285">        init = FALSE;</a>
<a name="ln1286">        legacy = daemon_option_enabled(&quot;cib&quot;, &quot;legacy&quot;);</a>
<a name="ln1287">        if(legacy) {</a>
<a name="ln1288">            crm_notice(&quot;Enabled legacy mode&quot;);</a>
<a name="ln1289">        }</a>
<a name="ln1290">    }</a>
<a name="ln1291">    return legacy;</a>
<a name="ln1292">}</a>
<a name="ln1293"> </a>
<a name="ln1294">xmlNode *</a>
<a name="ln1295">xml_create_patchset(int format, xmlNode *source, xmlNode *target, bool *config_changed, bool manage_version)</a>
<a name="ln1296">{</a>
<a name="ln1297">    int counter = 0;</a>
<a name="ln1298">    bool config = FALSE;</a>
<a name="ln1299">    xmlNode *patch = NULL;</a>
<a name="ln1300">    const char *version = crm_element_value(source, XML_ATTR_CRM_VERSION);</a>
<a name="ln1301"> </a>
<a name="ln1302">    xml_acl_disable(target);</a>
<a name="ln1303">    if(xml_document_dirty(target) == FALSE) {</a>
<a name="ln1304">        crm_trace(&quot;No change %d&quot;, format);</a>
<a name="ln1305">        return NULL; /* No change */</a>
<a name="ln1306">    }</a>
<a name="ln1307"> </a>
<a name="ln1308">    config = is_config_change(target);</a>
<a name="ln1309">    if(config_changed) {</a>
<a name="ln1310">        *config_changed = config;</a>
<a name="ln1311">    }</a>
<a name="ln1312"> </a>
<a name="ln1313">    if(manage_version &amp;&amp; config) {</a>
<a name="ln1314">        crm_trace(&quot;Config changed %d&quot;, format);</a>
<a name="ln1315">        crm_xml_add(target, XML_ATTR_NUMUPDATES, &quot;0&quot;);</a>
<a name="ln1316"> </a>
<a name="ln1317">        crm_element_value_int(target, XML_ATTR_GENERATION, &amp;counter);</a>
<a name="ln1318">        crm_xml_add_int(target, XML_ATTR_GENERATION, counter+1);</a>
<a name="ln1319"> </a>
<a name="ln1320">    } else if(manage_version) {</a>
<a name="ln1321">        crm_element_value_int(target, XML_ATTR_NUMUPDATES, &amp;counter);</a>
<a name="ln1322">        crm_trace(&quot;Status changed %d - %d %s&quot;, format, counter, crm_element_value(source, XML_ATTR_NUMUPDATES));</a>
<a name="ln1323">        crm_xml_add_int(target, XML_ATTR_NUMUPDATES, counter+1);</a>
<a name="ln1324">    }</a>
<a name="ln1325"> </a>
<a name="ln1326">    if(format == 0) {</a>
<a name="ln1327">        if(patch_legacy_mode()) {</a>
<a name="ln1328">            format = 1;</a>
<a name="ln1329"> </a>
<a name="ln1330">        } else if(compare_version(&quot;3.0.8&quot;, version) &lt; 0) {</a>
<a name="ln1331">            format = 2;</a>
<a name="ln1332"> </a>
<a name="ln1333">        } else {</a>
<a name="ln1334">            format = 1;</a>
<a name="ln1335">        }</a>
<a name="ln1336">        crm_trace(&quot;Using patch format %d for version: %s&quot;, format, version);</a>
<a name="ln1337">    }</a>
<a name="ln1338"> </a>
<a name="ln1339">    switch(format) {</a>
<a name="ln1340">        case 1:</a>
<a name="ln1341">            patch = xml_create_patchset_v1(source, target, config, FALSE);</a>
<a name="ln1342">            break;</a>
<a name="ln1343">        case 2:</a>
<a name="ln1344">            patch = xml_create_patchset_v2(source, target);</a>
<a name="ln1345">            break;</a>
<a name="ln1346">        default:</a>
<a name="ln1347">            crm_err(&quot;Unknown patch format: %d&quot;, format);</a>
<a name="ln1348">            return NULL;</a>
<a name="ln1349">    }</a>
<a name="ln1350"> </a>
<a name="ln1351">    return patch;</a>
<a name="ln1352">}</a>
<a name="ln1353"> </a>
<a name="ln1354">void</a>
<a name="ln1355">patchset_process_digest(xmlNode *patch, xmlNode *source, xmlNode *target, bool with_digest)</a>
<a name="ln1356">{</a>
<a name="ln1357">    int format = 1;</a>
<a name="ln1358">    const char *version = NULL;</a>
<a name="ln1359">    char *digest = NULL;</a>
<a name="ln1360"> </a>
<a name="ln1361">    if (patch == NULL || source == NULL || target == NULL) {</a>
<a name="ln1362">        return;</a>
<a name="ln1363">    }</a>
<a name="ln1364"> </a>
<a name="ln1365">    /* NOTE: We should always call xml_accept_changes() before calculating digest. */</a>
<a name="ln1366">    /* Otherwise, with an on-tracking dirty target, we could get a wrong digest. */</a>
<a name="ln1367">    CRM_LOG_ASSERT(xml_document_dirty(target) == FALSE);</a>
<a name="ln1368"> </a>
<a name="ln1369">    crm_element_value_int(patch, &quot;format&quot;, &amp;format);</a>
<a name="ln1370">    if (format &gt; 1 &amp;&amp; with_digest == FALSE) {</a>
<a name="ln1371">        return;</a>
<a name="ln1372">    }</a>
<a name="ln1373"> </a>
<a name="ln1374">    version = crm_element_value(source, XML_ATTR_CRM_VERSION);</a>
<a name="ln1375">    digest = calculate_xml_versioned_digest(target, FALSE, TRUE, version);</a>
<a name="ln1376"> </a>
<a name="ln1377">    crm_xml_add(patch, XML_ATTR_DIGEST, digest);</a>
<a name="ln1378">    free(digest);</a>
<a name="ln1379"> </a>
<a name="ln1380">    return;</a>
<a name="ln1381">}</a>
<a name="ln1382"> </a>
<a name="ln1383">static void</a>
<a name="ln1384">__xml_log_element(int log_level, const char *file, const char *function, int line,</a>
<a name="ln1385">                  const char *prefix, xmlNode * data, int depth, int options);</a>
<a name="ln1386"> </a>
<a name="ln1387">void</a>
<a name="ln1388">xml_log_patchset(uint8_t log_level, const char *function, xmlNode * patchset)</a>
<a name="ln1389">{</a>
<a name="ln1390">    int format = 1;</a>
<a name="ln1391">    xmlNode *child = NULL;</a>
<a name="ln1392">    xmlNode *added = NULL;</a>
<a name="ln1393">    xmlNode *removed = NULL;</a>
<a name="ln1394">    gboolean is_first = TRUE;</a>
<a name="ln1395"> </a>
<a name="ln1396">    int add[] = { 0, 0, 0 };</a>
<a name="ln1397">    int del[] = { 0, 0, 0 };</a>
<a name="ln1398"> </a>
<a name="ln1399">    const char *fmt = NULL;</a>
<a name="ln1400">    const char *digest = NULL;</a>
<a name="ln1401">    int options = xml_log_option_formatted;</a>
<a name="ln1402"> </a>
<a name="ln1403">    static struct qb_log_callsite *patchset_cs = NULL;</a>
<a name="ln1404"> </a>
<a name="ln1405">    if (patchset_cs == NULL) {</a>
<a name="ln1406">        patchset_cs = qb_log_callsite_get(function, __FILE__, &quot;xml-patchset&quot;, log_level, __LINE__, 0);</a>
<a name="ln1407">    }</a>
<a name="ln1408"> </a>
<a name="ln1409">    if (patchset == NULL) {</a>
<a name="ln1410">        crm_trace(&quot;Empty patch&quot;);</a>
<a name="ln1411">        return;</a>
<a name="ln1412"> </a>
<a name="ln1413">    } else if (log_level == 0) {</a>
<a name="ln1414">        /* Log to stdout */</a>
<a name="ln1415">    } else if (crm_is_callsite_active(patchset_cs, log_level, 0) == FALSE) {</a>
<a name="ln1416">        return;</a>
<a name="ln1417">    }</a>
<a name="ln1418"> </a>
<a name="ln1419">    xml_patch_versions(patchset, add, del);</a>
<a name="ln1420">    fmt = crm_element_value(patchset, &quot;format&quot;);</a>
<a name="ln1421">    digest = crm_element_value(patchset, XML_ATTR_DIGEST);</a>
<a name="ln1422"> </a>
<a name="ln1423">    if (add[2] != del[2] || add[1] != del[1] || add[0] != del[0]) {</a>
<a name="ln1424">        do_crm_log_alias(log_level, __FILE__, function, __LINE__,</a>
<a name="ln1425">                         &quot;Diff: --- %d.%d.%d %s&quot;, del[0], del[1], del[2], fmt);</a>
<a name="ln1426">        do_crm_log_alias(log_level, __FILE__, function, __LINE__,</a>
<a name="ln1427">                         &quot;Diff: +++ %d.%d.%d %s&quot;, add[0], add[1], add[2], digest);</a>
<a name="ln1428"> </a>
<a name="ln1429">    } else if (patchset != NULL &amp;&amp; (add[0] || add[1] || add[2])) {</a>
<a name="ln1430">        do_crm_log_alias(log_level, __FILE__, function, __LINE__, </a>
<a name="ln1431">                         &quot;%s: Local-only Change: %d.%d.%d&quot;, function ? function : &quot;&quot;,</a>
<a name="ln1432">                         add[0], add[1], add[2]);</a>
<a name="ln1433">    }</a>
<a name="ln1434"> </a>
<a name="ln1435">    crm_element_value_int(patchset, &quot;format&quot;, &amp;format);</a>
<a name="ln1436">    if(format == 2) {</a>
<a name="ln1437">        xmlNode *change = NULL;</a>
<a name="ln1438"> </a>
<a name="ln1439">        for (change = __xml_first_child(patchset); change != NULL; change = __xml_next(change)) {</a>
<a name="ln1440">            const char *op = crm_element_value(change, XML_DIFF_OP);</a>
<a name="ln1441">            const char *xpath = crm_element_value(change, XML_DIFF_PATH);</a>
<a name="ln1442"> </a>
<a name="ln1443">            if(op == NULL) {</a>
<a name="ln1444">            } else if(strcmp(op, &quot;create&quot;) == 0) {</a>
<a name="ln1445">                int lpc = 0, max = 0;</a>
<a name="ln1446">                char *prefix = crm_strdup_printf(&quot;++ %s: &quot;, xpath);</a>
<a name="ln1447"> </a>
<a name="ln1448">                max = strlen(prefix);</a>
<a name="ln1449">                __xml_log_element(log_level, __FILE__, function, __LINE__, prefix, change-&gt;children,</a>
<a name="ln1450">                                  0, xml_log_option_formatted|xml_log_option_open);</a>
<a name="ln1451"> </a>
<a name="ln1452">                for(lpc = 2; lpc &lt; max; lpc++) {</a>
<a name="ln1453">                    prefix[lpc] = ' ';</a>
<a name="ln1454">                }</a>
<a name="ln1455"> </a>
<a name="ln1456">                __xml_log_element(log_level, __FILE__, function, __LINE__, prefix, change-&gt;children,</a>
<a name="ln1457">                                  0, xml_log_option_formatted|xml_log_option_close|xml_log_option_children);</a>
<a name="ln1458">                free(prefix);</a>
<a name="ln1459"> </a>
<a name="ln1460">            } else if(strcmp(op, &quot;move&quot;) == 0) {</a>
<a name="ln1461">                do_crm_log_alias(log_level, __FILE__, function, __LINE__, &quot;+~ %s moved to offset %s&quot;, xpath, crm_element_value(change, XML_DIFF_POSITION));</a>
<a name="ln1462"> </a>
<a name="ln1463">            } else if(strcmp(op, &quot;modify&quot;) == 0) {</a>
<a name="ln1464">                xmlNode *clist = first_named_child(change, XML_DIFF_LIST);</a>
<a name="ln1465">                char buffer_set[XML_BUFFER_SIZE];</a>
<a name="ln1466">                char buffer_unset[XML_BUFFER_SIZE];</a>
<a name="ln1467">                int o_set = 0;</a>
<a name="ln1468">                int o_unset = 0;</a>
<a name="ln1469"> </a>
<a name="ln1470">                buffer_set[0] = 0;</a>
<a name="ln1471">                buffer_unset[0] = 0;</a>
<a name="ln1472">                for (child = __xml_first_child(clist); child != NULL; child = __xml_next(child)) {</a>
<a name="ln1473">                    const char *name = crm_element_value(child, &quot;name&quot;);</a>
<a name="ln1474"> </a>
<a name="ln1475">                    op = crm_element_value(child, XML_DIFF_OP);</a>
<a name="ln1476">                    if(op == NULL) {</a>
<a name="ln1477">                    } else if(strcmp(op, &quot;set&quot;) == 0) {</a>
<a name="ln1478">                        const char *value = crm_element_value(child, &quot;value&quot;);</a>
<a name="ln1479"> </a>
<a name="ln1480">                        if(o_set &gt; 0) {</a>
<a name="ln1481">                            o_set += snprintf(buffer_set + o_set, XML_BUFFER_SIZE - o_set, &quot;, &quot;);</a>
<a name="ln1482">                        }</a>
<a name="ln1483">                        o_set += snprintf(buffer_set + o_set, XML_BUFFER_SIZE - o_set, &quot;@%s=%s&quot;, name, value);</a>
<a name="ln1484"> </a>
<a name="ln1485">                    } else if(strcmp(op, &quot;unset&quot;) == 0) {</a>
<a name="ln1486">                        if(o_unset &gt; 0) {</a>
<a name="ln1487">                            o_unset += snprintf(buffer_unset + o_unset, XML_BUFFER_SIZE - o_unset, &quot;, &quot;);</a>
<a name="ln1488">                        }</a>
<a name="ln1489">                        o_unset += snprintf(buffer_unset + o_unset, XML_BUFFER_SIZE - o_unset, &quot;@%s&quot;, name);</a>
<a name="ln1490">                    }</a>
<a name="ln1491">                }</a>
<a name="ln1492">                if(o_set) {</a>
<a name="ln1493">                    do_crm_log_alias(log_level, __FILE__, function, __LINE__, &quot;+  %s:  %s&quot;, xpath, buffer_set);</a>
<a name="ln1494">                }</a>
<a name="ln1495">                if(o_unset) {</a>
<a name="ln1496">                    do_crm_log_alias(log_level, __FILE__, function, __LINE__, &quot;-- %s:  %s&quot;, xpath, buffer_unset);</a>
<a name="ln1497">                }</a>
<a name="ln1498"> </a>
<a name="ln1499">            } else if(strcmp(op, &quot;delete&quot;) == 0) {</a>
<a name="ln1500">                int position = -1;</a>
<a name="ln1501"> </a>
<a name="ln1502">                crm_element_value_int(change, XML_DIFF_POSITION, &amp;position);</a>
<a name="ln1503">                if (position &gt;= 0) {</a>
<a name="ln1504">                    do_crm_log_alias(log_level, __FILE__, function, __LINE__, &quot;-- %s (%d)&quot;, xpath, position);</a>
<a name="ln1505"> </a>
<a name="ln1506">                } else {</a>
<a name="ln1507">                    do_crm_log_alias(log_level, __FILE__, function, __LINE__, &quot;-- %s&quot;, xpath);</a>
<a name="ln1508">                }</a>
<a name="ln1509">            }</a>
<a name="ln1510">        }</a>
<a name="ln1511">        return;</a>
<a name="ln1512">    }</a>
<a name="ln1513"> </a>
<a name="ln1514">    if (log_level &lt; LOG_DEBUG || function == NULL) {</a>
<a name="ln1515">        options |= xml_log_option_diff_short;</a>
<a name="ln1516">    }</a>
<a name="ln1517"> </a>
<a name="ln1518">    removed = find_xml_node(patchset, &quot;diff-removed&quot;, FALSE);</a>
<a name="ln1519">    for (child = __xml_first_child(removed); child != NULL; child = __xml_next(child)) {</a>
<a name="ln1520">        log_data_element(log_level, __FILE__, function, __LINE__, &quot;- &quot;, child, 0,</a>
<a name="ln1521">                         options | xml_log_option_diff_minus);</a>
<a name="ln1522">        if (is_first) {</a>
<a name="ln1523">            is_first = FALSE;</a>
<a name="ln1524">        } else {</a>
<a name="ln1525">            do_crm_log_alias(log_level, __FILE__, function, __LINE__, &quot; --- &quot;);</a>
<a name="ln1526">        }</a>
<a name="ln1527">    }</a>
<a name="ln1528"> </a>
<a name="ln1529">    is_first = TRUE;</a>
<a name="ln1530">    added = find_xml_node(patchset, &quot;diff-added&quot;, FALSE);</a>
<a name="ln1531">    for (child = __xml_first_child(added); child != NULL; child = __xml_next(child)) {</a>
<a name="ln1532">        log_data_element(log_level, __FILE__, function, __LINE__, &quot;+ &quot;, child, 0,</a>
<a name="ln1533">                         options | xml_log_option_diff_plus);</a>
<a name="ln1534">        if (is_first) {</a>
<a name="ln1535">            is_first = FALSE;</a>
<a name="ln1536">        } else {</a>
<a name="ln1537">            do_crm_log_alias(log_level, __FILE__, function, __LINE__, &quot; +++ &quot;);</a>
<a name="ln1538">        }</a>
<a name="ln1539">    }</a>
<a name="ln1540">}</a>
<a name="ln1541"> </a>
<a name="ln1542">void</a>
<a name="ln1543">xml_log_changes(uint8_t log_level, const char *function, xmlNode * xml)</a>
<a name="ln1544">{</a>
<a name="ln1545">    GListPtr gIter = NULL;</a>
<a name="ln1546">    xml_private_t *doc = NULL;</a>
<a name="ln1547"> </a>
<a name="ln1548">    CRM_ASSERT(xml);</a>
<a name="ln1549">    CRM_ASSERT(xml-&gt;doc);</a>
<a name="ln1550"> </a>
<a name="ln1551">    doc = xml-&gt;doc-&gt;_private;</a>
<a name="ln1552">    if(is_not_set(doc-&gt;flags, xpf_dirty)) {</a>
<a name="ln1553">        return;</a>
<a name="ln1554">    }</a>
<a name="ln1555"> </a>
<a name="ln1556">    for(gIter = doc-&gt;deleted_objs; gIter; gIter = gIter-&gt;next) {</a>
<a name="ln1557">        xml_deleted_obj_t *deleted_obj = gIter-&gt;data;</a>
<a name="ln1558"> </a>
<a name="ln1559">        if (deleted_obj-&gt;position &gt;= 0) {</a>
<a name="ln1560">            do_crm_log_alias(log_level, __FILE__, function, __LINE__, &quot;-- %s (%d)&quot;,</a>
<a name="ln1561">                             deleted_obj-&gt;path, deleted_obj-&gt;position);</a>
<a name="ln1562"> </a>
<a name="ln1563">        } else {</a>
<a name="ln1564">            do_crm_log_alias(log_level, __FILE__, function, __LINE__, &quot;-- %s&quot;,</a>
<a name="ln1565">                             deleted_obj-&gt;path);</a>
<a name="ln1566">        }</a>
<a name="ln1567">    }</a>
<a name="ln1568"> </a>
<a name="ln1569">    log_data_element(log_level, __FILE__, function, __LINE__, &quot;+ &quot;, xml, 0,</a>
<a name="ln1570">                     xml_log_option_formatted|xml_log_option_dirty_add);</a>
<a name="ln1571">}</a>
<a name="ln1572"> </a>
<a name="ln1573">void</a>
<a name="ln1574">xml_accept_changes(xmlNode * xml)</a>
<a name="ln1575">{</a>
<a name="ln1576">    xmlNode *top = NULL;</a>
<a name="ln1577">    xml_private_t *doc = NULL;</a>
<a name="ln1578"> </a>
<a name="ln1579">    if(xml == NULL) {</a>
<a name="ln1580">        return;</a>
<a name="ln1581">    }</a>
<a name="ln1582"> </a>
<a name="ln1583">    crm_trace(&quot;Accepting changes to %p&quot;, xml);</a>
<a name="ln1584">    doc = xml-&gt;doc-&gt;_private;</a>
<a name="ln1585">    top = xmlDocGetRootElement(xml-&gt;doc);</a>
<a name="ln1586"> </a>
<a name="ln1587">    __xml_private_clean(xml-&gt;doc-&gt;_private);</a>
<a name="ln1588"> </a>
<a name="ln1589">    if(is_not_set(doc-&gt;flags, xpf_dirty)) {</a>
<a name="ln1590">        doc-&gt;flags = xpf_none;</a>
<a name="ln1591">        return;</a>
<a name="ln1592">    }</a>
<a name="ln1593"> </a>
<a name="ln1594">    doc-&gt;flags = xpf_none;</a>
<a name="ln1595">    __xml_accept_changes(top);</a>
<a name="ln1596">}</a>
<a name="ln1597"> </a>
<a name="ln1598">static xmlNode *</a>
<a name="ln1599">find_element(xmlNode *haystack, xmlNode *needle, gboolean exact)</a>
<a name="ln1600">{</a>
<a name="ln1601">    CRM_CHECK(needle != NULL, return NULL);</a>
<a name="ln1602">    return (needle-&gt;type == XML_COMMENT_NODE)?</a>
<a name="ln1603">           find_xml_comment(haystack, needle, exact)</a>
<a name="ln1604">           : find_entity(haystack, crm_element_name(needle), ID(needle));</a>
<a name="ln1605">}</a>
<a name="ln1606"> </a>
<a name="ln1607">/* Simplified version for applying v1-style XML patches */</a>
<a name="ln1608">static void</a>
<a name="ln1609">__subtract_xml_object(xmlNode * target, xmlNode * patch)</a>
<a name="ln1610">{</a>
<a name="ln1611">    xmlNode *patch_child = NULL;</a>
<a name="ln1612">    xmlNode *cIter = NULL;</a>
<a name="ln1613">    xmlAttrPtr xIter = NULL;</a>
<a name="ln1614"> </a>
<a name="ln1615">    char *id = NULL;</a>
<a name="ln1616">    const char *name = NULL;</a>
<a name="ln1617">    const char *value = NULL;</a>
<a name="ln1618"> </a>
<a name="ln1619">    if (target == NULL || patch == NULL) {</a>
<a name="ln1620">        return;</a>
<a name="ln1621">    }</a>
<a name="ln1622"> </a>
<a name="ln1623">    if (target-&gt;type == XML_COMMENT_NODE) {</a>
<a name="ln1624">        gboolean dummy;</a>
<a name="ln1625"> </a>
<a name="ln1626">        subtract_xml_comment(target-&gt;parent, target, patch, &amp;dummy);</a>
<a name="ln1627">    }</a>
<a name="ln1628"> </a>
<a name="ln1629">    name = crm_element_name(target);</a>
<a name="ln1630">    CRM_CHECK(name != NULL, return);</a>
<a name="ln1631">    CRM_CHECK(safe_str_eq(crm_element_name(target), crm_element_name(patch)), return);</a>
<a name="ln1632">    CRM_CHECK(safe_str_eq(ID(target), ID(patch)), return);</a>
<a name="ln1633"> </a>
<a name="ln1634">    /* check for XML_DIFF_MARKER in a child */</a>
<a name="ln1635">    id = crm_element_value_copy(target, XML_ATTR_ID);</a>
<a name="ln1636">    value = crm_element_value(patch, XML_DIFF_MARKER);</a>
<a name="ln1637">    if (value != NULL &amp;&amp; strcmp(value, &quot;removed:top&quot;) == 0) {</a>
<a name="ln1638">        crm_trace(&quot;We are the root of the deletion: %s.id=%s&quot;, name, id);</a>
<a name="ln1639">        free_xml(target);</a>
<a name="ln1640">        free(id);</a>
<a name="ln1641">        return;</a>
<a name="ln1642">    }</a>
<a name="ln1643"> </a>
<a name="ln1644">    for (xIter = crm_first_attr(patch); xIter != NULL; xIter = xIter-&gt;next) {</a>
<a name="ln1645">        const char *p_name = (const char *)xIter-&gt;name;</a>
<a name="ln1646"> </a>
<a name="ln1647">        /* Removing and then restoring the id field would change the ordering of properties */</a>
<a name="ln1648">        if (safe_str_neq(p_name, XML_ATTR_ID)) {</a>
<a name="ln1649">            xml_remove_prop(target, p_name);</a>
<a name="ln1650">        }</a>
<a name="ln1651">    }</a>
<a name="ln1652"> </a>
<a name="ln1653">    /* changes to child objects */</a>
<a name="ln1654">    cIter = __xml_first_child(target);</a>
<a name="ln1655">    while (cIter) {</a>
<a name="ln1656">        xmlNode *target_child = cIter;</a>
<a name="ln1657"> </a>
<a name="ln1658">        cIter = __xml_next(cIter);</a>
<a name="ln1659">        patch_child = find_element(patch, target_child, FALSE);</a>
<a name="ln1660">        __subtract_xml_object(target_child, patch_child);</a>
<a name="ln1661">    }</a>
<a name="ln1662">    free(id);</a>
<a name="ln1663">}</a>
<a name="ln1664"> </a>
<a name="ln1665">static void</a>
<a name="ln1666">__add_xml_object(xmlNode * parent, xmlNode * target, xmlNode * patch)</a>
<a name="ln1667">{</a>
<a name="ln1668">    xmlNode *patch_child = NULL;</a>
<a name="ln1669">    xmlNode *target_child = NULL;</a>
<a name="ln1670">    xmlAttrPtr xIter = NULL;</a>
<a name="ln1671"> </a>
<a name="ln1672">    const char *id = NULL;</a>
<a name="ln1673">    const char *name = NULL;</a>
<a name="ln1674">    const char *value = NULL;</a>
<a name="ln1675"> </a>
<a name="ln1676">    if (patch == NULL) {</a>
<a name="ln1677">        return;</a>
<a name="ln1678">    } else if (parent == NULL &amp;&amp; target == NULL) {</a>
<a name="ln1679">        return;</a>
<a name="ln1680">    }</a>
<a name="ln1681"> </a>
<a name="ln1682">    /* check for XML_DIFF_MARKER in a child */</a>
<a name="ln1683">    value = crm_element_value(patch, XML_DIFF_MARKER);</a>
<a name="ln1684">    if (target == NULL</a>
<a name="ln1685">        &amp;&amp; value != NULL</a>
<a name="ln1686">        &amp;&amp; strcmp(value, &quot;added:top&quot;) == 0) {</a>
<a name="ln1687">        id = ID(patch);</a>
<a name="ln1688">        name = crm_element_name(patch);</a>
<a name="ln1689">        crm_trace(&quot;We are the root of the addition: %s.id=%s&quot;, name, id);</a>
<a name="ln1690">        add_node_copy(parent, patch);</a>
<a name="ln1691">        return;</a>
<a name="ln1692"> </a>
<a name="ln1693">    } else if(target == NULL) {</a>
<a name="ln1694">        id = ID(patch);</a>
<a name="ln1695">        name = crm_element_name(patch);</a>
<a name="ln1696">        crm_err(&quot;Could not locate: %s.id=%s&quot;, name, id);</a>
<a name="ln1697">        return;</a>
<a name="ln1698">    }</a>
<a name="ln1699"> </a>
<a name="ln1700">    if (target-&gt;type == XML_COMMENT_NODE) {</a>
<a name="ln1701">        add_xml_comment(parent, target, patch);</a>
<a name="ln1702">    }</a>
<a name="ln1703"> </a>
<a name="ln1704">    name = crm_element_name(target);</a>
<a name="ln1705">    CRM_CHECK(name != NULL, return);</a>
<a name="ln1706">    CRM_CHECK(safe_str_eq(crm_element_name(target), crm_element_name(patch)), return);</a>
<a name="ln1707">    CRM_CHECK(safe_str_eq(ID(target), ID(patch)), return);</a>
<a name="ln1708"> </a>
<a name="ln1709">    for (xIter = crm_first_attr(patch); xIter != NULL; xIter = xIter-&gt;next) {</a>
<a name="ln1710">        const char *p_name = (const char *)xIter-&gt;name;</a>
<a name="ln1711">        const char *p_value = crm_element_value(patch, p_name);</a>
<a name="ln1712"> </a>
<a name="ln1713">        xml_remove_prop(target, p_name); /* Preserve the patch order */</a>
<a name="ln1714">        crm_xml_add(target, p_name, p_value);</a>
<a name="ln1715">    }</a>
<a name="ln1716"> </a>
<a name="ln1717">    /* changes to child objects */</a>
<a name="ln1718">    for (patch_child = __xml_first_child(patch); patch_child != NULL;</a>
<a name="ln1719">         patch_child = __xml_next(patch_child)) {</a>
<a name="ln1720"> </a>
<a name="ln1721">        target_child = find_element(target, patch_child, FALSE);</a>
<a name="ln1722">        __add_xml_object(target, target_child, patch_child);</a>
<a name="ln1723">    }</a>
<a name="ln1724">}</a>
<a name="ln1725"> </a>
<a name="ln1726">/*!</a>
<a name="ln1727"> * \internal</a>
<a name="ln1728"> * \brief Find additions or removals in a patch set</a>
<a name="ln1729"> *</a>
<a name="ln1730"> * \param[in]     patchset   XML of patch</a>
<a name="ln1731"> * \param[in]     format     Patch version</a>
<a name="ln1732"> * \param[in]     added      TRUE if looking for additions, FALSE if removals</a>
<a name="ln1733"> * \param[in/out] patch_node Will be set to node if found</a>
<a name="ln1734"> *</a>
<a name="ln1735"> * \return TRUE if format is valid, FALSE if invalid</a>
<a name="ln1736"> */</a>
<a name="ln1737">static bool</a>
<a name="ln1738">find_patch_xml_node(xmlNode *patchset, int format, bool added,</a>
<a name="ln1739">                    xmlNode **patch_node)</a>
<a name="ln1740">{</a>
<a name="ln1741">    xmlNode *cib_node;</a>
<a name="ln1742">    const char *label;</a>
<a name="ln1743"> </a>
<a name="ln1744">    switch(format) {</a>
<a name="ln1745">        case 1:</a>
<a name="ln1746">            label = added? &quot;diff-added&quot; : &quot;diff-removed&quot;;</a>
<a name="ln1747">            *patch_node = find_xml_node(patchset, label, FALSE);</a>
<a name="ln1748">            cib_node = find_xml_node(*patch_node, &quot;cib&quot;, FALSE);</a>
<a name="ln1749">            if (cib_node != NULL) {</a>
<a name="ln1750">                *patch_node = cib_node;</a>
<a name="ln1751">            }</a>
<a name="ln1752">            break;</a>
<a name="ln1753">        case 2:</a>
<a name="ln1754">            label = added? &quot;target&quot; : &quot;source&quot;;</a>
<a name="ln1755">            *patch_node = find_xml_node(patchset, &quot;version&quot;, FALSE);</a>
<a name="ln1756">            *patch_node = find_xml_node(*patch_node, label, FALSE);</a>
<a name="ln1757">            break;</a>
<a name="ln1758">        default:</a>
<a name="ln1759">            crm_warn(&quot;Unknown patch format: %d&quot;, format);</a>
<a name="ln1760">            *patch_node = NULL;</a>
<a name="ln1761">            return FALSE;</a>
<a name="ln1762">    }</a>
<a name="ln1763">    return TRUE;</a>
<a name="ln1764">}</a>
<a name="ln1765"> </a>
<a name="ln1766">bool xml_patch_versions(xmlNode *patchset, int add[3], int del[3])</a>
<a name="ln1767">{</a>
<a name="ln1768">    int lpc = 0;</a>
<a name="ln1769">    int format = 1;</a>
<a name="ln1770">    xmlNode *tmp = NULL;</a>
<a name="ln1771"> </a>
<a name="ln1772">    const char *vfields[] = {</a>
<a name="ln1773">        XML_ATTR_GENERATION_ADMIN,</a>
<a name="ln1774">        XML_ATTR_GENERATION,</a>
<a name="ln1775">        XML_ATTR_NUMUPDATES,</a>
<a name="ln1776">    };</a>
<a name="ln1777"> </a>
<a name="ln1778"> </a>
<a name="ln1779">    crm_element_value_int(patchset, &quot;format&quot;, &amp;format);</a>
<a name="ln1780"> </a>
<a name="ln1781">    /* Process removals */</a>
<a name="ln1782">    if (!find_patch_xml_node(patchset, format, FALSE, &amp;tmp)) {</a>
<a name="ln1783">        return -EINVAL;</a>
<a name="ln1784">    }</a>
<a name="ln1785">    if (tmp) {</a>
<a name="ln1786">        for(lpc = 0; lpc &lt; DIMOF(vfields); lpc++) {</a>
<a name="ln1787">            crm_element_value_int(tmp, vfields[lpc], &amp;(del[lpc]));</a>
<a name="ln1788">            crm_trace(&quot;Got %d for del[%s]&quot;, del[lpc], vfields[lpc]);</a>
<a name="ln1789">        }</a>
<a name="ln1790">    }</a>
<a name="ln1791"> </a>
<a name="ln1792">    /* Process additions */</a>
<a name="ln1793">    if (!find_patch_xml_node(patchset, format, TRUE, &amp;tmp)) {</a>
<a name="ln1794">        return -EINVAL;</a>
<a name="ln1795">    }</a>
<a name="ln1796">    if (tmp) {</a>
<a name="ln1797">        for(lpc = 0; lpc &lt; DIMOF(vfields); lpc++) {</a>
<a name="ln1798">            crm_element_value_int(tmp, vfields[lpc], &amp;(add[lpc]));</a>
<a name="ln1799">            crm_trace(&quot;Got %d for add[%s]&quot;, add[lpc], vfields[lpc]);</a>
<a name="ln1800">        }</a>
<a name="ln1801">    }</a>
<a name="ln1802"> </a>
<a name="ln1803">    return pcmk_ok;</a>
<a name="ln1804">}</a>
<a name="ln1805"> </a>
<a name="ln1806">static int</a>
<a name="ln1807">xml_patch_version_check(xmlNode *xml, xmlNode *patchset, int format) </a>
<a name="ln1808">{</a>
<a name="ln1809">    int lpc = 0;</a>
<a name="ln1810">    bool changed = FALSE;</a>
<a name="ln1811"> </a>
<a name="ln1812">    int this[] = { 0, 0, 0 };</a>
<a name="ln1813">    int add[] = { 0, 0, 0 };</a>
<a name="ln1814">    int del[] = { 0, 0, 0 };</a>
<a name="ln1815"> </a>
<a name="ln1816">    const char *vfields[] = {</a>
<a name="ln1817">        XML_ATTR_GENERATION_ADMIN,</a>
<a name="ln1818">        XML_ATTR_GENERATION,</a>
<a name="ln1819">        XML_ATTR_NUMUPDATES,</a>
<a name="ln1820">    };</a>
<a name="ln1821"> </a>
<a name="ln1822">    for(lpc = 0; lpc &lt; DIMOF(vfields); lpc++) {</a>
<a name="ln1823">        crm_element_value_int(xml, vfields[lpc], &amp;(this[lpc]));</a>
<a name="ln1824">        crm_trace(&quot;Got %d for this[%s]&quot;, this[lpc], vfields[lpc]);</a>
<a name="ln1825">        if (this[lpc] &lt; 0) {</a>
<a name="ln1826">            this[lpc] = 0;</a>
<a name="ln1827">        }</a>
<a name="ln1828">    }</a>
<a name="ln1829"> </a>
<a name="ln1830">    /* Set some defaults in case nothing is present */</a>
<a name="ln1831">    add[0] = this[0];</a>
<a name="ln1832">    add[1] = this[1];</a>
<a name="ln1833">    add[2] = this[2] + 1;</a>
<a name="ln1834">    for(lpc = 0; lpc &lt; DIMOF(vfields); lpc++) {</a>
<a name="ln1835">        del[lpc] = this[lpc];</a>
<a name="ln1836">    }</a>
<a name="ln1837"> </a>
<a name="ln1838">    xml_patch_versions(patchset, add, del);</a>
<a name="ln1839"> </a>
<a name="ln1840">    for(lpc = 0; lpc &lt; DIMOF(vfields); lpc++) {</a>
<a name="ln1841">        if(this[lpc] &lt; del[lpc]) {</a>
<a name="ln1842">            crm_debug(&quot;Current %s is too low (%d.%d.%d &lt; %d.%d.%d --&gt; %d.%d.%d)&quot;, vfields[lpc],</a>
<a name="ln1843">                      this[0], this[1], this[2], del[0], del[1], del[2], add[0], add[1], add[2]);</a>
<a name="ln1844">            return -pcmk_err_diff_resync;</a>
<a name="ln1845"> </a>
<a name="ln1846">        } else if(this[lpc] &gt; del[lpc]) {</a>
<a name="ln1847">            crm_info(&quot;Current %s is too high (%d.%d.%d &gt; %d.%d.%d --&gt; %d.%d.%d) %p&quot;, vfields[lpc],</a>
<a name="ln1848">                     this[0], this[1], this[2], del[0], del[1], del[2], add[0], add[1], add[2], patchset);</a>
<a name="ln1849">            crm_log_xml_info(patchset, &quot;OldPatch&quot;);</a>
<a name="ln1850">            return -pcmk_err_old_data;</a>
<a name="ln1851">        }</a>
<a name="ln1852">    }</a>
<a name="ln1853"> </a>
<a name="ln1854">    for(lpc = 0; lpc &lt; DIMOF(vfields); lpc++) {</a>
<a name="ln1855">        if(add[lpc] &gt; del[lpc]) {</a>
<a name="ln1856">            changed = TRUE;</a>
<a name="ln1857">        }</a>
<a name="ln1858">    }</a>
<a name="ln1859"> </a>
<a name="ln1860">    if(changed == FALSE) {</a>
<a name="ln1861">        crm_notice(&quot;Versions did not change in patch %d.%d.%d&quot;, add[0], add[1], add[2]);</a>
<a name="ln1862">        return -pcmk_err_old_data;</a>
<a name="ln1863">    }</a>
<a name="ln1864"> </a>
<a name="ln1865">    crm_debug(&quot;Can apply patch %d.%d.%d to %d.%d.%d&quot;,</a>
<a name="ln1866">             add[0], add[1], add[2], this[0], this[1], this[2]);</a>
<a name="ln1867">    return pcmk_ok;</a>
<a name="ln1868">}</a>
<a name="ln1869"> </a>
<a name="ln1870">static int</a>
<a name="ln1871">xml_apply_patchset_v1(xmlNode *xml, xmlNode *patchset, bool check_version) </a>
<a name="ln1872">{</a>
<a name="ln1873">    int rc = pcmk_ok;</a>
<a name="ln1874">    int root_nodes_seen = 0;</a>
<a name="ln1875">    char *version = crm_element_value_copy(xml, XML_ATTR_CRM_VERSION);</a>
<a name="ln1876"> </a>
<a name="ln1877">    xmlNode *child_diff = NULL;</a>
<a name="ln1878">    xmlNode *added = find_xml_node(patchset, &quot;diff-added&quot;, FALSE);</a>
<a name="ln1879">    xmlNode *removed = find_xml_node(patchset, &quot;diff-removed&quot;, FALSE);</a>
<a name="ln1880">    xmlNode *old = copy_xml(xml);</a>
<a name="ln1881"> </a>
<a name="ln1882">    crm_trace(&quot;Subtraction Phase&quot;);</a>
<a name="ln1883">    for (child_diff = __xml_first_child(removed); child_diff != NULL;</a>
<a name="ln1884">         child_diff = __xml_next(child_diff)) {</a>
<a name="ln1885">        CRM_CHECK(root_nodes_seen == 0, rc = FALSE);</a>
<a name="ln1886">        if (root_nodes_seen == 0) {</a>
<a name="ln1887">            __subtract_xml_object(xml, child_diff);</a>
<a name="ln1888">        }</a>
<a name="ln1889">        root_nodes_seen++;</a>
<a name="ln1890">    }</a>
<a name="ln1891"> </a>
<a name="ln1892">    if (root_nodes_seen &gt; 1) {</a>
<a name="ln1893">        crm_err(&quot;(-) Diffs cannot contain more than one change set... saw %d&quot;, root_nodes_seen);</a>
<a name="ln1894">        rc = -ENOTUNIQ;</a>
<a name="ln1895">    }</a>
<a name="ln1896"> </a>
<a name="ln1897">    root_nodes_seen = 0;</a>
<a name="ln1898">    crm_trace(&quot;Addition Phase&quot;);</a>
<a name="ln1899">    if (rc == pcmk_ok) {</a>
<a name="ln1900">        xmlNode *child_diff = NULL;</a>
<a name="ln1901"> </a>
<a name="ln1902">        for (child_diff = __xml_first_child(added); child_diff != NULL;</a>
<a name="ln1903">             child_diff = __xml_next(child_diff)) {</a>
<a name="ln1904">            CRM_CHECK(root_nodes_seen == 0, rc = FALSE);</a>
<a name="ln1905">            if (root_nodes_seen == 0) {</a>
<a name="ln1906">                __add_xml_object(NULL, xml, child_diff);</a>
<a name="ln1907">            }</a>
<a name="ln1908">            root_nodes_seen++;</a>
<a name="ln1909">        }</a>
<a name="ln1910">    }</a>
<a name="ln1911"> </a>
<a name="ln1912">    if (root_nodes_seen &gt; 1) {</a>
<a name="ln1913">        crm_err(&quot;(+) Diffs cannot contain more than one change set... saw %d&quot;, root_nodes_seen);</a>
<a name="ln1914">        rc = -ENOTUNIQ;</a>
<a name="ln1915">    }</a>
<a name="ln1916"> </a>
<a name="ln1917">    purge_diff_markers(xml);       /* Purge prior to checking the digest */</a>
<a name="ln1918"> </a>
<a name="ln1919">    free_xml(old);</a>
<a name="ln1920">    free(version);</a>
<a name="ln1921">    return rc;</a>
<a name="ln1922">}</a>
<a name="ln1923"> </a>
<a name="ln1924">static xmlNode *</a>
<a name="ln1925">__first_xml_child_match(xmlNode *parent, const char *name, const char *id, int position)</a>
<a name="ln1926">{</a>
<a name="ln1927">    xmlNode *cIter = NULL;</a>
<a name="ln1928"> </a>
<a name="ln1929">    for (cIter = __xml_first_child(parent); cIter != NULL; cIter = __xml_next(cIter)) {</a>
<a name="ln1930">        if(strcmp((const char *)cIter-&gt;name, name) != 0) {</a>
<a name="ln1931">            continue;</a>
<a name="ln1932">        } else if(id) {</a>
<a name="ln1933">            const char *cid = ID(cIter);</a>
<a name="ln1934">            if(cid == NULL || strcmp(cid, id) != 0) {</a>
<a name="ln1935">                continue;</a>
<a name="ln1936">            }</a>
<a name="ln1937">        }</a>
<a name="ln1938"> </a>
<a name="ln1939">        /* The &quot;position&quot; makes sense only for XML comments for now */</a>
<a name="ln1940">        if (cIter-&gt;type == XML_COMMENT_NODE</a>
<a name="ln1941">            &amp;&amp; position &gt;= 0</a>
<a name="ln1942">            &amp;&amp; __xml_offset(cIter) != position) {</a>
<a name="ln1943">            continue;</a>
<a name="ln1944">        }</a>
<a name="ln1945"> </a>
<a name="ln1946">        return cIter;</a>
<a name="ln1947">    }</a>
<a name="ln1948">    return NULL;</a>
<a name="ln1949">}</a>
<a name="ln1950"> </a>
<a name="ln1951">static xmlNode *</a>
<a name="ln1952">__xml_find_path(xmlNode *top, const char *key, int target_position)</a>
<a name="ln1953">{</a>
<a name="ln1954">    xmlNode *target = (xmlNode*)top-&gt;doc;</a>
<a name="ln1955">    char *id = malloc(XML_BUFFER_SIZE);</a>
<a name="ln1956">    char *tag = malloc(XML_BUFFER_SIZE);</a>
<a name="ln1957">    char *section = malloc(XML_BUFFER_SIZE);</a>
<a name="ln1958">    char *current = strdup(key);</a>
<a name="ln1959">    char *remainder = malloc(XML_BUFFER_SIZE);</a>
<a name="ln1960">    int rc = 0;</a>
<a name="ln1961"> </a>
<a name="ln1962">    while(current) {</a>
<a name="ln1963">        rc = sscanf (current, &quot;/%[^/]%s&quot;, section, remainder);</a>
<a name="ln1964">        if(rc &lt;= 0) {</a>
<a name="ln1965">            crm_trace(&quot;Done&quot;);</a>
<a name="ln1966">            break;</a>
<a name="ln1967"> </a>
<a name="ln1968">        } else if(rc &gt; 2) {</a>
<a name="ln1969">            crm_trace(&quot;Aborting on %s&quot;, current);</a>
<a name="ln1970">            target = NULL;</a>
<a name="ln1971">            break;</a>
<a name="ln1972"> </a>
<a name="ln1973">        } else if(tag &amp;&amp; section) {</a>
<a name="ln1974">            int f = sscanf (section, &quot;%[^[][@id='%[^']&quot;, tag, id);</a>
<a name="ln1975">            int current_position = -1;</a>
<a name="ln1976"> </a>
<a name="ln1977">            /* The &quot;target_position&quot; is for the target tag */</a>
<a name="ln1978">            if (rc == 1 &amp;&amp; target_position &gt;= 0) {</a>
<a name="ln1979">                current_position = target_position;</a>
<a name="ln1980">            }</a>
<a name="ln1981"> </a>
<a name="ln1982">            switch(f) {</a>
<a name="ln1983">                case 1:</a>
<a name="ln1984">                    target = __first_xml_child_match(target, tag, NULL, current_position);</a>
<a name="ln1985">                    break;</a>
<a name="ln1986">                case 2:</a>
<a name="ln1987">                    target = __first_xml_child_match(target, tag, id, current_position);</a>
<a name="ln1988">                    break;</a>
<a name="ln1989">                default:</a>
<a name="ln1990">                    crm_trace(&quot;Aborting on %s&quot;, section);</a>
<a name="ln1991">                    target = NULL;</a>
<a name="ln1992">                    break;</a>
<a name="ln1993">            }</a>
<a name="ln1994"> </a>
<a name="ln1995">            if(rc == 1 || target == NULL) {</a>
<a name="ln1996">                crm_trace(&quot;Done&quot;);</a>
<a name="ln1997">                break;</a>
<a name="ln1998"> </a>
<a name="ln1999">            } else {</a>
<a name="ln2000">                char *tmp = current;</a>
<a name="ln2001">                current = remainder;</a>
<a name="ln2002">                remainder = tmp;</a>
<a name="ln2003">            }</a>
<a name="ln2004">        }</a>
<a name="ln2005">    }</a>
<a name="ln2006"> </a>
<a name="ln2007">    if(target) {</a>
<a name="ln2008">        char *path = (char *)xmlGetNodePath(target);</a>
<a name="ln2009"> </a>
<a name="ln2010">        crm_trace(&quot;Found %s for %s&quot;, path, key);</a>
<a name="ln2011">        free(path);</a>
<a name="ln2012">    } else {</a>
<a name="ln2013">        crm_debug(&quot;No match for %s&quot;, key);</a>
<a name="ln2014">    }</a>
<a name="ln2015"> </a>
<a name="ln2016">    free(remainder);</a>
<a name="ln2017">    free(current);</a>
<a name="ln2018">    free(section);</a>
<a name="ln2019">    free(tag);</a>
<a name="ln2020">    free(id);</a>
<a name="ln2021">    return target;</a>
<a name="ln2022">}</a>
<a name="ln2023"> </a>
<a name="ln2024">static int</a>
<a name="ln2025">xml_apply_patchset_v2(xmlNode *xml, xmlNode *patchset, bool check_version) </a>
<a name="ln2026">{</a>
<a name="ln2027">    int rc = pcmk_ok;</a>
<a name="ln2028">    xmlNode *change = NULL;</a>
<a name="ln2029">    for (change = __xml_first_child(patchset); change != NULL; change = __xml_next(change)) {</a>
<a name="ln2030">        xmlNode *match = NULL;</a>
<a name="ln2031">        const char *op = crm_element_value(change, XML_DIFF_OP);</a>
<a name="ln2032">        const char *xpath = crm_element_value(change, XML_DIFF_PATH);</a>
<a name="ln2033">        int position = -1;</a>
<a name="ln2034"> </a>
<a name="ln2035">        crm_trace(&quot;Processing %s %s&quot;, change-&gt;name, op);</a>
<a name="ln2036">        if(op == NULL) {</a>
<a name="ln2037">            continue;</a>
<a name="ln2038">        }</a>
<a name="ln2039"> </a>
<a name="ln2040">        if(strcmp(op, &quot;delete&quot;) == 0) {</a>
<a name="ln2041">            crm_element_value_int(change, XML_DIFF_POSITION, &amp;position);</a>
<a name="ln2042">        }</a>
<a name="ln2043">#if 0</a>
<a name="ln2044">        match = get_xpath_object(xpath, xml, LOG_TRACE);</a>
<a name="ln2045">#else</a>
<a name="ln2046">        match = __xml_find_path(xml, xpath, position);</a>
<a name="ln2047">#endif</a>
<a name="ln2048">        crm_trace(&quot;Performing %s on %s with %p&quot;, op, xpath, match);</a>
<a name="ln2049"> </a>
<a name="ln2050">        if(match == NULL &amp;&amp; strcmp(op, &quot;delete&quot;) == 0) {</a>
<a name="ln2051">            crm_debug(&quot;No %s match for %s in %p&quot;, op, xpath, xml-&gt;doc);</a>
<a name="ln2052">            continue;</a>
<a name="ln2053"> </a>
<a name="ln2054">        } else if(match == NULL) {</a>
<a name="ln2055">            crm_err(&quot;No %s match for %s in %p&quot;, op, xpath, xml-&gt;doc);</a>
<a name="ln2056">            rc = -pcmk_err_diff_failed;</a>
<a name="ln2057">            continue;</a>
<a name="ln2058"> </a>
<a name="ln2059">        } else if(strcmp(op, &quot;create&quot;) == 0) {</a>
<a name="ln2060">            int position = 0;</a>
<a name="ln2061">            xmlNode *child = NULL;</a>
<a name="ln2062">            xmlNode *match_child = NULL;</a>
<a name="ln2063"> </a>
<a name="ln2064">            match_child = match-&gt;children;</a>
<a name="ln2065">            crm_element_value_int(change, XML_DIFF_POSITION, &amp;position);</a>
<a name="ln2066"> </a>
<a name="ln2067">            while(match_child &amp;&amp; position != __xml_offset(match_child)) {</a>
<a name="ln2068">                match_child = match_child-&gt;next;</a>
<a name="ln2069">            }</a>
<a name="ln2070"> </a>
<a name="ln2071">            child = xmlDocCopyNode(change-&gt;children, match-&gt;doc, 1);</a>
<a name="ln2072">            if(match_child) {</a>
<a name="ln2073">                crm_trace(&quot;Adding %s at position %d&quot;, child-&gt;name, position);</a>
<a name="ln2074">                xmlAddPrevSibling(match_child, child);</a>
<a name="ln2075"> </a>
<a name="ln2076">            } else if(match-&gt;last) { /* Add to the end */</a>
<a name="ln2077">                crm_trace(&quot;Adding %s at position %d (end)&quot;, child-&gt;name, position);</a>
<a name="ln2078">                xmlAddNextSibling(match-&gt;last, child);</a>
<a name="ln2079"> </a>
<a name="ln2080">            } else {</a>
<a name="ln2081">                crm_trace(&quot;Adding %s at position %d (first)&quot;, child-&gt;name, position);</a>
<a name="ln2082">                CRM_LOG_ASSERT(position == 0);</a>
<a name="ln2083">                xmlAddChild(match, child);</a>
<a name="ln2084">            }</a>
<a name="ln2085">            crm_node_created(child);</a>
<a name="ln2086"> </a>
<a name="ln2087">        } else if(strcmp(op, &quot;move&quot;) == 0) {</a>
<a name="ln2088">            int position = 0;</a>
<a name="ln2089"> </a>
<a name="ln2090">            crm_element_value_int(change, XML_DIFF_POSITION, &amp;position);</a>
<a name="ln2091">            if(position != __xml_offset(match)) {</a>
<a name="ln2092">                xmlNode *match_child = NULL;</a>
<a name="ln2093">                int p = position;</a>
<a name="ln2094"> </a>
<a name="ln2095">                if(p &gt; __xml_offset(match)) {</a>
<a name="ln2096">                    p++; /* Skip ourselves */</a>
<a name="ln2097">                }</a>
<a name="ln2098"> </a>
<a name="ln2099">                CRM_ASSERT(match-&gt;parent != NULL);</a>
<a name="ln2100">                match_child = match-&gt;parent-&gt;children;</a>
<a name="ln2101"> </a>
<a name="ln2102">                while(match_child &amp;&amp; p != __xml_offset(match_child)) {</a>
<a name="ln2103">                    match_child = match_child-&gt;next;</a>
<a name="ln2104">                }</a>
<a name="ln2105"> </a>
<a name="ln2106">                crm_trace(&quot;Moving %s to position %d (was %d, prev %p, %s %p)&quot;,</a>
<a name="ln2107">                         match-&gt;name, position, __xml_offset(match), match-&gt;prev,</a>
<a name="ln2108">                         match_child?&quot;next&quot;:&quot;last&quot;, match_child?match_child:match-&gt;parent-&gt;last);</a>
<a name="ln2109"> </a>
<a name="ln2110">                if(match_child) {</a>
<a name="ln2111">                    xmlAddPrevSibling(match_child, match);</a>
<a name="ln2112"> </a>
<a name="ln2113">                } else {</a>
<a name="ln2114">                    CRM_ASSERT(match-&gt;parent-&gt;last != NULL);</a>
<a name="ln2115">                    xmlAddNextSibling(match-&gt;parent-&gt;last, match);</a>
<a name="ln2116">                }</a>
<a name="ln2117"> </a>
<a name="ln2118">            } else {</a>
<a name="ln2119">                crm_trace(&quot;%s is already in position %d&quot;, match-&gt;name, position);</a>
<a name="ln2120">            }</a>
<a name="ln2121"> </a>
<a name="ln2122">            if(position != __xml_offset(match)) {</a>
<a name="ln2123">                crm_err(&quot;Moved %s.%d to position %d instead of %d (%p)&quot;,</a>
<a name="ln2124">                        match-&gt;name, ID(match), __xml_offset(match), position, match-&gt;prev);</a>
<a name="ln2125">                rc = -pcmk_err_diff_failed;</a>
<a name="ln2126">            }</a>
<a name="ln2127"> </a>
<a name="ln2128">        } else if(strcmp(op, &quot;delete&quot;) == 0) {</a>
<a name="ln2129">            free_xml(match);</a>
<a name="ln2130"> </a>
<a name="ln2131">        } else if(strcmp(op, &quot;modify&quot;) == 0) {</a>
<a name="ln2132">            xmlAttr *pIter = crm_first_attr(match);</a>
<a name="ln2133">            xmlNode *attrs = __xml_first_child(first_named_child(change, XML_DIFF_RESULT));</a>
<a name="ln2134"> </a>
<a name="ln2135">            if(attrs == NULL) {</a>
<a name="ln2136">                rc = -ENOMSG;</a>
<a name="ln2137">                continue;</a>
<a name="ln2138">            }</a>
<a name="ln2139">            while(pIter != NULL) {</a>
<a name="ln2140">                const char *name = (const char *)pIter-&gt;name;</a>
<a name="ln2141"> </a>
<a name="ln2142">                pIter = pIter-&gt;next;</a>
<a name="ln2143">                xml_remove_prop(match, name);</a>
<a name="ln2144">            }</a>
<a name="ln2145"> </a>
<a name="ln2146">            for (pIter = crm_first_attr(attrs); pIter != NULL; pIter = pIter-&gt;next) {</a>
<a name="ln2147">                const char *name = (const char *)pIter-&gt;name;</a>
<a name="ln2148">                const char *value = crm_element_value(attrs, name);</a>
<a name="ln2149"> </a>
<a name="ln2150">                crm_xml_add(match, name, value);</a>
<a name="ln2151">            }</a>
<a name="ln2152"> </a>
<a name="ln2153">        } else {</a>
<a name="ln2154">            crm_err(&quot;Unknown operation: %s&quot;, op);</a>
<a name="ln2155">        }</a>
<a name="ln2156">    }</a>
<a name="ln2157">    return rc;</a>
<a name="ln2158">}</a>
<a name="ln2159"> </a>
<a name="ln2160">int</a>
<a name="ln2161">xml_apply_patchset(xmlNode *xml, xmlNode *patchset, bool check_version) </a>
<a name="ln2162">{</a>
<a name="ln2163">    int format = 1;</a>
<a name="ln2164">    int rc = pcmk_ok;</a>
<a name="ln2165">    xmlNode *old = NULL;</a>
<a name="ln2166">    const char *digest = crm_element_value(patchset, XML_ATTR_DIGEST);</a>
<a name="ln2167"> </a>
<a name="ln2168">    if(patchset == NULL) {</a>
<a name="ln2169">        return rc;</a>
<a name="ln2170">    }</a>
<a name="ln2171"> </a>
<a name="ln2172">    xml_log_patchset(LOG_TRACE, __FUNCTION__, patchset);</a>
<a name="ln2173"> </a>
<a name="ln2174">    crm_element_value_int(patchset, &quot;format&quot;, &amp;format);</a>
<a name="ln2175">    if(check_version) {</a>
<a name="ln2176">        rc = xml_patch_version_check(xml, patchset, format);</a>
<a name="ln2177">        if(rc != pcmk_ok) {</a>
<a name="ln2178">            return rc;</a>
<a name="ln2179">        }</a>
<a name="ln2180">    }</a>
<a name="ln2181"> </a>
<a name="ln2182">    if(digest) {</a>
<a name="ln2183">        /* Make it available for logging if the result doesn't have the expected digest */</a>
<a name="ln2184">        old = copy_xml(xml);</a>
<a name="ln2185">    }</a>
<a name="ln2186"> </a>
<a name="ln2187">    if(rc == pcmk_ok) {</a>
<a name="ln2188">        switch(format) {</a>
<a name="ln2189">            case 1:</a>
<a name="ln2190">                rc = xml_apply_patchset_v1(xml, patchset, check_version);</a>
<a name="ln2191">                break;</a>
<a name="ln2192">            case 2:</a>
<a name="ln2193">                rc = xml_apply_patchset_v2(xml, patchset, check_version);</a>
<a name="ln2194">                break;</a>
<a name="ln2195">            default:</a>
<a name="ln2196">                crm_err(&quot;Unknown patch format: %d&quot;, format);</a>
<a name="ln2197">                rc = -EINVAL;</a>
<a name="ln2198">        }</a>
<a name="ln2199">    }</a>
<a name="ln2200"> </a>
<a name="ln2201">    if(rc == pcmk_ok &amp;&amp; digest) {</a>
<a name="ln2202">        static struct qb_log_callsite *digest_cs = NULL;</a>
<a name="ln2203"> </a>
<a name="ln2204">        char *new_digest = NULL;</a>
<a name="ln2205">        char *version = crm_element_value_copy(xml, XML_ATTR_CRM_VERSION);</a>
<a name="ln2206"> </a>
<a name="ln2207">        if (digest_cs == NULL) {</a>
<a name="ln2208">            digest_cs =</a>
<a name="ln2209">                qb_log_callsite_get(__func__, __FILE__, &quot;diff-digest&quot;, LOG_TRACE, __LINE__,</a>
<a name="ln2210">                                    crm_trace_nonlog);</a>
<a name="ln2211">        }</a>
<a name="ln2212"> </a>
<a name="ln2213">        new_digest = calculate_xml_versioned_digest(xml, FALSE, TRUE, version);</a>
<a name="ln2214">        if (safe_str_neq(new_digest, digest)) {</a>
<a name="ln2215">            crm_info(&quot;v%d digest mis-match: expected %s, calculated %s&quot;, format, digest, new_digest);</a>
<a name="ln2216">            rc = -pcmk_err_diff_failed;</a>
<a name="ln2217"> </a>
<a name="ln2218">            if (digest_cs &amp;&amp; digest_cs-&gt;targets) {</a>
<a name="ln2219">                save_xml_to_file(old,     &quot;PatchDigest:input&quot;, NULL);</a>
<a name="ln2220">                save_xml_to_file(xml,     &quot;PatchDigest:result&quot;, NULL);</a>
<a name="ln2221">                save_xml_to_file(patchset,&quot;PatchDigest:diff&quot;, NULL);</a>
<a name="ln2222"> </a>
<a name="ln2223">            } else {</a>
<a name="ln2224">                crm_trace(&quot;%p %.6x&quot;, digest_cs, digest_cs ? digest_cs-&gt;targets : 0);</a>
<a name="ln2225">            }</a>
<a name="ln2226"> </a>
<a name="ln2227">        } else {</a>
<a name="ln2228">            crm_trace(&quot;v%d digest matched: expected %s, calculated %s&quot;, format, digest, new_digest);</a>
<a name="ln2229">        }</a>
<a name="ln2230">        free(new_digest);</a>
<a name="ln2231">        free(version);</a>
<a name="ln2232">    }</a>
<a name="ln2233">    free_xml(old);</a>
<a name="ln2234">    return rc;</a>
<a name="ln2235">}</a>
<a name="ln2236"> </a>
<a name="ln2237">xmlNode *</a>
<a name="ln2238">find_xml_node(xmlNode * root, const char *search_path, gboolean must_find)</a>
<a name="ln2239">{</a>
<a name="ln2240">    xmlNode *a_child = NULL;</a>
<a name="ln2241">    const char *name = &quot;NULL&quot;;</a>
<a name="ln2242"> </a>
<a name="ln2243">    if (root != NULL) {</a>
<a name="ln2244">        name = crm_element_name(root);</a>
<a name="ln2245">    }</a>
<a name="ln2246"> </a>
<a name="ln2247">    if (search_path == NULL) {</a>
<a name="ln2248">        crm_warn(&quot;Will never find &lt;NULL&gt;&quot;);</a>
<a name="ln2249">        return NULL;</a>
<a name="ln2250">    }</a>
<a name="ln2251"> </a>
<a name="ln2252">    for (a_child = __xml_first_child(root); a_child != NULL; a_child = __xml_next(a_child)) {</a>
<a name="ln2253">        if (strcmp((const char *)a_child-&gt;name, search_path) == 0) {</a>
<a name="ln2254">/* 		crm_trace(&quot;returning node (%s).&quot;, crm_element_name(a_child)); */</a>
<a name="ln2255">            return a_child;</a>
<a name="ln2256">        }</a>
<a name="ln2257">    }</a>
<a name="ln2258"> </a>
<a name="ln2259">    if (must_find) {</a>
<a name="ln2260">        crm_warn(&quot;Could not find %s in %s.&quot;, search_path, name);</a>
<a name="ln2261">    } else if (root != NULL) {</a>
<a name="ln2262">        crm_trace(&quot;Could not find %s in %s.&quot;, search_path, name);</a>
<a name="ln2263">    } else {</a>
<a name="ln2264">        crm_trace(&quot;Could not find %s in &lt;NULL&gt;.&quot;, search_path);</a>
<a name="ln2265">    }</a>
<a name="ln2266"> </a>
<a name="ln2267">    return NULL;</a>
<a name="ln2268">}</a>
<a name="ln2269"> </a>
<a name="ln2270">xmlNode *</a>
<a name="ln2271">find_entity(xmlNode * parent, const char *node_name, const char *id)</a>
<a name="ln2272">{</a>
<a name="ln2273">    xmlNode *a_child = NULL;</a>
<a name="ln2274"> </a>
<a name="ln2275">    for (a_child = __xml_first_child(parent); a_child != NULL; a_child = __xml_next(a_child)) {</a>
<a name="ln2276">        /* Uncertain if node_name == NULL check is strictly necessary here */</a>
<a name="ln2277">        if (node_name == NULL || strcmp((const char *)a_child-&gt;name, node_name) == 0) {</a>
<a name="ln2278">            const char *cid = ID(a_child);</a>
<a name="ln2279">            if (id == NULL || (cid != NULL &amp;&amp; strcmp(id, cid) == 0)) {</a>
<a name="ln2280">                return a_child;</a>
<a name="ln2281">            }</a>
<a name="ln2282">        }</a>
<a name="ln2283">    }</a>
<a name="ln2284"> </a>
<a name="ln2285">    crm_trace(&quot;node &lt;%s id=%s&gt; not found in %s.&quot;, node_name, id, crm_element_name(parent));</a>
<a name="ln2286">    return NULL;</a>
<a name="ln2287">}</a>
<a name="ln2288"> </a>
<a name="ln2289">void</a>
<a name="ln2290">copy_in_properties(xmlNode * target, xmlNode * src)</a>
<a name="ln2291">{</a>
<a name="ln2292">    if (src == NULL) {</a>
<a name="ln2293">        crm_warn(&quot;No node to copy properties from&quot;);</a>
<a name="ln2294"> </a>
<a name="ln2295">    } else if (target == NULL) {</a>
<a name="ln2296">        crm_err(&quot;No node to copy properties into&quot;);</a>
<a name="ln2297"> </a>
<a name="ln2298">    } else {</a>
<a name="ln2299">        xmlAttrPtr pIter = NULL;</a>
<a name="ln2300"> </a>
<a name="ln2301">        for (pIter = crm_first_attr(src); pIter != NULL; pIter = pIter-&gt;next) {</a>
<a name="ln2302">            const char *p_name = (const char *)pIter-&gt;name;</a>
<a name="ln2303">            const char *p_value = crm_attr_value(pIter);</a>
<a name="ln2304"> </a>
<a name="ln2305">            expand_plus_plus(target, p_name, p_value);</a>
<a name="ln2306">        }</a>
<a name="ln2307">    }</a>
<a name="ln2308"> </a>
<a name="ln2309">    return;</a>
<a name="ln2310">}</a>
<a name="ln2311"> </a>
<a name="ln2312">void</a>
<a name="ln2313">fix_plus_plus_recursive(xmlNode * target)</a>
<a name="ln2314">{</a>
<a name="ln2315">    /* TODO: Remove recursion and use xpath searches for value++ */</a>
<a name="ln2316">    xmlNode *child = NULL;</a>
<a name="ln2317">    xmlAttrPtr pIter = NULL;</a>
<a name="ln2318"> </a>
<a name="ln2319">    for (pIter = crm_first_attr(target); pIter != NULL; pIter = pIter-&gt;next) {</a>
<a name="ln2320">        const char *p_name = (const char *)pIter-&gt;name;</a>
<a name="ln2321">        const char *p_value = crm_attr_value(pIter);</a>
<a name="ln2322"> </a>
<a name="ln2323">        expand_plus_plus(target, p_name, p_value);</a>
<a name="ln2324">    }</a>
<a name="ln2325">    for (child = __xml_first_child(target); child != NULL; child = __xml_next(child)) {</a>
<a name="ln2326">        fix_plus_plus_recursive(child);</a>
<a name="ln2327">    }</a>
<a name="ln2328">}</a>
<a name="ln2329"> </a>
<a name="ln2330">void</a>
<a name="ln2331">expand_plus_plus(xmlNode * target, const char *name, const char *value)</a>
<a name="ln2332">{</a>
<a name="ln2333">    int offset = 1;</a>
<a name="ln2334">    int name_len = 0;</a>
<a name="ln2335">    int int_value = 0;</a>
<a name="ln2336">    int value_len = 0;</a>
<a name="ln2337"> </a>
<a name="ln2338">    const char *old_value = NULL;</a>
<a name="ln2339"> </a>
<a name="ln2340">    if (value == NULL || name == NULL) {</a>
<a name="ln2341">        return;</a>
<a name="ln2342">    }</a>
<a name="ln2343"> </a>
<a name="ln2344">    old_value = crm_element_value(target, name);</a>
<a name="ln2345"> </a>
<a name="ln2346">    if (old_value == NULL) {</a>
<a name="ln2347">        /* if no previous value, set unexpanded */</a>
<a name="ln2348">        goto set_unexpanded;</a>
<a name="ln2349"> </a>
<a name="ln2350">    } else if (strstr(value, name) != value) {</a>
<a name="ln2351">        goto set_unexpanded;</a>
<a name="ln2352">    }</a>
<a name="ln2353"> </a>
<a name="ln2354">    name_len = strlen(name);</a>
<a name="ln2355">    value_len = strlen(value);</a>
<a name="ln2356">    if (value_len &lt; (name_len + 2)</a>
<a name="ln2357">        || value[name_len] != '+' || (value[name_len + 1] != '+' &amp;&amp; value[name_len + 1] != '=')) {</a>
<a name="ln2358">        goto set_unexpanded;</a>
<a name="ln2359">    }</a>
<a name="ln2360"> </a>
<a name="ln2361">    /* if we are expanding ourselves,</a>
<a name="ln2362">     * then no previous value was set and leave int_value as 0</a>
<a name="ln2363">     */</a>
<a name="ln2364">    if (old_value != value) {</a>
<a name="ln2365">        int_value = char2score(old_value);</a>
<a name="ln2366">    }</a>
<a name="ln2367"> </a>
<a name="ln2368">    if (value[name_len + 1] != '+') {</a>
<a name="ln2369">        const char *offset_s = value + (name_len + 2);</a>
<a name="ln2370"> </a>
<a name="ln2371">        offset = char2score(offset_s);</a>
<a name="ln2372">    }</a>
<a name="ln2373">    int_value += offset;</a>
<a name="ln2374"> </a>
<a name="ln2375">    if (int_value &gt; INFINITY) {</a>
<a name="ln2376">        int_value = (int)INFINITY;</a>
<a name="ln2377">    }</a>
<a name="ln2378"> </a>
<a name="ln2379">    crm_xml_add_int(target, name, int_value);</a>
<a name="ln2380">    return;</a>
<a name="ln2381"> </a>
<a name="ln2382">  set_unexpanded:</a>
<a name="ln2383">    if (old_value == value) {</a>
<a name="ln2384">        /* the old value is already set, nothing to do */</a>
<a name="ln2385">        return;</a>
<a name="ln2386">    }</a>
<a name="ln2387">    crm_xml_add(target, name, value);</a>
<a name="ln2388">    return;</a>
<a name="ln2389">}</a>
<a name="ln2390"> </a>
<a name="ln2391">xmlDoc *</a>
<a name="ln2392">getDocPtr(xmlNode * node)</a>
<a name="ln2393">{</a>
<a name="ln2394">    xmlDoc *doc = NULL;</a>
<a name="ln2395"> </a>
<a name="ln2396">    CRM_CHECK(node != NULL, return NULL);</a>
<a name="ln2397"> </a>
<a name="ln2398">    doc = node-&gt;doc;</a>
<a name="ln2399">    if (doc == NULL) {</a>
<a name="ln2400">        doc = xmlNewDoc((const xmlChar *)&quot;1.0&quot;);</a>
<a name="ln2401">        xmlDocSetRootElement(doc, node);</a>
<a name="ln2402">        xmlSetTreeDoc(node, doc);</a>
<a name="ln2403">    }</a>
<a name="ln2404">    return doc;</a>
<a name="ln2405">}</a>
<a name="ln2406"> </a>
<a name="ln2407">xmlNode *</a>
<a name="ln2408">add_node_copy(xmlNode * parent, xmlNode * src_node)</a>
<a name="ln2409">{</a>
<a name="ln2410">    xmlNode *child = NULL;</a>
<a name="ln2411">    xmlDoc *doc = getDocPtr(parent);</a>
<a name="ln2412"> </a>
<a name="ln2413">    CRM_CHECK(src_node != NULL, return NULL);</a>
<a name="ln2414"> </a>
<a name="ln2415">    child = xmlDocCopyNode(src_node, doc, 1);</a>
<a name="ln2416">    xmlAddChild(parent, child);</a>
<a name="ln2417">    crm_node_created(child);</a>
<a name="ln2418">    return child;</a>
<a name="ln2419">}</a>
<a name="ln2420"> </a>
<a name="ln2421">int</a>
<a name="ln2422">add_node_nocopy(xmlNode * parent, const char *name, xmlNode * child)</a>
<a name="ln2423">{</a>
<a name="ln2424">    add_node_copy(parent, child);</a>
<a name="ln2425">    free_xml(child);</a>
<a name="ln2426">    return 1;</a>
<a name="ln2427">}</a>
<a name="ln2428"> </a>
<a name="ln2429">static bool</a>
<a name="ln2430">__xml_acl_check(xmlNode *xml, const char *name, enum xml_private_flags mode)</a>
<a name="ln2431">{</a>
<a name="ln2432">    CRM_ASSERT(xml);</a>
<a name="ln2433">    CRM_ASSERT(xml-&gt;doc);</a>
<a name="ln2434">    CRM_ASSERT(xml-&gt;doc-&gt;_private);</a>
<a name="ln2435"> </a>
<a name="ln2436">#if ENABLE_ACL</a>
<a name="ln2437">    {</a>
<a name="ln2438">        if(TRACKING_CHANGES(xml) &amp;&amp; xml_acl_enabled(xml)) {</a>
<a name="ln2439">            int offset = 0;</a>
<a name="ln2440">            xmlNode *parent = xml;</a>
<a name="ln2441">            char buffer[XML_BUFFER_SIZE];</a>
<a name="ln2442">            xml_private_t *docp = xml-&gt;doc-&gt;_private;</a>
<a name="ln2443"> </a>
<a name="ln2444">            if(docp-&gt;acls == NULL) {</a>
<a name="ln2445">                crm_trace(&quot;Ordinary user %s cannot access the CIB without any defined ACLs&quot;, docp-&gt;user);</a>
<a name="ln2446">                set_doc_flag(xml, xpf_acl_denied);</a>
<a name="ln2447">                return FALSE;</a>
<a name="ln2448">            }</a>
<a name="ln2449"> </a>
<a name="ln2450">            offset = __get_prefix(NULL, xml, buffer, offset);</a>
<a name="ln2451">            if(name) {</a>
<a name="ln2452">                offset += snprintf(buffer + offset, XML_BUFFER_SIZE - offset, &quot;[@%s]&quot;, name);</a>
<a name="ln2453">            }</a>
<a name="ln2454">            CRM_LOG_ASSERT(offset &gt; 0);</a>
<a name="ln2455"> </a>
<a name="ln2456">            /* Walk the tree upwards looking for xml_acl_* flags</a>
<a name="ln2457">             * - Creating an attribute requires write permissions for the node</a>
<a name="ln2458">             * - Creating a child requires write permissions for the parent</a>
<a name="ln2459">             */</a>
<a name="ln2460"> </a>
<a name="ln2461">            if(name) {</a>
<a name="ln2462">                xmlAttr *attr = xmlHasProp(xml, (const xmlChar *)name);</a>
<a name="ln2463"> </a>
<a name="ln2464">                if(attr &amp;&amp; mode == xpf_acl_create) {</a>
<a name="ln2465">                    mode = xpf_acl_write;</a>
<a name="ln2466">                }</a>
<a name="ln2467">            }</a>
<a name="ln2468"> </a>
<a name="ln2469">            while(parent &amp;&amp; parent-&gt;_private) {</a>
<a name="ln2470">                xml_private_t *p = parent-&gt;_private;</a>
<a name="ln2471">                if(__xml_acl_mode_test(p-&gt;flags, mode)) {</a>
<a name="ln2472">                    return TRUE;</a>
<a name="ln2473"> </a>
<a name="ln2474">                } else if(is_set(p-&gt;flags, xpf_acl_deny)) {</a>
<a name="ln2475">                    crm_trace(&quot;%x access denied to %s: parent&quot;, mode, buffer);</a>
<a name="ln2476">                    set_doc_flag(xml, xpf_acl_denied);</a>
<a name="ln2477">                    return FALSE;</a>
<a name="ln2478">                }</a>
<a name="ln2479">                parent = parent-&gt;parent;</a>
<a name="ln2480">            }</a>
<a name="ln2481"> </a>
<a name="ln2482">            crm_trace(&quot;%x access denied to %s: default&quot;, mode, buffer);</a>
<a name="ln2483">            set_doc_flag(xml, xpf_acl_denied);</a>
<a name="ln2484">            return FALSE;</a>
<a name="ln2485">        }</a>
<a name="ln2486">    }</a>
<a name="ln2487">#endif</a>
<a name="ln2488"> </a>
<a name="ln2489">    return TRUE;</a>
<a name="ln2490">}</a>
<a name="ln2491"> </a>
<a name="ln2492">const char *</a>
<a name="ln2493">crm_xml_add(xmlNode * node, const char *name, const char *value)</a>
<a name="ln2494">{</a>
<a name="ln2495">    bool dirty = FALSE;</a>
<a name="ln2496">    xmlAttr *attr = NULL;</a>
<a name="ln2497"> </a>
<a name="ln2498">    CRM_CHECK(node != NULL, return NULL);</a>
<a name="ln2499">    CRM_CHECK(name != NULL, return NULL);</a>
<a name="ln2500"> </a>
<a name="ln2501">    if (value == NULL) {</a>
<a name="ln2502">        return NULL;</a>
<a name="ln2503">    }</a>
<a name="ln2504">#if XML_PARANOIA_CHECKS</a>
<a name="ln2505">    {</a>
<a name="ln2506">        const char *old_value = NULL;</a>
<a name="ln2507"> </a>
<a name="ln2508">        old_value = crm_element_value(node, name);</a>
<a name="ln2509"> </a>
<a name="ln2510">        /* Could be re-setting the same value */</a>
<a name="ln2511">        CRM_CHECK(old_value != value, crm_err(&quot;Cannot reset %s with crm_xml_add(%s)&quot;, name, value);</a>
<a name="ln2512">                  return value);</a>
<a name="ln2513">    }</a>
<a name="ln2514">#endif</a>
<a name="ln2515"> </a>
<a name="ln2516">    if(TRACKING_CHANGES(node)) {</a>
<a name="ln2517">        const char *old = crm_element_value(node, name);</a>
<a name="ln2518"> </a>
<a name="ln2519">        if(old == NULL || value == NULL || strcmp(old, value) != 0) {</a>
<a name="ln2520">            dirty = TRUE;</a>
<a name="ln2521">        }</a>
<a name="ln2522">    }</a>
<a name="ln2523"> </a>
<a name="ln2524">    if(dirty &amp;&amp; __xml_acl_check(node, name, xpf_acl_create) == FALSE) {</a>
<a name="ln2525">        crm_trace(&quot;Cannot add %s=%s to %s&quot;, name, value, node-&gt;name);</a>
<a name="ln2526">        return NULL;</a>
<a name="ln2527">    }</a>
<a name="ln2528"> </a>
<a name="ln2529">    attr = xmlSetProp(node, (const xmlChar *)name, (const xmlChar *)value);</a>
<a name="ln2530">    if(dirty) {</a>
<a name="ln2531">        crm_attr_dirty(attr);</a>
<a name="ln2532">    }</a>
<a name="ln2533"> </a>
<a name="ln2534">    CRM_CHECK(attr &amp;&amp; attr-&gt;children &amp;&amp; attr-&gt;children-&gt;content, return NULL);</a>
<a name="ln2535">    return (char *)attr-&gt;children-&gt;content;</a>
<a name="ln2536">}</a>
<a name="ln2537"> </a>
<a name="ln2538">const char *</a>
<a name="ln2539">crm_xml_replace(xmlNode * node, const char *name, const char *value)</a>
<a name="ln2540">{</a>
<a name="ln2541">    bool dirty = FALSE;</a>
<a name="ln2542">    xmlAttr *attr = NULL;</a>
<a name="ln2543">    const char *old_value = NULL;</a>
<a name="ln2544"> </a>
<a name="ln2545">    CRM_CHECK(node != NULL, return NULL);</a>
<a name="ln2546">    CRM_CHECK(name != NULL &amp;&amp; name[0] != 0, return NULL);</a>
<a name="ln2547"> </a>
<a name="ln2548">    old_value = crm_element_value(node, name);</a>
<a name="ln2549"> </a>
<a name="ln2550">    /* Could be re-setting the same value */</a>
<a name="ln2551">    CRM_CHECK(old_value != value, return value);</a>
<a name="ln2552"> </a>
<a name="ln2553">    if(__xml_acl_check(node, name, xpf_acl_write) == FALSE) {</a>
<a name="ln2554">        /* Create a fake object linked to doc-&gt;_private instead? */</a>
<a name="ln2555">        crm_trace(&quot;Cannot replace %s=%s to %s&quot;, name, value, node-&gt;name);</a>
<a name="ln2556">        return NULL;</a>
<a name="ln2557"> </a>
<a name="ln2558">    } else if (old_value != NULL &amp;&amp; value == NULL) {</a>
<a name="ln2559">        xml_remove_prop(node, name);</a>
<a name="ln2560">        return NULL;</a>
<a name="ln2561"> </a>
<a name="ln2562">    } else if (value == NULL) {</a>
<a name="ln2563">        return NULL;</a>
<a name="ln2564">    }</a>
<a name="ln2565"> </a>
<a name="ln2566">    if(TRACKING_CHANGES(node)) {</a>
<a name="ln2567">        if(old_value == NULL || value == NULL || strcmp(old_value, value) != 0) {</a>
<a name="ln2568">            dirty = TRUE;</a>
<a name="ln2569">        }</a>
<a name="ln2570">    }</a>
<a name="ln2571"> </a>
<a name="ln2572">    attr = xmlSetProp(node, (const xmlChar *)name, (const xmlChar *)value);</a>
<a name="ln2573">    if(dirty) {</a>
<a name="ln2574">        crm_attr_dirty(attr);</a>
<a name="ln2575">    }</a>
<a name="ln2576">    CRM_CHECK(attr &amp;&amp; attr-&gt;children &amp;&amp; attr-&gt;children-&gt;content, return NULL);</a>
<a name="ln2577">    return (char *)attr-&gt;children-&gt;content;</a>
<a name="ln2578">}</a>
<a name="ln2579"> </a>
<a name="ln2580">const char *</a>
<a name="ln2581">crm_xml_add_int(xmlNode * node, const char *name, int value)</a>
<a name="ln2582">{</a>
<a name="ln2583">    char *number = crm_itoa(value);</a>
<a name="ln2584">    const char *added = crm_xml_add(node, name, number);</a>
<a name="ln2585"> </a>
<a name="ln2586">    free(number);</a>
<a name="ln2587">    return added;</a>
<a name="ln2588">}</a>
<a name="ln2589"> </a>
<a name="ln2590">xmlNode *</a>
<a name="ln2591">create_xml_node(xmlNode * parent, const char *name)</a>
<a name="ln2592">{</a>
<a name="ln2593">    xmlDoc *doc = NULL;</a>
<a name="ln2594">    xmlNode *node = NULL;</a>
<a name="ln2595"> </a>
<a name="ln2596">    if (name == NULL || name[0] == 0) {</a>
<a name="ln2597">        CRM_CHECK(name != NULL &amp;&amp; name[0] == 0, return NULL);</a>
<a name="ln2598">        return NULL;</a>
<a name="ln2599">    }</a>
<a name="ln2600"> </a>
<a name="ln2601">    if (parent == NULL) {</a>
<a name="ln2602">        doc = xmlNewDoc((const xmlChar *)&quot;1.0&quot;);</a>
<a name="ln2603">        node = xmlNewDocRawNode(doc, NULL, (const xmlChar *)name, NULL);</a>
<a name="ln2604">        xmlDocSetRootElement(doc, node);</a>
<a name="ln2605"> </a>
<a name="ln2606">    } else {</a>
<a name="ln2607">        doc = getDocPtr(parent);</a>
<a name="ln2608">        node = xmlNewDocRawNode(doc, NULL, (const xmlChar *)name, NULL);</a>
<a name="ln2609">        xmlAddChild(parent, node);</a>
<a name="ln2610">    }</a>
<a name="ln2611">    crm_node_created(node);</a>
<a name="ln2612">    return node;</a>
<a name="ln2613">}</a>
<a name="ln2614"> </a>
<a name="ln2615">static inline int</a>
<a name="ln2616">__get_prefix(const char *prefix, xmlNode *xml, char *buffer, int offset)</a>
<a name="ln2617">{</a>
<a name="ln2618">    const char *id = ID(xml);</a>
<a name="ln2619"> </a>
<a name="ln2620">    if(offset == 0 &amp;&amp; prefix == NULL &amp;&amp; xml-&gt;parent) {</a>
<a name="ln2621">        offset = __get_prefix(NULL, xml-&gt;parent, buffer, offset);</a>
<a name="ln2622">    }</a>
<a name="ln2623"> </a>
<a name="ln2624">    if(id) {</a>
<a name="ln2625">        offset += snprintf(buffer + offset, XML_BUFFER_SIZE - offset, &quot;/%s[@id='%s']&quot;, (const char *)xml-&gt;name, id);</a>
<a name="ln2626">    } else if(xml-&gt;name) {</a>
<a name="ln2627">        offset += snprintf(buffer + offset, XML_BUFFER_SIZE - offset, &quot;/%s&quot;, (const char *)xml-&gt;name);</a>
<a name="ln2628">    }</a>
<a name="ln2629"> </a>
<a name="ln2630">    return offset;</a>
<a name="ln2631">}</a>
<a name="ln2632"> </a>
<a name="ln2633">char *</a>
<a name="ln2634">xml_get_path(xmlNode *xml)</a>
<a name="ln2635">{</a>
<a name="ln2636">    int offset = 0;</a>
<a name="ln2637">    char buffer[XML_BUFFER_SIZE];</a>
<a name="ln2638"> </a>
<a name="ln2639">    if(__get_prefix(NULL, xml, buffer, offset) &gt; 0) {</a>
<a name="ln2640">        return strdup(buffer);</a>
<a name="ln2641">    }</a>
<a name="ln2642">    return NULL;</a>
<a name="ln2643">}</a>
<a name="ln2644"> </a>
<a name="ln2645">static void</a>
<a name="ln2646">free_xml_with_position(xmlNode * child, int position)</a>
<a name="ln2647">{</a>
<a name="ln2648">    if (child != NULL) {</a>
<a name="ln2649">        xmlNode *top = NULL;</a>
<a name="ln2650">        xmlDoc *doc = child-&gt;doc;</a>
<a name="ln2651">        xml_private_t *p = child-&gt;_private;</a>
<a name="ln2652"> </a>
<a name="ln2653">        if (doc != NULL) {</a>
<a name="ln2654">            top = xmlDocGetRootElement(doc);</a>
<a name="ln2655">        }</a>
<a name="ln2656"> </a>
<a name="ln2657">        if (doc != NULL &amp;&amp; top == child) {</a>
<a name="ln2658">            /* Free everything */</a>
<a name="ln2659">            xmlFreeDoc(doc);</a>
<a name="ln2660"> </a>
<a name="ln2661">        } else if(__xml_acl_check(child, NULL, xpf_acl_write) == FALSE) {</a>
<a name="ln2662">            int offset = 0;</a>
<a name="ln2663">            char buffer[XML_BUFFER_SIZE];</a>
<a name="ln2664"> </a>
<a name="ln2665">            __get_prefix(NULL, child, buffer, offset);</a>
<a name="ln2666">            crm_trace(&quot;Cannot remove %s %x&quot;, buffer, p-&gt;flags);</a>
<a name="ln2667">            return;</a>
<a name="ln2668"> </a>
<a name="ln2669">        } else {</a>
<a name="ln2670">            if(doc &amp;&amp; TRACKING_CHANGES(child) &amp;&amp; is_not_set(p-&gt;flags, xpf_created)) {</a>
<a name="ln2671">                int offset = 0;</a>
<a name="ln2672">                char buffer[XML_BUFFER_SIZE];</a>
<a name="ln2673"> </a>
<a name="ln2674">                if(__get_prefix(NULL, child, buffer, offset) &gt; 0) {</a>
<a name="ln2675">                    xml_deleted_obj_t *deleted_obj = calloc(1, sizeof(xml_deleted_obj_t));</a>
<a name="ln2676"> </a>
<a name="ln2677">                    crm_trace(&quot;Deleting %s %p from %p&quot;, buffer, child, doc);</a>
<a name="ln2678"> </a>
<a name="ln2679">                    deleted_obj-&gt;path = strdup(buffer);</a>
<a name="ln2680"> </a>
<a name="ln2681">                    deleted_obj-&gt;position = -1;</a>
<a name="ln2682">                    /* Record the &quot;position&quot; only for XML comments for now */</a>
<a name="ln2683">                    if (child-&gt;type == XML_COMMENT_NODE) {</a>
<a name="ln2684">                        if (position &gt;= 0) {</a>
<a name="ln2685">                            deleted_obj-&gt;position = position;</a>
<a name="ln2686"> </a>
<a name="ln2687">                        } else {</a>
<a name="ln2688">                            deleted_obj-&gt;position = __xml_offset(child);</a>
<a name="ln2689">                        }</a>
<a name="ln2690">                    }</a>
<a name="ln2691"> </a>
<a name="ln2692">                    p = doc-&gt;_private;</a>
<a name="ln2693">                    p-&gt;deleted_objs = g_list_append(p-&gt;deleted_objs, deleted_obj);</a>
<a name="ln2694">                    set_doc_flag(child, xpf_dirty);</a>
<a name="ln2695">                }</a>
<a name="ln2696">            }</a>
<a name="ln2697"> </a>
<a name="ln2698">            /* Free this particular subtree</a>
<a name="ln2699">             * Make sure to unlink it from the parent first</a>
<a name="ln2700">             */</a>
<a name="ln2701">            xmlUnlinkNode(child);</a>
<a name="ln2702">            xmlFreeNode(child);</a>
<a name="ln2703">        }</a>
<a name="ln2704">    }</a>
<a name="ln2705">}</a>
<a name="ln2706"> </a>
<a name="ln2707"> </a>
<a name="ln2708">void</a>
<a name="ln2709">free_xml(xmlNode * child)</a>
<a name="ln2710">{</a>
<a name="ln2711">    free_xml_with_position(child, -1);</a>
<a name="ln2712">}</a>
<a name="ln2713"> </a>
<a name="ln2714">xmlNode *</a>
<a name="ln2715">copy_xml(xmlNode * src)</a>
<a name="ln2716">{</a>
<a name="ln2717">    xmlDoc *doc = xmlNewDoc((const xmlChar *)&quot;1.0&quot;);</a>
<a name="ln2718">    xmlNode *copy = xmlDocCopyNode(src, doc, 1);</a>
<a name="ln2719"> </a>
<a name="ln2720">    xmlDocSetRootElement(doc, copy);</a>
<a name="ln2721">    xmlSetTreeDoc(copy, doc);</a>
<a name="ln2722">    return copy;</a>
<a name="ln2723">}</a>
<a name="ln2724"> </a>
<a name="ln2725">static void</a>
<a name="ln2726">crm_xml_err(void *ctx, const char *msg, ...)</a>
<a name="ln2727">G_GNUC_PRINTF(2, 3);</a>
<a name="ln2728"> </a>
<a name="ln2729">static void</a>
<a name="ln2730">crm_xml_err(void *ctx, const char *msg, ...)</a>
<a name="ln2731">{</a>
<a name="ln2732">    int len = 0;</a>
<a name="ln2733">    va_list args;</a>
<a name="ln2734">    char *buf = NULL;</a>
<a name="ln2735">    static int buffer_len = 0;</a>
<a name="ln2736">    static char *buffer = NULL;</a>
<a name="ln2737">    static struct qb_log_callsite *xml_error_cs = NULL;</a>
<a name="ln2738"> </a>
<a name="ln2739">    va_start(args, msg);</a>
<a name="ln2740">    len = vasprintf(&amp;buf, msg, args);</a>
<a name="ln2741"> </a>
<a name="ln2742">    if(xml_error_cs == NULL) {</a>
<a name="ln2743">        xml_error_cs = qb_log_callsite_get(</a>
<a name="ln2744">            __func__, __FILE__, &quot;xml library error&quot;, LOG_TRACE, __LINE__, crm_trace_nonlog);</a>
<a name="ln2745">    }</a>
<a name="ln2746"> </a>
<a name="ln2747">    if (strchr(buf, '\n')) {</a>
<a name="ln2748">        buf[len - 1] = 0;</a>
<a name="ln2749">        if (buffer) {</a>
<a name="ln2750">            crm_err(&quot;XML Error: %s%s&quot;, buffer, buf);</a>
<a name="ln2751">            free(buffer);</a>
<a name="ln2752">        } else {</a>
<a name="ln2753">            crm_err(&quot;XML Error: %s&quot;, buf);</a>
<a name="ln2754">        }</a>
<a name="ln2755">        if (xml_error_cs &amp;&amp; xml_error_cs-&gt;targets) {</a>
<a name="ln2756">            crm_abort(__FILE__, __PRETTY_FUNCTION__, __LINE__, &quot;xml library error&quot;, TRUE, TRUE);</a>
<a name="ln2757">        }</a>
<a name="ln2758">        buffer = NULL;</a>
<a name="ln2759">        buffer_len = 0;</a>
<a name="ln2760"> </a>
<a name="ln2761">    } else if (buffer == NULL) {</a>
<a name="ln2762">        buffer_len = len;</a>
<a name="ln2763">        buffer = buf;</a>
<a name="ln2764">        buf = NULL;</a>
<a name="ln2765"> </a>
<a name="ln2766">    } else {</a>
<a name="ln2767">        buffer = realloc_safe(buffer, 1 + buffer_len + len);</a>
<a name="ln2768">        memcpy(buffer + buffer_len, buf, len);</a>
<a name="ln2769">        buffer_len += len;</a>
<a name="ln2770">        buffer[buffer_len] = 0;</a>
<a name="ln2771">    }</a>
<a name="ln2772"> </a>
<a name="ln2773">    va_end(args);</a>
<a name="ln2774">    free(buf);</a>
<a name="ln2775">}</a>
<a name="ln2776"> </a>
<a name="ln2777">xmlNode *</a>
<a name="ln2778">string2xml(const char *input)</a>
<a name="ln2779">{</a>
<a name="ln2780">    xmlNode *xml = NULL;</a>
<a name="ln2781">    xmlDocPtr output = NULL;</a>
<a name="ln2782">    xmlParserCtxtPtr ctxt = NULL;</a>
<a name="ln2783">    xmlErrorPtr last_error = NULL;</a>
<a name="ln2784"> </a>
<a name="ln2785">    if (input == NULL) {</a>
<a name="ln2786">        crm_err(&quot;Can't parse NULL input&quot;);</a>
<a name="ln2787">        return NULL;</a>
<a name="ln2788">    }</a>
<a name="ln2789"> </a>
<a name="ln2790">    /* create a parser context */</a>
<a name="ln2791">    ctxt = xmlNewParserCtxt();</a>
<a name="ln2792">    CRM_CHECK(ctxt != NULL, return NULL);</a>
<a name="ln2793"> </a>
<a name="ln2794">    /* xmlCtxtUseOptions(ctxt, XML_PARSE_NOBLANKS|XML_PARSE_RECOVER); */</a>
<a name="ln2795"> </a>
<a name="ln2796">    xmlCtxtResetLastError(ctxt);</a>
<a name="ln2797">    xmlSetGenericErrorFunc(ctxt, crm_xml_err);</a>
<a name="ln2798">    /* initGenericErrorDefaultFunc(crm_xml_err); */</a>
<a name="ln2799">    output =</a>
<a name="ln2800">        xmlCtxtReadDoc(ctxt, (const xmlChar *)input, NULL, NULL,</a>
<a name="ln2801">                       XML_PARSE_NOBLANKS | XML_PARSE_RECOVER);</a>
<a name="ln2802">    if (output) {</a>
<a name="ln2803">        xml = xmlDocGetRootElement(output);</a>
<a name="ln2804">    }</a>
<a name="ln2805">    last_error = xmlCtxtGetLastError(ctxt);</a>
<a name="ln2806">    if (last_error &amp;&amp; last_error-&gt;code != XML_ERR_OK) {</a>
<a name="ln2807">        /* crm_abort(__FILE__,__FUNCTION__,__LINE__, &quot;last_error-&gt;code != XML_ERR_OK&quot;, TRUE, TRUE); */</a>
<a name="ln2808">        /*</a>
<a name="ln2809">         * http://xmlsoft.org/html/libxml-xmlerror.html#xmlErrorLevel</a>
<a name="ln2810">         * http://xmlsoft.org/html/libxml-xmlerror.html#xmlParserErrors</a>
<a name="ln2811">         */</a>
<a name="ln2812">        crm_warn(&quot;Parsing failed (domain=%d, level=%d, code=%d): %s&quot;,</a>
<a name="ln2813">                 last_error-&gt;domain, last_error-&gt;level, last_error-&gt;code, last_error-&gt;message);</a>
<a name="ln2814"> </a>
<a name="ln2815">        if (last_error-&gt;code == XML_ERR_DOCUMENT_EMPTY) {</a>
<a name="ln2816">            CRM_LOG_ASSERT(&quot;Cannot parse an empty string&quot;);</a>
<a name="ln2817"> </a>
<a name="ln2818">        } else if (last_error-&gt;code != XML_ERR_DOCUMENT_END) {</a>
<a name="ln2819">            crm_err(&quot;Couldn't%s parse %d chars: %s&quot;, xml ? &quot; fully&quot; : &quot;&quot;, (int)strlen(input),</a>
<a name="ln2820">                    input);</a>
<a name="ln2821">            if (xml != NULL) {</a>
<a name="ln2822">                crm_log_xml_err(xml, &quot;Partial&quot;);</a>
<a name="ln2823">            }</a>
<a name="ln2824"> </a>
<a name="ln2825">        } else {</a>
<a name="ln2826">            int len = strlen(input);</a>
<a name="ln2827">            int lpc = 0;</a>
<a name="ln2828"> </a>
<a name="ln2829">            while(lpc &lt; len) {</a>
<a name="ln2830">                crm_warn(&quot;Parse error[+%.3d]: %.80s&quot;, lpc, input+lpc);</a>
<a name="ln2831">                lpc += 80;</a>
<a name="ln2832">            }</a>
<a name="ln2833"> </a>
<a name="ln2834">            CRM_LOG_ASSERT(&quot;String parsing error&quot;);</a>
<a name="ln2835">        }</a>
<a name="ln2836">    }</a>
<a name="ln2837"> </a>
<a name="ln2838">    xmlFreeParserCtxt(ctxt);</a>
<a name="ln2839">    return xml;</a>
<a name="ln2840">}</a>
<a name="ln2841"> </a>
<a name="ln2842">xmlNode *</a>
<a name="ln2843">stdin2xml(void)</a>
<a name="ln2844">{</a>
<a name="ln2845">    size_t data_length = 0;</a>
<a name="ln2846">    size_t read_chars = 0;</a>
<a name="ln2847"> </a>
<a name="ln2848">    char *xml_buffer = NULL;</a>
<a name="ln2849">    xmlNode *xml_obj = NULL;</a>
<a name="ln2850"> </a>
<a name="ln2851">    do {</a>
<a name="ln2852">        size_t next = XML_BUFFER_SIZE + data_length + 1;</a>
<a name="ln2853"> </a>
<a name="ln2854">        if(next &lt;= 0) {</a>
<a name="ln2855">            crm_err(&quot;Buffer size exceeded at: %l + %d&quot;, data_length, XML_BUFFER_SIZE);</a>
<a name="ln2856">            break;</a>
<a name="ln2857">        }</a>
<a name="ln2858"> </a>
<a name="ln2859">        xml_buffer = realloc_safe(xml_buffer, next);</a>
<a name="ln2860">        read_chars = fread(xml_buffer + data_length, 1, XML_BUFFER_SIZE, stdin);</a>
<a name="ln2861">        data_length += read_chars;</a>
<a name="ln2862">    } while (read_chars &gt; 0);</a>
<a name="ln2863"> </a>
<a name="ln2864">    if (data_length == 0) {</a>
<a name="ln2865">        crm_warn(&quot;No XML supplied on stdin&quot;);</a>
<a name="ln2866">        free(xml_buffer);</a>
<a name="ln2867">        return NULL;</a>
<a name="ln2868">    }</a>
<a name="ln2869"> </a>
<a name="ln2870">    xml_buffer[data_length] = '\0';</a>
<a name="ln2871"> </a>
<a name="ln2872">    xml_obj = string2xml(xml_buffer);</a>
<a name="ln2873">    free(xml_buffer);</a>
<a name="ln2874"> </a>
<a name="ln2875">    crm_log_xml_trace(xml_obj, &quot;Created fragment&quot;);</a>
<a name="ln2876">    return xml_obj;</a>
<a name="ln2877">}</a>
<a name="ln2878"> </a>
<a name="ln2879">static char *</a>
<a name="ln2880">decompress_file(const char *filename)</a>
<a name="ln2881">{</a>
<a name="ln2882">    char *buffer = NULL;</a>
<a name="ln2883"> </a>
<a name="ln2884">#if HAVE_BZLIB_H</a>
<a name="ln2885">    int rc = 0;</a>
<a name="ln2886">    size_t length = 0, read_len = 0;</a>
<a name="ln2887"> </a>
<a name="ln2888">    BZFILE *bz_file = NULL;</a>
<a name="ln2889">    FILE *input = fopen(filename, &quot;r&quot;);</a>
<a name="ln2890"> </a>
<a name="ln2891">    if (input == NULL) {</a>
<a name="ln2892">        crm_perror(LOG_ERR, &quot;Could not open %s for reading&quot;, filename);</a>
<a name="ln2893">        return NULL;</a>
<a name="ln2894">    }</a>
<a name="ln2895"> </a>
<a name="ln2896">    bz_file = BZ2_bzReadOpen(&amp;rc, input, 0, 0, NULL, 0);</a>
<a name="ln2897"> </a>
<a name="ln2898">    if (rc != BZ_OK) {</a>
<a name="ln2899">        BZ2_bzReadClose(&amp;rc, bz_file);</a>
<a name="ln2900">        return NULL;</a>
<a name="ln2901">    }</a>
<a name="ln2902"> </a>
<a name="ln2903">    rc = BZ_OK;</a>
<a name="ln2904">    while (rc == BZ_OK) {</a>
<a name="ln2905">        buffer = realloc_safe(buffer, XML_BUFFER_SIZE + length + 1);</a>
<a name="ln2906">        read_len = BZ2_bzRead(&amp;rc, bz_file, buffer + length, XML_BUFFER_SIZE);</a>
<a name="ln2907"> </a>
<a name="ln2908">        crm_trace(&quot;Read %ld bytes from file: %d&quot;, (long)read_len, rc);</a>
<a name="ln2909"> </a>
<a name="ln2910">        if (rc == BZ_OK || rc == BZ_STREAM_END) {</a>
<a name="ln2911">            length += read_len;</a>
<a name="ln2912">        }</a>
<a name="ln2913">    }</a>
<a name="ln2914"> </a>
<a name="ln2915">    buffer[length] = '\0';</a>
<a name="ln2916"> </a>
<a name="ln2917">    if (rc != BZ_STREAM_END) {</a>
<a name="ln2918">        crm_err(&quot;Couldn't read compressed xml from file&quot;);</a>
<a name="ln2919">        free(buffer);</a>
<a name="ln2920">        buffer = NULL;</a>
<a name="ln2921">    }</a>
<a name="ln2922"> </a>
<a name="ln2923">    BZ2_bzReadClose(&amp;rc, bz_file);</a>
<a name="ln2924">    fclose(input);</a>
<a name="ln2925"> </a>
<a name="ln2926">#else</a>
<a name="ln2927">    crm_err(&quot;Cannot read compressed files:&quot; &quot; bzlib was not available at compile time&quot;);</a>
<a name="ln2928">#endif</a>
<a name="ln2929">    return buffer;</a>
<a name="ln2930">}</a>
<a name="ln2931"> </a>
<a name="ln2932">void</a>
<a name="ln2933">strip_text_nodes(xmlNode * xml)</a>
<a name="ln2934">{</a>
<a name="ln2935">    xmlNode *iter = xml-&gt;children;</a>
<a name="ln2936"> </a>
<a name="ln2937">    while (iter) {</a>
<a name="ln2938">        xmlNode *next = iter-&gt;next;</a>
<a name="ln2939"> </a>
<a name="ln2940">        switch (iter-&gt;type) {</a>
<a name="ln2941">            case XML_TEXT_NODE:</a>
<a name="ln2942">                /* Remove it */</a>
<a name="ln2943">                xmlUnlinkNode(iter);</a>
<a name="ln2944">                xmlFreeNode(iter);</a>
<a name="ln2945">                break;</a>
<a name="ln2946"> </a>
<a name="ln2947">            case XML_ELEMENT_NODE:</a>
<a name="ln2948">                /* Search it */</a>
<a name="ln2949">                strip_text_nodes(iter);</a>
<a name="ln2950">                break;</a>
<a name="ln2951"> </a>
<a name="ln2952">            default:</a>
<a name="ln2953">                /* Leave it */</a>
<a name="ln2954">                break;</a>
<a name="ln2955">        }</a>
<a name="ln2956"> </a>
<a name="ln2957">        iter = next;</a>
<a name="ln2958">    }</a>
<a name="ln2959">}</a>
<a name="ln2960"> </a>
<a name="ln2961">xmlNode *</a>
<a name="ln2962">filename2xml(const char *filename)</a>
<a name="ln2963">{</a>
<a name="ln2964">    xmlNode *xml = NULL;</a>
<a name="ln2965">    xmlDocPtr output = NULL;</a>
<a name="ln2966">    gboolean uncompressed = TRUE;</a>
<a name="ln2967">    xmlParserCtxtPtr ctxt = NULL;</a>
<a name="ln2968">    xmlErrorPtr last_error = NULL;</a>
<a name="ln2969">    static int xml_options = XML_PARSE_NOBLANKS | XML_PARSE_RECOVER;</a>
<a name="ln2970"> </a>
<a name="ln2971">    /* create a parser context */</a>
<a name="ln2972">    ctxt = xmlNewParserCtxt();</a>
<a name="ln2973">    CRM_CHECK(ctxt != NULL, return NULL);</a>
<a name="ln2974"> </a>
<a name="ln2975">    /* xmlCtxtUseOptions(ctxt, XML_PARSE_NOBLANKS|XML_PARSE_RECOVER); */</a>
<a name="ln2976"> </a>
<a name="ln2977">    xmlCtxtResetLastError(ctxt);</a>
<a name="ln2978">    xmlSetGenericErrorFunc(ctxt, crm_xml_err);</a>
<a name="ln2979">    /* initGenericErrorDefaultFunc(crm_xml_err); */</a>
<a name="ln2980"> </a>
<a name="ln2981">    if (filename) {</a>
<a name="ln2982">        uncompressed = !crm_ends_with(filename, &quot;.bz2&quot;);</a>
<a name="ln2983">    }</a>
<a name="ln2984"> </a>
<a name="ln2985">    if (filename == NULL) {</a>
<a name="ln2986">        /* STDIN_FILENO == fileno(stdin) */</a>
<a name="ln2987">        output = xmlCtxtReadFd(ctxt, STDIN_FILENO, &quot;unknown.xml&quot;, NULL, xml_options);</a>
<a name="ln2988"> </a>
<a name="ln2989">    } else if (uncompressed) {</a>
<a name="ln2990">        output = xmlCtxtReadFile(ctxt, filename, NULL, xml_options);</a>
<a name="ln2991"> </a>
<a name="ln2992">    } else {</a>
<a name="ln2993">        char *input = decompress_file(filename);</a>
<a name="ln2994"> </a>
<a name="ln2995">        output = xmlCtxtReadDoc(ctxt, (const xmlChar *)input, NULL, NULL, xml_options);</a>
<a name="ln2996">        free(input);</a>
<a name="ln2997">    }</a>
<a name="ln2998"> </a>
<a name="ln2999">    if (output &amp;&amp; (xml = xmlDocGetRootElement(output))) {</a>
<a name="ln3000">        strip_text_nodes(xml);</a>
<a name="ln3001">    }</a>
<a name="ln3002"> </a>
<a name="ln3003">    last_error = xmlCtxtGetLastError(ctxt);</a>
<a name="ln3004">    if (last_error &amp;&amp; last_error-&gt;code != XML_ERR_OK) {</a>
<a name="ln3005">        /* crm_abort(__FILE__,__FUNCTION__,__LINE__, &quot;last_error-&gt;code != XML_ERR_OK&quot;, TRUE, TRUE); */</a>
<a name="ln3006">        /*</a>
<a name="ln3007">         * http://xmlsoft.org/html/libxml-xmlerror.html#xmlErrorLevel</a>
<a name="ln3008">         * http://xmlsoft.org/html/libxml-xmlerror.html#xmlParserErrors</a>
<a name="ln3009">         */</a>
<a name="ln3010">        crm_err(&quot;Parsing failed (domain=%d, level=%d, code=%d): %s&quot;,</a>
<a name="ln3011">                last_error-&gt;domain, last_error-&gt;level, last_error-&gt;code, last_error-&gt;message);</a>
<a name="ln3012"> </a>
<a name="ln3013">        if (last_error &amp;&amp; last_error-&gt;code != XML_ERR_OK) {</a>
<a name="ln3014">            crm_err(&quot;Couldn't%s parse %s&quot;, xml ? &quot; fully&quot; : &quot;&quot;, filename);</a>
<a name="ln3015">            if (xml != NULL) {</a>
<a name="ln3016">                crm_log_xml_err(xml, &quot;Partial&quot;);</a>
<a name="ln3017">            }</a>
<a name="ln3018">        }</a>
<a name="ln3019">    }</a>
<a name="ln3020"> </a>
<a name="ln3021">    xmlFreeParserCtxt(ctxt);</a>
<a name="ln3022">    return xml;</a>
<a name="ln3023">}</a>
<a name="ln3024"> </a>
<a name="ln3025">/*!</a>
<a name="ln3026"> * \internal</a>
<a name="ln3027"> * \brief Add a &quot;last written&quot; attribute to an XML node, set to current time</a>
<a name="ln3028"> *</a>
<a name="ln3029"> * \param[in] xml_node XML node to get attribute</a>
<a name="ln3030"> *</a>
<a name="ln3031"> * \return Value that was set, or NULL on error</a>
<a name="ln3032"> */</a>
<a name="ln3033">const char *</a>
<a name="ln3034">crm_xml_add_last_written(xmlNode *xml_node)</a>
<a name="ln3035">{</a>
<a name="ln3036">    time_t now = time(NULL);</a>
<a name="ln3037">    char *now_str = ctime(&amp;now);</a>
<a name="ln3038"> </a>
<a name="ln3039">    now_str[24] = EOS; /* replace the newline */</a>
<a name="ln3040">    return crm_xml_add(xml_node, XML_CIB_ATTR_WRITTEN, now_str);</a>
<a name="ln3041">}</a>
<a name="ln3042"> </a>
<a name="ln3043">/*!</a>
<a name="ln3044"> * \brief Sanitize a string so it is usable as an XML ID</a>
<a name="ln3045"> *</a>
<a name="ln3046"> * \param[in,out] id  String to sanitize</a>
<a name="ln3047"> */</a>
<a name="ln3048">void</a>
<a name="ln3049">crm_xml_sanitize_id(char *id)</a>
<a name="ln3050">{</a>
<a name="ln3051">    char *c;</a>
<a name="ln3052"> </a>
<a name="ln3053">    for (c = id; *c; ++c) {</a>
<a name="ln3054">        /* @TODO Sanitize more comprehensively */</a>
<a name="ln3055">        switch (*c) {</a>
<a name="ln3056">            case ':':</a>
<a name="ln3057">            case '#':</a>
<a name="ln3058">                *c = '.';</a>
<a name="ln3059">        }</a>
<a name="ln3060">    }</a>
<a name="ln3061">}</a>
<a name="ln3062"> </a>
<a name="ln3063">/*!</a>
<a name="ln3064"> * \brief Set the ID of an XML element using a format</a>
<a name="ln3065"> *</a>
<a name="ln3066"> * \param[in,out] xml  XML element</a>
<a name="ln3067"> * \param[in]     fmt  printf-style format</a>
<a name="ln3068"> * \param[in]     ...  any arguments required by format</a>
<a name="ln3069"> */</a>
<a name="ln3070">void</a>
<a name="ln3071">crm_xml_set_id(xmlNode *xml, const char *format, ...)</a>
<a name="ln3072">{</a>
<a name="ln3073">    va_list ap;</a>
<a name="ln3074">    int len = 0;</a>
<a name="ln3075">    char *id = NULL;</a>
<a name="ln3076"> </a>
<a name="ln3077">    /* equivalent to crm_strdup_printf() */</a>
<a name="ln3078">    va_start(ap, format);</a>
<a name="ln3079">    len = vasprintf(&amp;id, format, ap);</a>
<a name="ln3080">    va_end(ap);</a>
<a name="ln3081">    CRM_ASSERT(len &gt; 0);</a>
<a name="ln3082"> </a>
<a name="ln3083">    crm_xml_sanitize_id(id);</a>
<a name="ln3084">    crm_xml_add(xml, XML_ATTR_ID, id);</a>
<a name="ln3085">    free(id);</a>
<a name="ln3086">}</a>
<a name="ln3087"> </a>
<a name="ln3088">static int</a>
<a name="ln3089">write_xml_stream(xmlNode * xml_node, const char *filename, FILE * stream, gboolean compress)</a>
<a name="ln3090">{</a>
<a name="ln3091">    int res = 0;</a>
<a name="ln3092">    char *buffer = NULL;</a>
<a name="ln3093">    unsigned int out = 0;</a>
<a name="ln3094"> </a>
<a name="ln3095">    CRM_CHECK(stream != NULL, return -1);</a>
<a name="ln3096"> </a>
<a name="ln3097">    crm_trace(&quot;Writing XML out to %s&quot;, filename);</a>
<a name="ln3098">    if (xml_node == NULL) {</a>
<a name="ln3099">        crm_err(&quot;Cannot write NULL to %s&quot;, filename);</a>
<a name="ln3100">        fclose(stream);</a>
<a name="ln3101">        return -1;</a>
<a name="ln3102">    }</a>
<a name="ln3103"> </a>
<a name="ln3104"> </a>
<a name="ln3105">    crm_log_xml_trace(xml_node, &quot;Writing out&quot;);</a>
<a name="ln3106"> </a>
<a name="ln3107">    buffer = dump_xml_formatted(xml_node);</a>
<a name="ln3108">    CRM_CHECK(buffer != NULL &amp;&amp; strlen(buffer) &gt; 0, crm_log_xml_warn(xml_node, &quot;dump:failed&quot;);</a>
<a name="ln3109">              goto bail);</a>
<a name="ln3110"> </a>
<a name="ln3111">    if (compress) {</a>
<a name="ln3112">#if HAVE_BZLIB_H</a>
<a name="ln3113">        int rc = BZ_OK;</a>
<a name="ln3114">        unsigned int in = 0;</a>
<a name="ln3115">        BZFILE *bz_file = NULL;</a>
<a name="ln3116"> </a>
<a name="ln3117">        bz_file = BZ2_bzWriteOpen(&amp;rc, stream, 5, 0, 30);</a>
<a name="ln3118">        if (rc != BZ_OK) {</a>
<a name="ln3119">            crm_err(&quot;bzWriteOpen failed: %d&quot;, rc);</a>
<a name="ln3120">        } else {</a>
<a name="ln3121">            BZ2_bzWrite(&amp;rc, bz_file, buffer, strlen(buffer));</a>
<a name="ln3122">            if (rc != BZ_OK) {</a>
<a name="ln3123">                crm_err(&quot;bzWrite() failed: %d&quot;, rc);</a>
<a name="ln3124">            }</a>
<a name="ln3125">        }</a>
<a name="ln3126"> </a>
<a name="ln3127">        if (rc == BZ_OK) {</a>
<a name="ln3128">            BZ2_bzWriteClose(&amp;rc, bz_file, 0, &amp;in, &amp;out);</a>
<a name="ln3129">            if (rc != BZ_OK) {</a>
<a name="ln3130">                crm_err(&quot;bzWriteClose() failed: %d&quot;, rc);</a>
<a name="ln3131">                out = -1;</a>
<a name="ln3132">            } else {</a>
<a name="ln3133">                crm_trace(&quot;%s: In: %d, out: %d&quot;, filename, in, out);</a>
<a name="ln3134">            }</a>
<a name="ln3135">        }</a>
<a name="ln3136">#else</a>
<a name="ln3137">        crm_err(&quot;Cannot write compressed files:&quot; &quot; bzlib was not available at compile time&quot;);</a>
<a name="ln3138">#endif</a>
<a name="ln3139">    }</a>
<a name="ln3140"> </a>
<a name="ln3141">    if (out &lt;= 0) {</a>
<a name="ln3142">        res = fprintf(stream, &quot;%s&quot;, buffer);</a>
<a name="ln3143">        if (res &lt; 0) {</a>
<a name="ln3144">            crm_perror(LOG_ERR, &quot;Cannot write output to %s&quot;, filename);</a>
<a name="ln3145">            goto bail;</a>
<a name="ln3146">        }</a>
<a name="ln3147">    }</a>
<a name="ln3148"> </a>
<a name="ln3149">  bail:</a>
<a name="ln3150"> </a>
<a name="ln3151">    if (fflush(stream) != 0) {</a>
<a name="ln3152">        crm_perror(LOG_ERR, &quot;fflush for %s failed&quot;, filename);</a>
<a name="ln3153">        res = -1;</a>
<a name="ln3154">    }</a>
<a name="ln3155"> </a>
<a name="ln3156">    /* Don't report error if the file does not support synchronization */</a>
<a name="ln3157">    if (fsync(fileno(stream)) &lt; 0 &amp;&amp; errno != EROFS  &amp;&amp; errno != EINVAL) {</a>
<a name="ln3158">        crm_perror(LOG_ERR, &quot;fsync for %s failed&quot;, filename);</a>
<a name="ln3159">        res = -1;</a>
<a name="ln3160">    }</a>
<a name="ln3161"> </a>
<a name="ln3162">    fclose(stream);</a>
<a name="ln3163"> </a>
<a name="ln3164">    crm_trace(&quot;Saved %d bytes to the Cib as XML&quot;, res);</a>
<a name="ln3165">    free(buffer);</a>
<a name="ln3166"> </a>
<a name="ln3167">    return res;</a>
<a name="ln3168">}</a>
<a name="ln3169"> </a>
<a name="ln3170">int</a>
<a name="ln3171">write_xml_fd(xmlNode * xml_node, const char *filename, int fd, gboolean compress)</a>
<a name="ln3172">{</a>
<a name="ln3173">    FILE *stream = NULL;</a>
<a name="ln3174"> </a>
<a name="ln3175">    CRM_CHECK(fd &gt; 0, return -1);</a>
<a name="ln3176">    stream = fdopen(fd, &quot;w&quot;);</a>
<a name="ln3177">    return write_xml_stream(xml_node, filename, stream, compress);</a>
<a name="ln3178">}</a>
<a name="ln3179"> </a>
<a name="ln3180">int</a>
<a name="ln3181">write_xml_file(xmlNode * xml_node, const char *filename, gboolean compress)</a>
<a name="ln3182">{</a>
<a name="ln3183">    FILE *stream = NULL;</a>
<a name="ln3184"> </a>
<a name="ln3185">    stream = fopen(filename, &quot;w&quot;);</a>
<a name="ln3186"> </a>
<a name="ln3187">    return write_xml_stream(xml_node, filename, stream, compress);</a>
<a name="ln3188">}</a>
<a name="ln3189"> </a>
<a name="ln3190">xmlNode *</a>
<a name="ln3191">get_message_xml(xmlNode * msg, const char *field)</a>
<a name="ln3192">{</a>
<a name="ln3193">    xmlNode *tmp = first_named_child(msg, field);</a>
<a name="ln3194"> </a>
<a name="ln3195">    return __xml_first_child(tmp);</a>
<a name="ln3196">}</a>
<a name="ln3197"> </a>
<a name="ln3198">gboolean</a>
<a name="ln3199">add_message_xml(xmlNode * msg, const char *field, xmlNode * xml)</a>
<a name="ln3200">{</a>
<a name="ln3201">    xmlNode *holder = create_xml_node(msg, field);</a>
<a name="ln3202"> </a>
<a name="ln3203">    add_node_copy(holder, xml);</a>
<a name="ln3204">    return TRUE;</a>
<a name="ln3205">}</a>
<a name="ln3206"> </a>
<a name="ln3207">static char *</a>
<a name="ln3208">crm_xml_escape_shuffle(char *text, int start, int *length, const char *replace)</a>
<a name="ln3209">{</a>
<a name="ln3210">    int lpc;</a>
<a name="ln3211">    int offset = strlen(replace) - 1;   /* We have space for 1 char already */</a>
<a name="ln3212"> </a>
<a name="ln3213">    *length += offset;</a>
<a name="ln3214">    text = realloc_safe(text, *length);</a>
<a name="ln3215"> </a>
<a name="ln3216">    for (lpc = (*length) - 1; lpc &gt; (start + offset); lpc--) {</a>
<a name="ln3217">        text[lpc] = text[lpc - offset];</a>
<a name="ln3218">    }</a>
<a name="ln3219"> </a>
<a name="ln3220">    memcpy(text + start, replace, offset + 1);</a>
<a name="ln3221">    return text;</a>
<a name="ln3222">}</a>
<a name="ln3223"> </a>
<a name="ln3224">char *</a>
<a name="ln3225">crm_xml_escape(const char *text)</a>
<a name="ln3226">{</a>
<a name="ln3227">    int index;</a>
<a name="ln3228">    int changes = 0;</a>
<a name="ln3229">    int length = 1 + strlen(text);</a>
<a name="ln3230">    char *copy = strdup(text);</a>
<a name="ln3231"> </a>
<a name="ln3232">    /*</a>
<a name="ln3233">     * When xmlCtxtReadDoc() parses &amp;lt; and friends in a</a>
<a name="ln3234">     * value, it converts them to their human readable</a>
<a name="ln3235">     * form.</a>
<a name="ln3236">     *</a>
<a name="ln3237">     * If one uses xmlNodeDump() to convert it back to a</a>
<a name="ln3238">     * string, all is well, because special characters are</a>
<a name="ln3239">     * converted back to their escape sequences.</a>
<a name="ln3240">     *</a>
<a name="ln3241">     * However xmlNodeDump() is randomly dog slow, even with the same</a>
<a name="ln3242">     * input. So we need to replicate the escaping in our custom</a>
<a name="ln3243">     * version so that the result can be re-parsed by xmlCtxtReadDoc()</a>
<a name="ln3244">     * when necessary.</a>
<a name="ln3245">     */</a>
<a name="ln3246"> </a>
<a name="ln3247">    for (index = 0; index &lt; length; index++) {</a>
<a name="ln3248">        switch (copy[index]) {</a>
<a name="ln3249">            case 0:</a>
<a name="ln3250">                break;</a>
<a name="ln3251">            case '&lt;':</a>
<a name="ln3252">                copy = crm_xml_escape_shuffle(copy, index, &amp;length, &quot;&amp;lt;&quot;);</a>
<a name="ln3253">                changes++;</a>
<a name="ln3254">                break;</a>
<a name="ln3255">            case '&gt;':</a>
<a name="ln3256">                copy = crm_xml_escape_shuffle(copy, index, &amp;length, &quot;&amp;gt;&quot;);</a>
<a name="ln3257">                changes++;</a>
<a name="ln3258">                break;</a>
<a name="ln3259">            case '&quot;':</a>
<a name="ln3260">                copy = crm_xml_escape_shuffle(copy, index, &amp;length, &quot;&amp;quot;&quot;);</a>
<a name="ln3261">                changes++;</a>
<a name="ln3262">                break;</a>
<a name="ln3263">            case '\'':</a>
<a name="ln3264">                copy = crm_xml_escape_shuffle(copy, index, &amp;length, &quot;&amp;apos;&quot;);</a>
<a name="ln3265">                changes++;</a>
<a name="ln3266">                break;</a>
<a name="ln3267">            case '&amp;':</a>
<a name="ln3268">                copy = crm_xml_escape_shuffle(copy, index, &amp;length, &quot;&amp;amp;&quot;);</a>
<a name="ln3269">                changes++;</a>
<a name="ln3270">                break;</a>
<a name="ln3271">            case '\t':</a>
<a name="ln3272">                /* Might as well just expand to a few spaces... */</a>
<a name="ln3273">                copy = crm_xml_escape_shuffle(copy, index, &amp;length, &quot;    &quot;);</a>
<a name="ln3274">                changes++;</a>
<a name="ln3275">                break;</a>
<a name="ln3276">            case '\n':</a>
<a name="ln3277">                /* crm_trace(&quot;Convert: \\%.3o&quot;, copy[index]); */</a>
<a name="ln3278">                copy = crm_xml_escape_shuffle(copy, index, &amp;length, &quot;\\n&quot;);</a>
<a name="ln3279">                changes++;</a>
<a name="ln3280">                break;</a>
<a name="ln3281">            case '\r':</a>
<a name="ln3282">                copy = crm_xml_escape_shuffle(copy, index, &amp;length, &quot;\\r&quot;);</a>
<a name="ln3283">                changes++;</a>
<a name="ln3284">                break;</a>
<a name="ln3285">                /* For debugging...</a>
<a name="ln3286">            case '\\':</a>
<a name="ln3287">                crm_trace(&quot;Passthrough: \\%c&quot;, copy[index+1]);</a>
<a name="ln3288">                break;</a>
<a name="ln3289">                */</a>
<a name="ln3290">            default:</a>
<a name="ln3291">                /* Check for and replace non-printing characters with their octal equivalent */</a>
<a name="ln3292">                if(copy[index] &lt; ' ' || copy[index] &gt; '~') {</a>
<a name="ln3293">                    char *replace = crm_strdup_printf(&quot;\\%.3o&quot;, copy[index]);</a>
<a name="ln3294"> </a>
<a name="ln3295">                    /* crm_trace(&quot;Convert to octal: \\%.3o&quot;, copy[index]); */</a>
<a name="ln3296">                    copy = crm_xml_escape_shuffle(copy, index, &amp;length, replace);</a>
<a name="ln3297">                    free(replace);</a>
<a name="ln3298">                    changes++;</a>
<a name="ln3299">                }</a>
<a name="ln3300">        }</a>
<a name="ln3301">    }</a>
<a name="ln3302"> </a>
<a name="ln3303">    if (changes) {</a>
<a name="ln3304">        crm_trace(&quot;Dumped '%s'&quot;, copy);</a>
<a name="ln3305">    }</a>
<a name="ln3306">    return copy;</a>
<a name="ln3307">}</a>
<a name="ln3308"> </a>
<a name="ln3309">static inline void</a>
<a name="ln3310">dump_xml_attr(xmlAttrPtr attr, int options, char **buffer, int *offset, int *max)</a>
<a name="ln3311">{</a>
<a name="ln3312">    char *p_value = NULL;</a>
<a name="ln3313">    const char *p_name = NULL;</a>
<a name="ln3314">    xml_private_t *p = NULL;</a>
<a name="ln3315"> </a>
<a name="ln3316">    CRM_ASSERT(buffer != NULL);</a>
<a name="ln3317">    if (attr == NULL || attr-&gt;children == NULL) {</a>
<a name="ln3318">        return;</a>
<a name="ln3319">    }</a>
<a name="ln3320"> </a>
<a name="ln3321">    p = attr-&gt;_private;</a>
<a name="ln3322">    if (p &amp;&amp; is_set(p-&gt;flags, xpf_deleted)) {</a>
<a name="ln3323">        return;</a>
<a name="ln3324">    }</a>
<a name="ln3325"> </a>
<a name="ln3326">    p_name = (const char *)attr-&gt;name;</a>
<a name="ln3327">    p_value = crm_xml_escape((const char *)attr-&gt;children-&gt;content);</a>
<a name="ln3328">    buffer_print(*buffer, *max, *offset, &quot; %s=\&quot;%s\&quot;&quot;, p_name, p_value);</a>
<a name="ln3329">    free(p_value);</a>
<a name="ln3330">}</a>
<a name="ln3331"> </a>
<a name="ln3332">static void</a>
<a name="ln3333">__xml_log_element(int log_level, const char *file, const char *function, int line,</a>
<a name="ln3334">                  const char *prefix, xmlNode * data, int depth, int options)</a>
<a name="ln3335">{</a>
<a name="ln3336">    int max = 0;</a>
<a name="ln3337">    int offset = 0;</a>
<a name="ln3338">    const char *name = NULL;</a>
<a name="ln3339">    const char *hidden = NULL;</a>
<a name="ln3340"> </a>
<a name="ln3341">    xmlNode *child = NULL;</a>
<a name="ln3342">    xmlAttrPtr pIter = NULL;</a>
<a name="ln3343"> </a>
<a name="ln3344">    if(data == NULL) {</a>
<a name="ln3345">        return;</a>
<a name="ln3346">    }</a>
<a name="ln3347"> </a>
<a name="ln3348">    name = crm_element_name(data);</a>
<a name="ln3349"> </a>
<a name="ln3350">    if(is_set(options, xml_log_option_open)) {</a>
<a name="ln3351">        char *buffer = NULL;</a>
<a name="ln3352"> </a>
<a name="ln3353">        insert_prefix(options, &amp;buffer, &amp;offset, &amp;max, depth);</a>
<a name="ln3354"> </a>
<a name="ln3355">        if (data-&gt;type == XML_COMMENT_NODE) {</a>
<a name="ln3356">            buffer_print(buffer, max, offset, &quot;&lt;!--%s--&gt;&quot;, data-&gt;content);</a>
<a name="ln3357"> </a>
<a name="ln3358">        } else {</a>
<a name="ln3359">            buffer_print(buffer, max, offset, &quot;&lt;%s&quot;, name);</a>
<a name="ln3360"> </a>
<a name="ln3361">            hidden = crm_element_value(data, &quot;hidden&quot;);</a>
<a name="ln3362">            for (pIter = crm_first_attr(data); pIter != NULL; pIter = pIter-&gt;next) {</a>
<a name="ln3363">                xml_private_t *p = pIter-&gt;_private;</a>
<a name="ln3364">                const char *p_name = (const char *)pIter-&gt;name;</a>
<a name="ln3365">                const char *p_value = crm_attr_value(pIter);</a>
<a name="ln3366">                char *p_copy = NULL;</a>
<a name="ln3367"> </a>
<a name="ln3368">                if(is_set(p-&gt;flags, xpf_deleted)) {</a>
<a name="ln3369">                    continue;</a>
<a name="ln3370">                } else if ((is_set(options, xml_log_option_diff_plus)</a>
<a name="ln3371">                     || is_set(options, xml_log_option_diff_minus))</a>
<a name="ln3372">                    &amp;&amp; strcmp(XML_DIFF_MARKER, p_name) == 0) {</a>
<a name="ln3373">                    continue;</a>
<a name="ln3374"> </a>
<a name="ln3375">                } else if (hidden != NULL &amp;&amp; p_name[0] != 0 &amp;&amp; strstr(hidden, p_name) != NULL) {</a>
<a name="ln3376">                    p_copy = strdup(&quot;*****&quot;);</a>
<a name="ln3377"> </a>
<a name="ln3378">                } else {</a>
<a name="ln3379">                    p_copy = crm_xml_escape(p_value);</a>
<a name="ln3380">                }</a>
<a name="ln3381"> </a>
<a name="ln3382">                buffer_print(buffer, max, offset, &quot; %s=\&quot;%s\&quot;&quot;, p_name, p_copy);</a>
<a name="ln3383">                free(p_copy);</a>
<a name="ln3384">            }</a>
<a name="ln3385"> </a>
<a name="ln3386">            if(xml_has_children(data) == FALSE) {</a>
<a name="ln3387">                buffer_print(buffer, max, offset, &quot;/&gt;&quot;);</a>
<a name="ln3388"> </a>
<a name="ln3389">            } else if(is_set(options, xml_log_option_children)) {</a>
<a name="ln3390">                buffer_print(buffer, max, offset, &quot;&gt;&quot;);</a>
<a name="ln3391"> </a>
<a name="ln3392">            } else {</a>
<a name="ln3393">                buffer_print(buffer, max, offset, &quot;/&gt;&quot;);</a>
<a name="ln3394">            }</a>
<a name="ln3395">        }</a>
<a name="ln3396"> </a>
<a name="ln3397">        do_crm_log_alias(log_level, file, function, line, &quot;%s %s&quot;, prefix, buffer);</a>
<a name="ln3398">        free(buffer);</a>
<a name="ln3399">    }</a>
<a name="ln3400"> </a>
<a name="ln3401">    if(data-&gt;type == XML_COMMENT_NODE) {</a>
<a name="ln3402">        return;</a>
<a name="ln3403"> </a>
<a name="ln3404">    } else if(xml_has_children(data) == FALSE) {</a>
<a name="ln3405">        return;</a>
<a name="ln3406"> </a>
<a name="ln3407">    } else if(is_set(options, xml_log_option_children)) {</a>
<a name="ln3408">        offset = 0;</a>
<a name="ln3409">        max = 0;</a>
<a name="ln3410"> </a>
<a name="ln3411">        for (child = __xml_first_child(data); child != NULL; child = __xml_next(child)) {</a>
<a name="ln3412">            __xml_log_element(log_level, file, function, line, prefix, child, depth + 1, options|xml_log_option_open|xml_log_option_close);</a>
<a name="ln3413">        }</a>
<a name="ln3414">    }</a>
<a name="ln3415"> </a>
<a name="ln3416">    if(is_set(options, xml_log_option_close)) {</a>
<a name="ln3417">        char *buffer = NULL;</a>
<a name="ln3418"> </a>
<a name="ln3419">        insert_prefix(options, &amp;buffer, &amp;offset, &amp;max, depth);</a>
<a name="ln3420">        buffer_print(buffer, max, offset, &quot;&lt;/%s&gt;&quot;, name);</a>
<a name="ln3421"> </a>
<a name="ln3422">        do_crm_log_alias(log_level, file, function, line, &quot;%s %s&quot;, prefix, buffer);</a>
<a name="ln3423">        free(buffer);</a>
<a name="ln3424">    }</a>
<a name="ln3425">}</a>
<a name="ln3426"> </a>
<a name="ln3427">static void</a>
<a name="ln3428">__xml_log_change_element(int log_level, const char *file, const char *function, int line,</a>
<a name="ln3429">                         const char *prefix, xmlNode * data, int depth, int options)</a>
<a name="ln3430">{</a>
<a name="ln3431">    xml_private_t *p;</a>
<a name="ln3432">    char *prefix_m = NULL;</a>
<a name="ln3433">    xmlNode *child = NULL;</a>
<a name="ln3434">    xmlAttrPtr pIter = NULL;</a>
<a name="ln3435"> </a>
<a name="ln3436">    if(data == NULL) {</a>
<a name="ln3437">        return;</a>
<a name="ln3438">    }</a>
<a name="ln3439"> </a>
<a name="ln3440">    p = data-&gt;_private;</a>
<a name="ln3441"> </a>
<a name="ln3442">    prefix_m = strdup(prefix);</a>
<a name="ln3443">    prefix_m[1] = '+';</a>
<a name="ln3444"> </a>
<a name="ln3445">    if(is_set(p-&gt;flags, xpf_dirty) &amp;&amp; is_set(p-&gt;flags, xpf_created)) {</a>
<a name="ln3446">        /* Continue and log full subtree */</a>
<a name="ln3447">        __xml_log_element(log_level, file, function, line,</a>
<a name="ln3448">                          prefix_m, data, depth, options|xml_log_option_open|xml_log_option_close|xml_log_option_children);</a>
<a name="ln3449"> </a>
<a name="ln3450">    } else if(is_set(p-&gt;flags, xpf_dirty)) {</a>
<a name="ln3451">        char *spaces = calloc(80, 1);</a>
<a name="ln3452">        int s_count = 0, s_max = 80;</a>
<a name="ln3453">        char *prefix_del = NULL;</a>
<a name="ln3454">        char *prefix_moved = NULL;</a>
<a name="ln3455">        const char *flags = prefix;</a>
<a name="ln3456"> </a>
<a name="ln3457">        insert_prefix(options, &amp;spaces, &amp;s_count, &amp;s_max, depth);</a>
<a name="ln3458">        prefix_del = strdup(prefix);</a>
<a name="ln3459">        prefix_del[0] = '-';</a>
<a name="ln3460">        prefix_del[1] = '-';</a>
<a name="ln3461">        prefix_moved = strdup(prefix);</a>
<a name="ln3462">        prefix_moved[1] = '~';</a>
<a name="ln3463"> </a>
<a name="ln3464">        if(is_set(p-&gt;flags, xpf_moved)) {</a>
<a name="ln3465">            flags = prefix_moved;</a>
<a name="ln3466">        } else {</a>
<a name="ln3467">            flags = prefix;</a>
<a name="ln3468">        }</a>
<a name="ln3469"> </a>
<a name="ln3470">        __xml_log_element(log_level, file, function, line,</a>
<a name="ln3471">                          flags, data, depth, options|xml_log_option_open);</a>
<a name="ln3472"> </a>
<a name="ln3473">        for (pIter = crm_first_attr(data); pIter != NULL; pIter = pIter-&gt;next) {</a>
<a name="ln3474">            const char *aname = (const char*)pIter-&gt;name;</a>
<a name="ln3475"> </a>
<a name="ln3476">            p = pIter-&gt;_private;</a>
<a name="ln3477">            if(is_set(p-&gt;flags, xpf_deleted)) {</a>
<a name="ln3478">                const char *value = crm_element_value(data, aname);</a>
<a name="ln3479">                flags = prefix_del;</a>
<a name="ln3480">                do_crm_log_alias(log_level, file, function, line,</a>
<a name="ln3481">                                 &quot;%s %s @%s=%s&quot;, flags, spaces, aname, value);</a>
<a name="ln3482"> </a>
<a name="ln3483">            } else if(is_set(p-&gt;flags, xpf_dirty)) {</a>
<a name="ln3484">                const char *value = crm_element_value(data, aname);</a>
<a name="ln3485"> </a>
<a name="ln3486">                if(is_set(p-&gt;flags, xpf_created)) {</a>
<a name="ln3487">                    flags = prefix_m;</a>
<a name="ln3488"> </a>
<a name="ln3489">                } else if(is_set(p-&gt;flags, xpf_modified)) {</a>
<a name="ln3490">                    flags = prefix;</a>
<a name="ln3491"> </a>
<a name="ln3492">                } else if(is_set(p-&gt;flags, xpf_moved)) {</a>
<a name="ln3493">                    flags = prefix_moved;</a>
<a name="ln3494"> </a>
<a name="ln3495">                } else {</a>
<a name="ln3496">                    flags = prefix;</a>
<a name="ln3497">                }</a>
<a name="ln3498">                do_crm_log_alias(log_level, file, function, line,</a>
<a name="ln3499">                                 &quot;%s %s @%s=%s&quot;, flags, spaces, aname, value);</a>
<a name="ln3500">            }</a>
<a name="ln3501">        }</a>
<a name="ln3502">        free(prefix_moved);</a>
<a name="ln3503">        free(prefix_del);</a>
<a name="ln3504">        free(spaces);</a>
<a name="ln3505"> </a>
<a name="ln3506">        for (child = __xml_first_child(data); child != NULL; child = __xml_next(child)) {</a>
<a name="ln3507">            __xml_log_change_element(log_level, file, function, line, prefix, child, depth + 1, options);</a>
<a name="ln3508">        }</a>
<a name="ln3509"> </a>
<a name="ln3510">        __xml_log_element(log_level, file, function, line,</a>
<a name="ln3511">                          prefix, data, depth, options|xml_log_option_close);</a>
<a name="ln3512"> </a>
<a name="ln3513">    } else {</a>
<a name="ln3514">        for (child = __xml_first_child(data); child != NULL; child = __xml_next(child)) {</a>
<a name="ln3515">            __xml_log_change_element(log_level, file, function, line, prefix, child, depth + 1, options);</a>
<a name="ln3516">        }</a>
<a name="ln3517">    }</a>
<a name="ln3518"> </a>
<a name="ln3519">    free(prefix_m);</a>
<a name="ln3520"> </a>
<a name="ln3521">}</a>
<a name="ln3522"> </a>
<a name="ln3523">void</a>
<a name="ln3524">log_data_element(int log_level, const char *file, const char *function, int line,</a>
<a name="ln3525">                 const char *prefix, xmlNode * data, int depth, int options)</a>
<a name="ln3526">{</a>
<a name="ln3527">    xmlNode *a_child = NULL;</a>
<a name="ln3528"> </a>
<a name="ln3529">    char *prefix_m = NULL;</a>
<a name="ln3530"> </a>
<a name="ln3531">    if (prefix == NULL) {</a>
<a name="ln3532">        prefix = &quot;&quot;;</a>
<a name="ln3533">    }</a>
<a name="ln3534"> </a>
<a name="ln3535">    /* Since we use the same file and line, to avoid confusing libqb, we need to use the same format strings */</a>
<a name="ln3536">    if (data == NULL) {</a>
<a name="ln3537">        do_crm_log_alias(log_level, file, function, line, &quot;%s: %s&quot;, prefix,</a>
<a name="ln3538">                         &quot;No data to dump as XML&quot;);</a>
<a name="ln3539">        return;</a>
<a name="ln3540">    }</a>
<a name="ln3541"> </a>
<a name="ln3542">    if(is_set(options, xml_log_option_dirty_add) || is_set(options, xml_log_option_dirty_add)) {</a>
<a name="ln3543">        __xml_log_change_element(log_level, file, function, line, prefix, data, depth, options);</a>
<a name="ln3544">        return;</a>
<a name="ln3545">    }</a>
<a name="ln3546"> </a>
<a name="ln3547">    if (is_set(options, xml_log_option_formatted)) {</a>
<a name="ln3548">        if (is_set(options, xml_log_option_diff_plus)</a>
<a name="ln3549">            &amp;&amp; (data-&gt;children == NULL || crm_element_value(data, XML_DIFF_MARKER))) {</a>
<a name="ln3550">            options |= xml_log_option_diff_all;</a>
<a name="ln3551">            prefix_m = strdup(prefix);</a>
<a name="ln3552">            prefix_m[1] = '+';</a>
<a name="ln3553">            prefix = prefix_m;</a>
<a name="ln3554"> </a>
<a name="ln3555">        } else if (is_set(options, xml_log_option_diff_minus)</a>
<a name="ln3556">                   &amp;&amp; (data-&gt;children == NULL || crm_element_value(data, XML_DIFF_MARKER))) {</a>
<a name="ln3557">            options |= xml_log_option_diff_all;</a>
<a name="ln3558">            prefix_m = strdup(prefix);</a>
<a name="ln3559">            prefix_m[1] = '-';</a>
<a name="ln3560">            prefix = prefix_m;</a>
<a name="ln3561">        }</a>
<a name="ln3562">    }</a>
<a name="ln3563"> </a>
<a name="ln3564">    if (is_set(options, xml_log_option_diff_short)</a>
<a name="ln3565">               &amp;&amp; is_not_set(options, xml_log_option_diff_all)) {</a>
<a name="ln3566">        /* Still searching for the actual change */</a>
<a name="ln3567">        for (a_child = __xml_first_child(data); a_child != NULL; a_child = __xml_next(a_child)) {</a>
<a name="ln3568">            log_data_element(log_level, file, function, line, prefix, a_child, depth + 1, options);</a>
<a name="ln3569">        }</a>
<a name="ln3570">    } else {</a>
<a name="ln3571">        __xml_log_element(log_level, file, function, line, prefix, data, depth,</a>
<a name="ln3572">                          options|xml_log_option_open|xml_log_option_close|xml_log_option_children);</a>
<a name="ln3573">    }</a>
<a name="ln3574">    free(prefix_m);</a>
<a name="ln3575">}</a>
<a name="ln3576"> </a>
<a name="ln3577">static void</a>
<a name="ln3578">dump_filtered_xml(xmlNode * data, int options, char **buffer, int *offset, int *max)</a>
<a name="ln3579">{</a>
<a name="ln3580">    int lpc;</a>
<a name="ln3581">    xmlAttrPtr xIter = NULL;</a>
<a name="ln3582">    static int filter_len = DIMOF(filter);</a>
<a name="ln3583"> </a>
<a name="ln3584">    for (lpc = 0; options &amp;&amp; lpc &lt; filter_len; lpc++) {</a>
<a name="ln3585">        filter[lpc].found = FALSE;</a>
<a name="ln3586">    }</a>
<a name="ln3587"> </a>
<a name="ln3588">    for (xIter = crm_first_attr(data); xIter != NULL; xIter = xIter-&gt;next) {</a>
<a name="ln3589">        bool skip = FALSE;</a>
<a name="ln3590">        const char *p_name = (const char *)xIter-&gt;name;</a>
<a name="ln3591"> </a>
<a name="ln3592">        for (lpc = 0; skip == FALSE &amp;&amp; lpc &lt; filter_len; lpc++) {</a>
<a name="ln3593">            if (filter[lpc].found == FALSE &amp;&amp; strcmp(p_name, filter[lpc].string) == 0) {</a>
<a name="ln3594">                filter[lpc].found = TRUE;</a>
<a name="ln3595">                skip = TRUE;</a>
<a name="ln3596">                break;</a>
<a name="ln3597">            }</a>
<a name="ln3598">        }</a>
<a name="ln3599"> </a>
<a name="ln3600">        if (skip == FALSE) {</a>
<a name="ln3601">            dump_xml_attr(xIter, options, buffer, offset, max);</a>
<a name="ln3602">        }</a>
<a name="ln3603">    }</a>
<a name="ln3604">}</a>
<a name="ln3605"> </a>
<a name="ln3606">static void</a>
<a name="ln3607">dump_xml_element(xmlNode * data, int options, char **buffer, int *offset, int *max, int depth)</a>
<a name="ln3608">{</a>
<a name="ln3609">    const char *name = NULL;</a>
<a name="ln3610"> </a>
<a name="ln3611">    CRM_ASSERT(max != NULL);</a>
<a name="ln3612">    CRM_ASSERT(offset != NULL);</a>
<a name="ln3613">    CRM_ASSERT(buffer != NULL);</a>
<a name="ln3614"> </a>
<a name="ln3615">    if (data == NULL) {</a>
<a name="ln3616">        crm_trace(&quot;Nothing to dump&quot;);</a>
<a name="ln3617">        return;</a>
<a name="ln3618">    }</a>
<a name="ln3619"> </a>
<a name="ln3620">    if (*buffer == NULL) {</a>
<a name="ln3621">        *offset = 0;</a>
<a name="ln3622">        *max = 0;</a>
<a name="ln3623">    }</a>
<a name="ln3624"> </a>
<a name="ln3625">    name = crm_element_name(data);</a>
<a name="ln3626">    CRM_ASSERT(name != NULL);</a>
<a name="ln3627"> </a>
<a name="ln3628">    insert_prefix(options, buffer, offset, max, depth);</a>
<a name="ln3629">    buffer_print(*buffer, *max, *offset, &quot;&lt;%s&quot;, name);</a>
<a name="ln3630"> </a>
<a name="ln3631">    if (options &amp; xml_log_option_filtered) {</a>
<a name="ln3632">        dump_filtered_xml(data, options, buffer, offset, max);</a>
<a name="ln3633"> </a>
<a name="ln3634">    } else {</a>
<a name="ln3635">        xmlAttrPtr xIter = NULL;</a>
<a name="ln3636"> </a>
<a name="ln3637">        for (xIter = crm_first_attr(data); xIter != NULL; xIter = xIter-&gt;next) {</a>
<a name="ln3638">            dump_xml_attr(xIter, options, buffer, offset, max);</a>
<a name="ln3639">        }</a>
<a name="ln3640">    }</a>
<a name="ln3641"> </a>
<a name="ln3642">    if (data-&gt;children == NULL) {</a>
<a name="ln3643">        buffer_print(*buffer, *max, *offset, &quot;/&gt;&quot;);</a>
<a name="ln3644"> </a>
<a name="ln3645">    } else {</a>
<a name="ln3646">        buffer_print(*buffer, *max, *offset, &quot;&gt;&quot;);</a>
<a name="ln3647">    }</a>
<a name="ln3648"> </a>
<a name="ln3649">    if (options &amp; xml_log_option_formatted) {</a>
<a name="ln3650">        buffer_print(*buffer, *max, *offset, &quot;\n&quot;);</a>
<a name="ln3651">    }</a>
<a name="ln3652"> </a>
<a name="ln3653">    if (data-&gt;children) {</a>
<a name="ln3654">        xmlNode *xChild = NULL;</a>
<a name="ln3655">        for(xChild = data-&gt;children; xChild != NULL; xChild = xChild-&gt;next) {</a>
<a name="ln3656">            crm_xml_dump(xChild, options, buffer, offset, max, depth + 1);</a>
<a name="ln3657">        }</a>
<a name="ln3658"> </a>
<a name="ln3659">        insert_prefix(options, buffer, offset, max, depth);</a>
<a name="ln3660">        buffer_print(*buffer, *max, *offset, &quot;&lt;/%s&gt;&quot;, name);</a>
<a name="ln3661"> </a>
<a name="ln3662">        if (options &amp; xml_log_option_formatted) {</a>
<a name="ln3663">            buffer_print(*buffer, *max, *offset, &quot;\n&quot;);</a>
<a name="ln3664">        }</a>
<a name="ln3665">    }</a>
<a name="ln3666">}</a>
<a name="ln3667"> </a>
<a name="ln3668">static void</a>
<a name="ln3669">dump_xml_text(xmlNode * data, int options, char **buffer, int *offset, int *max, int depth)</a>
<a name="ln3670">{</a>
<a name="ln3671">    CRM_ASSERT(max != NULL);</a>
<a name="ln3672">    CRM_ASSERT(offset != NULL);</a>
<a name="ln3673">    CRM_ASSERT(buffer != NULL);</a>
<a name="ln3674"> </a>
<a name="ln3675">    if (data == NULL) {</a>
<a name="ln3676">        crm_trace(&quot;Nothing to dump&quot;);</a>
<a name="ln3677">        return;</a>
<a name="ln3678">    }</a>
<a name="ln3679"> </a>
<a name="ln3680">    if (*buffer == NULL) {</a>
<a name="ln3681">        *offset = 0;</a>
<a name="ln3682">        *max = 0;</a>
<a name="ln3683">    }</a>
<a name="ln3684"> </a>
<a name="ln3685">    insert_prefix(options, buffer, offset, max, depth);</a>
<a name="ln3686"> </a>
<a name="ln3687">    buffer_print(*buffer, *max, *offset, &quot;%s&quot;, data-&gt;content);</a>
<a name="ln3688"> </a>
<a name="ln3689">    if (options &amp; xml_log_option_formatted) {</a>
<a name="ln3690">        buffer_print(*buffer, *max, *offset, &quot;\n&quot;);</a>
<a name="ln3691">    }</a>
<a name="ln3692">}</a>
<a name="ln3693"> </a>
<a name="ln3694"> </a>
<a name="ln3695">static void</a>
<a name="ln3696">dump_xml_comment(xmlNode * data, int options, char **buffer, int *offset, int *max, int depth)</a>
<a name="ln3697">{</a>
<a name="ln3698">    CRM_ASSERT(max != NULL);</a>
<a name="ln3699">    CRM_ASSERT(offset != NULL);</a>
<a name="ln3700">    CRM_ASSERT(buffer != NULL);</a>
<a name="ln3701"> </a>
<a name="ln3702">    if (data == NULL) {</a>
<a name="ln3703">        crm_trace(&quot;Nothing to dump&quot;);</a>
<a name="ln3704">        return;</a>
<a name="ln3705">    }</a>
<a name="ln3706"> </a>
<a name="ln3707">    if (*buffer == NULL) {</a>
<a name="ln3708">        *offset = 0;</a>
<a name="ln3709">        *max = 0;</a>
<a name="ln3710">    }</a>
<a name="ln3711"> </a>
<a name="ln3712">    insert_prefix(options, buffer, offset, max, depth);</a>
<a name="ln3713"> </a>
<a name="ln3714">    buffer_print(*buffer, *max, *offset, &quot;&lt;!--&quot;);</a>
<a name="ln3715">    buffer_print(*buffer, *max, *offset, &quot;%s&quot;, data-&gt;content);</a>
<a name="ln3716">    buffer_print(*buffer, *max, *offset, &quot;--&gt;&quot;);</a>
<a name="ln3717"> </a>
<a name="ln3718">    if (options &amp; xml_log_option_formatted) {</a>
<a name="ln3719">        buffer_print(*buffer, *max, *offset, &quot;\n&quot;);</a>
<a name="ln3720">    }</a>
<a name="ln3721">}</a>
<a name="ln3722"> </a>
<a name="ln3723">void</a>
<a name="ln3724">crm_xml_dump(xmlNode * data, int options, char **buffer, int *offset, int *max, int depth)</a>
<a name="ln3725">{</a>
<a name="ln3726">    if(data == NULL) {</a>
<a name="ln3727">        *offset = 0;</a>
<a name="ln3728">        *max = 0;</a>
<a name="ln3729">        return;</a>
<a name="ln3730">    }</a>
<a name="ln3731">#if 0</a>
<a name="ln3732">    if (is_not_set(options, xml_log_option_filtered)) {</a>
<a name="ln3733">        /* Turning this code on also changes the PE tests for some reason</a>
<a name="ln3734">         * (not just newlines).  Figure out why before considering to</a>
<a name="ln3735">         * enable this permanently.</a>
<a name="ln3736">         *</a>
<a name="ln3737">         * It exists to help debug slowness in xmlNodeDump() and</a>
<a name="ln3738">         * potentially if we ever want to go back to it.</a>
<a name="ln3739">         *</a>
<a name="ln3740">         * In theory it's a good idea (reuse) but our custom version does</a>
<a name="ln3741">         * better for the filtered case and avoids the final strdup() for</a>
<a name="ln3742">         * everything</a>
<a name="ln3743">         */</a>
<a name="ln3744"> </a>
<a name="ln3745">        time_t now, next;</a>
<a name="ln3746">        xmlDoc *doc = NULL;</a>
<a name="ln3747">        xmlBuffer *xml_buffer = NULL;</a>
<a name="ln3748"> </a>
<a name="ln3749">        *buffer = NULL;</a>
<a name="ln3750">        doc = getDocPtr(data);</a>
<a name="ln3751">        /* doc will only be NULL if data is */</a>
<a name="ln3752">        CRM_CHECK(doc != NULL, return);</a>
<a name="ln3753"> </a>
<a name="ln3754">        now = time(NULL);</a>
<a name="ln3755">        xml_buffer = xmlBufferCreate();</a>
<a name="ln3756">        CRM_ASSERT(xml_buffer != NULL);</a>
<a name="ln3757"> </a>
<a name="ln3758">        /* The default allocator XML_BUFFER_ALLOC_EXACT does far too many</a>
<a name="ln3759">         * realloc()s and it can take upwards of 18 seconds (yes, seconds)</a>
<a name="ln3760">         * to dump a 28kb tree which XML_BUFFER_ALLOC_DOUBLEIT can do in</a>
<a name="ln3761">         * less than 1 second.</a>
<a name="ln3762">         *</a>
<a name="ln3763">         * We could also use xmlBufferCreateSize() to start with a</a>
<a name="ln3764">         * sane-ish initial size and avoid the first few doubles.</a>
<a name="ln3765">         */</a>
<a name="ln3766">        xmlBufferSetAllocationScheme(xml_buffer, XML_BUFFER_ALLOC_DOUBLEIT);</a>
<a name="ln3767"> </a>
<a name="ln3768">        *max = xmlNodeDump(xml_buffer, doc, data, 0, (options &amp; xml_log_option_formatted));</a>
<a name="ln3769">        if (*max &gt; 0) {</a>
<a name="ln3770">            *buffer = strdup((char *)xml_buffer-&gt;content);</a>
<a name="ln3771">        }</a>
<a name="ln3772"> </a>
<a name="ln3773">        next = time(NULL);</a>
<a name="ln3774">        if ((now + 1) &lt; next) {</a>
<a name="ln3775">            crm_log_xml_trace(data, &quot;Long time&quot;);</a>
<a name="ln3776">            crm_err(&quot;xmlNodeDump() -&gt; %dbytes took %ds&quot;, *max, next - now);</a>
<a name="ln3777">        }</a>
<a name="ln3778"> </a>
<a name="ln3779">        xmlBufferFree(xml_buffer);</a>
<a name="ln3780">        return;</a>
<a name="ln3781">    }</a>
<a name="ln3782">#endif</a>
<a name="ln3783"> </a>
<a name="ln3784">    switch(data-&gt;type) {</a>
<a name="ln3785">        case XML_ELEMENT_NODE:</a>
<a name="ln3786">            /* Handle below */</a>
<a name="ln3787">            dump_xml_element(data, options, buffer, offset, max, depth);</a>
<a name="ln3788">            break;</a>
<a name="ln3789">        case XML_TEXT_NODE:</a>
<a name="ln3790">            /* if option xml_log_option_text is enabled, then dump XML_TEXT_NODE */</a>
<a name="ln3791">            if (options &amp; xml_log_option_text) {</a>
<a name="ln3792">                dump_xml_text(data, options, buffer, offset, max, depth);</a>
<a name="ln3793">            }</a>
<a name="ln3794">            return;</a>
<a name="ln3795">        case XML_COMMENT_NODE:</a>
<a name="ln3796">            dump_xml_comment(data, options, buffer, offset, max, depth);</a>
<a name="ln3797">            break;</a>
<a name="ln3798">        default:</a>
<a name="ln3799">            crm_warn(&quot;Unhandled type: %d&quot;, data-&gt;type);</a>
<a name="ln3800">            return;</a>
<a name="ln3801"> </a>
<a name="ln3802">            /*</a>
<a name="ln3803">            XML_ATTRIBUTE_NODE = 2</a>
<a name="ln3804">            XML_CDATA_SECTION_NODE = 4</a>
<a name="ln3805">            XML_ENTITY_REF_NODE = 5</a>
<a name="ln3806">            XML_ENTITY_NODE = 6</a>
<a name="ln3807">            XML_PI_NODE = 7</a>
<a name="ln3808">            XML_DOCUMENT_NODE = 9</a>
<a name="ln3809">            XML_DOCUMENT_TYPE_NODE = 10</a>
<a name="ln3810">            XML_DOCUMENT_FRAG_NODE = 11</a>
<a name="ln3811">            XML_NOTATION_NODE = 12</a>
<a name="ln3812">            XML_HTML_DOCUMENT_NODE = 13</a>
<a name="ln3813">            XML_DTD_NODE = 14</a>
<a name="ln3814">            XML_ELEMENT_DECL = 15</a>
<a name="ln3815">            XML_ATTRIBUTE_DECL = 16</a>
<a name="ln3816">            XML_ENTITY_DECL = 17</a>
<a name="ln3817">            XML_NAMESPACE_DECL = 18</a>
<a name="ln3818">            XML_XINCLUDE_START = 19</a>
<a name="ln3819">            XML_XINCLUDE_END = 20</a>
<a name="ln3820">            XML_DOCB_DOCUMENT_NODE = 21</a>
<a name="ln3821">            */</a>
<a name="ln3822">    }</a>
<a name="ln3823"> </a>
<a name="ln3824">}</a>
<a name="ln3825"> </a>
<a name="ln3826">void</a>
<a name="ln3827">crm_buffer_add_char(char **buffer, int *offset, int *max, char c)</a>
<a name="ln3828">{</a>
<a name="ln3829">    buffer_print(*buffer, *max, *offset, &quot;%c&quot;, c);</a>
<a name="ln3830">}</a>
<a name="ln3831"> </a>
<a name="ln3832">char *</a>
<a name="ln3833">dump_xml_formatted_with_text(xmlNode * an_xml_node)</a>
<a name="ln3834">{</a>
<a name="ln3835">    char *buffer = NULL;</a>
<a name="ln3836">    int offset = 0, max = 0;</a>
<a name="ln3837"> </a>
<a name="ln3838">    crm_xml_dump(an_xml_node, xml_log_option_formatted|xml_log_option_text, &amp;buffer, &amp;offset, &amp;max, 0);</a>
<a name="ln3839">    return buffer;</a>
<a name="ln3840">}</a>
<a name="ln3841"> </a>
<a name="ln3842">char *</a>
<a name="ln3843">dump_xml_formatted(xmlNode * an_xml_node)</a>
<a name="ln3844">{</a>
<a name="ln3845">    char *buffer = NULL;</a>
<a name="ln3846">    int offset = 0, max = 0;</a>
<a name="ln3847"> </a>
<a name="ln3848">    crm_xml_dump(an_xml_node, xml_log_option_formatted, &amp;buffer, &amp;offset, &amp;max, 0);</a>
<a name="ln3849">    return buffer;</a>
<a name="ln3850">}</a>
<a name="ln3851"> </a>
<a name="ln3852">char *</a>
<a name="ln3853">dump_xml_unformatted(xmlNode * an_xml_node)</a>
<a name="ln3854">{</a>
<a name="ln3855">    char *buffer = NULL;</a>
<a name="ln3856">    int offset = 0, max = 0;</a>
<a name="ln3857"> </a>
<a name="ln3858">    crm_xml_dump(an_xml_node, 0, &amp;buffer, &amp;offset, &amp;max, 0);</a>
<a name="ln3859">    return buffer;</a>
<a name="ln3860">}</a>
<a name="ln3861"> </a>
<a name="ln3862">gboolean</a>
<a name="ln3863">xml_has_children(const xmlNode * xml_root)</a>
<a name="ln3864">{</a>
<a name="ln3865">    if (xml_root != NULL &amp;&amp; xml_root-&gt;children != NULL) {</a>
<a name="ln3866">        return TRUE;</a>
<a name="ln3867">    }</a>
<a name="ln3868">    return FALSE;</a>
<a name="ln3869">}</a>
<a name="ln3870"> </a>
<a name="ln3871">int</a>
<a name="ln3872">crm_element_value_int(xmlNode * data, const char *name, int *dest)</a>
<a name="ln3873">{</a>
<a name="ln3874">    const char *value = crm_element_value(data, name);</a>
<a name="ln3875"> </a>
<a name="ln3876">    CRM_CHECK(dest != NULL, return -1);</a>
<a name="ln3877">    if (value) {</a>
<a name="ln3878">        *dest = crm_int_helper(value, NULL);</a>
<a name="ln3879">        return 0;</a>
<a name="ln3880">    }</a>
<a name="ln3881">    return -1;</a>
<a name="ln3882">}</a>
<a name="ln3883"> </a>
<a name="ln3884">int</a>
<a name="ln3885">crm_element_value_const_int(const xmlNode * data, const char *name, int *dest)</a>
<a name="ln3886">{</a>
<a name="ln3887">    return crm_element_value_int((xmlNode *) data, name, dest);</a>
<a name="ln3888">}</a>
<a name="ln3889"> </a>
<a name="ln3890">const char *</a>
<a name="ln3891">crm_element_value_const(const xmlNode * data, const char *name)</a>
<a name="ln3892">{</a>
<a name="ln3893">    return crm_element_value((xmlNode *) data, name);</a>
<a name="ln3894">}</a>
<a name="ln3895"> </a>
<a name="ln3896">char *</a>
<a name="ln3897">crm_element_value_copy(xmlNode * data, const char *name)</a>
<a name="ln3898">{</a>
<a name="ln3899">    char *value_copy = NULL;</a>
<a name="ln3900">    const char *value = crm_element_value(data, name);</a>
<a name="ln3901"> </a>
<a name="ln3902">    if (value != NULL) {</a>
<a name="ln3903">        value_copy = strdup(value);</a>
<a name="ln3904">    }</a>
<a name="ln3905">    return value_copy;</a>
<a name="ln3906">}</a>
<a name="ln3907"> </a>
<a name="ln3908">void</a>
<a name="ln3909">xml_remove_prop(xmlNode * obj, const char *name)</a>
<a name="ln3910">{</a>
<a name="ln3911">    if(__xml_acl_check(obj, NULL, xpf_acl_write) == FALSE) {</a>
<a name="ln3912">        crm_trace(&quot;Cannot remove %s from %s&quot;, name, obj-&gt;name);</a>
<a name="ln3913"> </a>
<a name="ln3914">    } else if(TRACKING_CHANGES(obj)) {</a>
<a name="ln3915">        /* Leave in place (marked for removal) until after the diff is calculated */</a>
<a name="ln3916">        xml_private_t *p = NULL;</a>
<a name="ln3917">        xmlAttr *attr = xmlHasProp(obj, (const xmlChar *)name);</a>
<a name="ln3918"> </a>
<a name="ln3919">        p = attr-&gt;_private;</a>
<a name="ln3920">        set_parent_flag(obj, xpf_dirty);</a>
<a name="ln3921">        p-&gt;flags |= xpf_deleted;</a>
<a name="ln3922">        /* crm_trace(&quot;Setting flag %x due to %s[@id=%s].%s&quot;, xpf_dirty, obj-&gt;name, ID(obj), name); */</a>
<a name="ln3923"> </a>
<a name="ln3924">    } else {</a>
<a name="ln3925">        xmlUnsetProp(obj, (const xmlChar *)name);</a>
<a name="ln3926">    }</a>
<a name="ln3927">}</a>
<a name="ln3928"> </a>
<a name="ln3929">void</a>
<a name="ln3930">purge_diff_markers(xmlNode * a_node)</a>
<a name="ln3931">{</a>
<a name="ln3932">    xmlNode *child = NULL;</a>
<a name="ln3933"> </a>
<a name="ln3934">    CRM_CHECK(a_node != NULL, return);</a>
<a name="ln3935"> </a>
<a name="ln3936">    xml_remove_prop(a_node, XML_DIFF_MARKER);</a>
<a name="ln3937">    for (child = __xml_first_child(a_node); child != NULL; child = __xml_next(child)) {</a>
<a name="ln3938">        purge_diff_markers(child);</a>
<a name="ln3939">    }</a>
<a name="ln3940">}</a>
<a name="ln3941"> </a>
<a name="ln3942">void</a>
<a name="ln3943">save_xml_to_file(xmlNode * xml, const char *desc, const char *filename)</a>
<a name="ln3944">{</a>
<a name="ln3945">    char *f = NULL;</a>
<a name="ln3946"> </a>
<a name="ln3947">    if (filename == NULL) {</a>
<a name="ln3948">        char *uuid = crm_generate_uuid();</a>
<a name="ln3949"> </a>
<a name="ln3950">        f = crm_strdup_printf(&quot;/tmp/%s&quot;, uuid);</a>
<a name="ln3951">        filename = f;</a>
<a name="ln3952">        free(uuid);</a>
<a name="ln3953">    }</a>
<a name="ln3954"> </a>
<a name="ln3955">    crm_info(&quot;Saving %s to %s&quot;, desc, filename);</a>
<a name="ln3956">    write_xml_file(xml, filename, FALSE);</a>
<a name="ln3957">    free(f);</a>
<a name="ln3958">}</a>
<a name="ln3959"> </a>
<a name="ln3960">gboolean</a>
<a name="ln3961">apply_xml_diff(xmlNode * old, xmlNode * diff, xmlNode ** new)</a>
<a name="ln3962">{</a>
<a name="ln3963">    gboolean result = TRUE;</a>
<a name="ln3964">    int root_nodes_seen = 0;</a>
<a name="ln3965">    static struct qb_log_callsite *digest_cs = NULL;</a>
<a name="ln3966">    const char *digest = crm_element_value(diff, XML_ATTR_DIGEST);</a>
<a name="ln3967">    const char *version = crm_element_value(diff, XML_ATTR_CRM_VERSION);</a>
<a name="ln3968"> </a>
<a name="ln3969">    xmlNode *child_diff = NULL;</a>
<a name="ln3970">    xmlNode *added = find_xml_node(diff, &quot;diff-added&quot;, FALSE);</a>
<a name="ln3971">    xmlNode *removed = find_xml_node(diff, &quot;diff-removed&quot;, FALSE);</a>
<a name="ln3972"> </a>
<a name="ln3973">    CRM_CHECK(new != NULL, return FALSE);</a>
<a name="ln3974">    if (digest_cs == NULL) {</a>
<a name="ln3975">        digest_cs =</a>
<a name="ln3976">            qb_log_callsite_get(__func__, __FILE__, &quot;diff-digest&quot;, LOG_TRACE, __LINE__,</a>
<a name="ln3977">                                crm_trace_nonlog);</a>
<a name="ln3978">    }</a>
<a name="ln3979"> </a>
<a name="ln3980">    crm_trace(&quot;Subtraction Phase&quot;);</a>
<a name="ln3981">    for (child_diff = __xml_first_child(removed); child_diff != NULL;</a>
<a name="ln3982">         child_diff = __xml_next(child_diff)) {</a>
<a name="ln3983">        CRM_CHECK(root_nodes_seen == 0, result = FALSE);</a>
<a name="ln3984">        if (root_nodes_seen == 0) {</a>
<a name="ln3985">            *new = subtract_xml_object(NULL, old, child_diff, FALSE, NULL, NULL);</a>
<a name="ln3986">        }</a>
<a name="ln3987">        root_nodes_seen++;</a>
<a name="ln3988">    }</a>
<a name="ln3989"> </a>
<a name="ln3990">    if (root_nodes_seen == 0) {</a>
<a name="ln3991">        *new = copy_xml(old);</a>
<a name="ln3992"> </a>
<a name="ln3993">    } else if (root_nodes_seen &gt; 1) {</a>
<a name="ln3994">        crm_err(&quot;(-) Diffs cannot contain more than one change set...&quot; &quot; saw %d&quot;, root_nodes_seen);</a>
<a name="ln3995">        result = FALSE;</a>
<a name="ln3996">    }</a>
<a name="ln3997"> </a>
<a name="ln3998">    root_nodes_seen = 0;</a>
<a name="ln3999">    crm_trace(&quot;Addition Phase&quot;);</a>
<a name="ln4000">    if (result) {</a>
<a name="ln4001">        xmlNode *child_diff = NULL;</a>
<a name="ln4002"> </a>
<a name="ln4003">        for (child_diff = __xml_first_child(added); child_diff != NULL;</a>
<a name="ln4004">             child_diff = __xml_next(child_diff)) {</a>
<a name="ln4005">            CRM_CHECK(root_nodes_seen == 0, result = FALSE);</a>
<a name="ln4006">            if (root_nodes_seen == 0) {</a>
<a name="ln4007">                add_xml_object(NULL, *new, child_diff, TRUE);</a>
<a name="ln4008">            }</a>
<a name="ln4009">            root_nodes_seen++;</a>
<a name="ln4010">        }</a>
<a name="ln4011">    }</a>
<a name="ln4012"> </a>
<a name="ln4013">    if (root_nodes_seen &gt; 1) {</a>
<a name="ln4014">        crm_err(&quot;(+) Diffs cannot contain more than one change set...&quot; &quot; saw %d&quot;, root_nodes_seen);</a>
<a name="ln4015">        result = FALSE;</a>
<a name="ln4016"> </a>
<a name="ln4017">    } else if (result &amp;&amp; digest) {</a>
<a name="ln4018">        char *new_digest = NULL;</a>
<a name="ln4019"> </a>
<a name="ln4020">        purge_diff_markers(*new);       /* Purge now so the diff is ok */</a>
<a name="ln4021">        new_digest = calculate_xml_versioned_digest(*new, FALSE, TRUE, version);</a>
<a name="ln4022">        if (safe_str_neq(new_digest, digest)) {</a>
<a name="ln4023">            crm_info(&quot;Digest mis-match: expected %s, calculated %s&quot;, digest, new_digest);</a>
<a name="ln4024">            result = FALSE;</a>
<a name="ln4025"> </a>
<a name="ln4026">            crm_trace(&quot;%p %.6x&quot;, digest_cs, digest_cs ? digest_cs-&gt;targets : 0);</a>
<a name="ln4027">            if (digest_cs &amp;&amp; digest_cs-&gt;targets) {</a>
<a name="ln4028">                save_xml_to_file(old, &quot;diff:original&quot;, NULL);</a>
<a name="ln4029">                save_xml_to_file(diff, &quot;diff:input&quot;, NULL);</a>
<a name="ln4030">                save_xml_to_file(*new, &quot;diff:new&quot;, NULL);</a>
<a name="ln4031">            }</a>
<a name="ln4032"> </a>
<a name="ln4033">        } else {</a>
<a name="ln4034">            crm_trace(&quot;Digest matched: expected %s, calculated %s&quot;, digest, new_digest);</a>
<a name="ln4035">        }</a>
<a name="ln4036">        free(new_digest);</a>
<a name="ln4037"> </a>
<a name="ln4038">    } else if (result) {</a>
<a name="ln4039">        purge_diff_markers(*new);       /* Purge now so the diff is ok */</a>
<a name="ln4040">    }</a>
<a name="ln4041"> </a>
<a name="ln4042">    return result;</a>
<a name="ln4043">}</a>
<a name="ln4044"> </a>
<a name="ln4045">static void</a>
<a name="ln4046">__xml_diff_object(xmlNode * old, xmlNode * new)</a>
<a name="ln4047">{</a>
<a name="ln4048">    xmlNode *cIter = NULL;</a>
<a name="ln4049">    xmlAttr *pIter = NULL;</a>
<a name="ln4050"> </a>
<a name="ln4051">    CRM_CHECK(new != NULL, return);</a>
<a name="ln4052">    if(old == NULL) {</a>
<a name="ln4053">        crm_node_created(new);</a>
<a name="ln4054">        __xml_acl_post_process(new); /* Check creation is allowed */</a>
<a name="ln4055">        return;</a>
<a name="ln4056"> </a>
<a name="ln4057">    } else {</a>
<a name="ln4058">        xml_private_t *p = new-&gt;_private;</a>
<a name="ln4059"> </a>
<a name="ln4060">        if(p-&gt;flags &amp; xpf_processed) {</a>
<a name="ln4061">            /* Avoid re-comparing nodes */</a>
<a name="ln4062">            return;</a>
<a name="ln4063">        }</a>
<a name="ln4064">        p-&gt;flags |= xpf_processed;</a>
<a name="ln4065">    }</a>
<a name="ln4066"> </a>
<a name="ln4067">    for (pIter = crm_first_attr(new); pIter != NULL; pIter = pIter-&gt;next) {</a>
<a name="ln4068">        xml_private_t *p = pIter-&gt;_private;</a>
<a name="ln4069"> </a>
<a name="ln4070">        /* Assume everything was just created and take it from there */</a>
<a name="ln4071">        p-&gt;flags |= xpf_created;</a>
<a name="ln4072">    }</a>
<a name="ln4073"> </a>
<a name="ln4074">    for (pIter = crm_first_attr(old); pIter != NULL; ) {</a>
<a name="ln4075">        xmlAttr *prop = pIter;</a>
<a name="ln4076">        xml_private_t *p = NULL;</a>
<a name="ln4077">        const char *name = (const char *)pIter-&gt;name;</a>
<a name="ln4078">        const char *old_value = crm_element_value(old, name);</a>
<a name="ln4079">        xmlAttr *exists = xmlHasProp(new, pIter-&gt;name);</a>
<a name="ln4080"> </a>
<a name="ln4081">        pIter = pIter-&gt;next;</a>
<a name="ln4082">        if(exists == NULL) {</a>
<a name="ln4083">            p = new-&gt;doc-&gt;_private;</a>
<a name="ln4084"> </a>
<a name="ln4085">            /* Prevent the dirty flag being set recursively upwards */</a>
<a name="ln4086">            clear_bit(p-&gt;flags, xpf_tracking);</a>
<a name="ln4087">            exists = xmlSetProp(new, (const xmlChar *)name, (const xmlChar *)old_value);</a>
<a name="ln4088">            set_bit(p-&gt;flags, xpf_tracking);</a>
<a name="ln4089"> </a>
<a name="ln4090">            p = exists-&gt;_private;</a>
<a name="ln4091">            p-&gt;flags = 0;</a>
<a name="ln4092"> </a>
<a name="ln4093">            crm_trace(&quot;Lost %s@%s=%s&quot;, old-&gt;name, name, old_value);</a>
<a name="ln4094">            xml_remove_prop(new, name);</a>
<a name="ln4095"> </a>
<a name="ln4096">        } else {</a>
<a name="ln4097">            int p_new = __xml_offset((xmlNode*)exists);</a>
<a name="ln4098">            int p_old = __xml_offset((xmlNode*)prop);</a>
<a name="ln4099">            const char *value = crm_element_value(new, name);</a>
<a name="ln4100"> </a>
<a name="ln4101">            p = exists-&gt;_private;</a>
<a name="ln4102">            p-&gt;flags = (p-&gt;flags &amp; ~xpf_created);</a>
<a name="ln4103"> </a>
<a name="ln4104">            if(strcmp(value, old_value) != 0) {</a>
<a name="ln4105">                /* Restore the original value, so we can call crm_xml_add(),</a>
<a name="ln4106">                 * which checks ACLs</a>
<a name="ln4107">                 */</a>
<a name="ln4108">                char *vcopy = crm_element_value_copy(new, name);</a>
<a name="ln4109"> </a>
<a name="ln4110">                crm_trace(&quot;Modified %s@%s %s-&gt;%s&quot;, old-&gt;name, name, old_value, vcopy);</a>
<a name="ln4111">                xmlSetProp(new, prop-&gt;name, (const xmlChar *)old_value);</a>
<a name="ln4112">                crm_xml_add(new, name, vcopy);</a>
<a name="ln4113">                free(vcopy);</a>
<a name="ln4114"> </a>
<a name="ln4115">            } else if(p_old != p_new) {</a>
<a name="ln4116">                crm_info(&quot;Moved %s@%s (%d -&gt; %d)&quot;, old-&gt;name, name, p_old, p_new);</a>
<a name="ln4117">                __xml_node_dirty(new);</a>
<a name="ln4118">                p-&gt;flags |= xpf_dirty|xpf_moved;</a>
<a name="ln4119"> </a>
<a name="ln4120">                if(p_old &gt; p_new) {</a>
<a name="ln4121">                    p = prop-&gt;_private;</a>
<a name="ln4122">                    p-&gt;flags |= xpf_skip;</a>
<a name="ln4123"> </a>
<a name="ln4124">                } else {</a>
<a name="ln4125">                    p = exists-&gt;_private;</a>
<a name="ln4126">                    p-&gt;flags |= xpf_skip;</a>
<a name="ln4127">                }</a>
<a name="ln4128">            }</a>
<a name="ln4129">        }</a>
<a name="ln4130">    }</a>
<a name="ln4131"> </a>
<a name="ln4132">    for (pIter = crm_first_attr(new); pIter != NULL; ) {</a>
<a name="ln4133">        xmlAttr *prop = pIter;</a>
<a name="ln4134">        xml_private_t *p = pIter-&gt;_private;</a>
<a name="ln4135"> </a>
<a name="ln4136">        pIter = pIter-&gt;next;</a>
<a name="ln4137">        if(is_set(p-&gt;flags, xpf_created)) {</a>
<a name="ln4138">            char *name = strdup((const char *)prop-&gt;name);</a>
<a name="ln4139">            char *value = crm_element_value_copy(new, name);</a>
<a name="ln4140"> </a>
<a name="ln4141">            crm_trace(&quot;Created %s@%s=%s&quot;, new-&gt;name, name, value);</a>
<a name="ln4142">            /* Remove plus create won't work as it will modify the relative attribute ordering */</a>
<a name="ln4143">            if(__xml_acl_check(new, name, xpf_acl_write)) {</a>
<a name="ln4144">                crm_attr_dirty(prop);</a>
<a name="ln4145">            } else {</a>
<a name="ln4146">                xmlUnsetProp(new, prop-&gt;name); /* Remove - change not allowed */</a>
<a name="ln4147">            }</a>
<a name="ln4148"> </a>
<a name="ln4149">            free(value);</a>
<a name="ln4150">            free(name);</a>
<a name="ln4151">        }</a>
<a name="ln4152">    }</a>
<a name="ln4153"> </a>
<a name="ln4154">    for (cIter = __xml_first_child(old); cIter != NULL; ) {</a>
<a name="ln4155">        xmlNode *old_child = cIter;</a>
<a name="ln4156">        xmlNode *new_child = find_element(new, cIter, TRUE);</a>
<a name="ln4157"> </a>
<a name="ln4158">        cIter = __xml_next(cIter);</a>
<a name="ln4159">        if(new_child) {</a>
<a name="ln4160">            __xml_diff_object(old_child, new_child);</a>
<a name="ln4161"> </a>
<a name="ln4162">        } else {</a>
<a name="ln4163">            /* Create then free (which will check the acls if necessary) */</a>
<a name="ln4164">            xmlNode *candidate = add_node_copy(new, old_child);</a>
<a name="ln4165">            xmlNode *top = xmlDocGetRootElement(candidate-&gt;doc);</a>
<a name="ln4166"> </a>
<a name="ln4167">            __xml_node_clean(candidate);</a>
<a name="ln4168">            __xml_acl_apply(top); /* Make sure any ACLs are applied to 'candidate' */</a>
<a name="ln4169">            /* Record the old position */</a>
<a name="ln4170">            free_xml_with_position(candidate, __xml_offset(old_child));</a>
<a name="ln4171"> </a>
<a name="ln4172">            if (find_element(new, old_child, TRUE) == NULL) {</a>
<a name="ln4173">                xml_private_t *p = old_child-&gt;_private;</a>
<a name="ln4174"> </a>
<a name="ln4175">                p-&gt;flags |= xpf_skip;</a>
<a name="ln4176">            }</a>
<a name="ln4177">        }</a>
<a name="ln4178">    }</a>
<a name="ln4179"> </a>
<a name="ln4180">    for (cIter = __xml_first_child(new); cIter != NULL; ) {</a>
<a name="ln4181">        xmlNode *new_child = cIter;</a>
<a name="ln4182">        xmlNode *old_child = find_element(old, cIter, TRUE);</a>
<a name="ln4183"> </a>
<a name="ln4184">        cIter = __xml_next(cIter);</a>
<a name="ln4185">        if(old_child == NULL) {</a>
<a name="ln4186">            xml_private_t *p = new_child-&gt;_private;</a>
<a name="ln4187">            p-&gt;flags |= xpf_skip;</a>
<a name="ln4188">            __xml_diff_object(old_child, new_child);</a>
<a name="ln4189"> </a>
<a name="ln4190">        } else {</a>
<a name="ln4191">            /* Check for movement, we already checked for differences */</a>
<a name="ln4192">            int p_new = __xml_offset(new_child);</a>
<a name="ln4193">            int p_old = __xml_offset(old_child);</a>
<a name="ln4194"> </a>
<a name="ln4195">            if(p_old != p_new) {</a>
<a name="ln4196">                xml_private_t *p = new_child-&gt;_private;</a>
<a name="ln4197"> </a>
<a name="ln4198">                crm_info(&quot;%s.%s moved from %d to %d&quot;,</a>
<a name="ln4199">                         new_child-&gt;name, ID(new_child), p_old, p_new);</a>
<a name="ln4200">                __xml_node_dirty(new);</a>
<a name="ln4201">                p-&gt;flags |= xpf_moved;</a>
<a name="ln4202"> </a>
<a name="ln4203">                if(p_old &gt; p_new) {</a>
<a name="ln4204">                    p = old_child-&gt;_private;</a>
<a name="ln4205">                } else {</a>
<a name="ln4206">                    p = new_child-&gt;_private;</a>
<a name="ln4207">                }</a>
<a name="ln4208">                p-&gt;flags |= xpf_skip;</a>
<a name="ln4209">            }</a>
<a name="ln4210">        }</a>
<a name="ln4211">    }</a>
<a name="ln4212">}</a>
<a name="ln4213"> </a>
<a name="ln4214">void</a>
<a name="ln4215">xml_calculate_changes(xmlNode * old, xmlNode * new)</a>
<a name="ln4216">{</a>
<a name="ln4217">    CRM_CHECK(safe_str_eq(crm_element_name(old), crm_element_name(new)), return);</a>
<a name="ln4218">    CRM_CHECK(safe_str_eq(ID(old), ID(new)), return);</a>
<a name="ln4219"> </a>
<a name="ln4220">    if(xml_tracking_changes(new) == FALSE) {</a>
<a name="ln4221">        xml_track_changes(new, NULL, NULL, FALSE);</a>
<a name="ln4222">    }</a>
<a name="ln4223"> </a>
<a name="ln4224">    __xml_diff_object(old, new);</a>
<a name="ln4225">}</a>
<a name="ln4226"> </a>
<a name="ln4227">xmlNode *</a>
<a name="ln4228">diff_xml_object(xmlNode * old, xmlNode * new, gboolean suppress)</a>
<a name="ln4229">{</a>
<a name="ln4230">    xmlNode *tmp1 = NULL;</a>
<a name="ln4231">    xmlNode *diff = create_xml_node(NULL, &quot;diff&quot;);</a>
<a name="ln4232">    xmlNode *removed = create_xml_node(diff, &quot;diff-removed&quot;);</a>
<a name="ln4233">    xmlNode *added = create_xml_node(diff, &quot;diff-added&quot;);</a>
<a name="ln4234"> </a>
<a name="ln4235">    crm_xml_add(diff, XML_ATTR_CRM_VERSION, CRM_FEATURE_SET);</a>
<a name="ln4236"> </a>
<a name="ln4237">    tmp1 = subtract_xml_object(removed, old, new, FALSE, NULL, &quot;removed:top&quot;);</a>
<a name="ln4238">    if (suppress &amp;&amp; tmp1 != NULL &amp;&amp; can_prune_leaf(tmp1)) {</a>
<a name="ln4239">        free_xml(tmp1);</a>
<a name="ln4240">    }</a>
<a name="ln4241"> </a>
<a name="ln4242">    tmp1 = subtract_xml_object(added, new, old, TRUE, NULL, &quot;added:top&quot;);</a>
<a name="ln4243">    if (suppress &amp;&amp; tmp1 != NULL &amp;&amp; can_prune_leaf(tmp1)) {</a>
<a name="ln4244">        free_xml(tmp1);</a>
<a name="ln4245">    }</a>
<a name="ln4246"> </a>
<a name="ln4247">    if (added-&gt;children == NULL &amp;&amp; removed-&gt;children == NULL) {</a>
<a name="ln4248">        free_xml(diff);</a>
<a name="ln4249">        diff = NULL;</a>
<a name="ln4250">    }</a>
<a name="ln4251"> </a>
<a name="ln4252">    return diff;</a>
<a name="ln4253">}</a>
<a name="ln4254"> </a>
<a name="ln4255">gboolean</a>
<a name="ln4256">can_prune_leaf(xmlNode * xml_node)</a>
<a name="ln4257">{</a>
<a name="ln4258">    xmlNode *cIter = NULL;</a>
<a name="ln4259">    xmlAttrPtr pIter = NULL;</a>
<a name="ln4260">    gboolean can_prune = TRUE;</a>
<a name="ln4261">    const char *name = crm_element_name(xml_node);</a>
<a name="ln4262"> </a>
<a name="ln4263">    if (safe_str_eq(name, XML_TAG_RESOURCE_REF)</a>
<a name="ln4264">        || safe_str_eq(name, XML_CIB_TAG_OBJ_REF)</a>
<a name="ln4265">        || safe_str_eq(name, XML_ACL_TAG_ROLE_REF)</a>
<a name="ln4266">        || safe_str_eq(name, XML_ACL_TAG_ROLE_REFv1)) {</a>
<a name="ln4267">        return FALSE;</a>
<a name="ln4268">    }</a>
<a name="ln4269"> </a>
<a name="ln4270">    for (pIter = crm_first_attr(xml_node); pIter != NULL; pIter = pIter-&gt;next) {</a>
<a name="ln4271">        const char *p_name = (const char *)pIter-&gt;name;</a>
<a name="ln4272"> </a>
<a name="ln4273">        if (strcmp(p_name, XML_ATTR_ID) == 0) {</a>
<a name="ln4274">            continue;</a>
<a name="ln4275">        }</a>
<a name="ln4276">        can_prune = FALSE;</a>
<a name="ln4277">    }</a>
<a name="ln4278"> </a>
<a name="ln4279">    cIter = __xml_first_child(xml_node);</a>
<a name="ln4280">    while (cIter) {</a>
<a name="ln4281">        xmlNode *child = cIter;</a>
<a name="ln4282"> </a>
<a name="ln4283">        cIter = __xml_next(cIter);</a>
<a name="ln4284">        if (can_prune_leaf(child)) {</a>
<a name="ln4285">            free_xml(child);</a>
<a name="ln4286">        } else {</a>
<a name="ln4287">            can_prune = FALSE;</a>
<a name="ln4288">        }</a>
<a name="ln4289">    }</a>
<a name="ln4290">    return can_prune;</a>
<a name="ln4291">}</a>
<a name="ln4292"> </a>
<a name="ln4293">void</a>
<a name="ln4294">diff_filter_context(int context, int upper_bound, int lower_bound,</a>
<a name="ln4295">                    xmlNode * xml_node, xmlNode * parent)</a>
<a name="ln4296">{</a>
<a name="ln4297">    xmlNode *us = NULL;</a>
<a name="ln4298">    xmlNode *child = NULL;</a>
<a name="ln4299">    xmlAttrPtr pIter = NULL;</a>
<a name="ln4300">    xmlNode *new_parent = parent;</a>
<a name="ln4301">    const char *name = crm_element_name(xml_node);</a>
<a name="ln4302"> </a>
<a name="ln4303">    CRM_CHECK(xml_node != NULL &amp;&amp; name != NULL, return);</a>
<a name="ln4304"> </a>
<a name="ln4305">    us = create_xml_node(parent, name);</a>
<a name="ln4306">    for (pIter = crm_first_attr(xml_node); pIter != NULL; pIter = pIter-&gt;next) {</a>
<a name="ln4307">        const char *p_name = (const char *)pIter-&gt;name;</a>
<a name="ln4308">        const char *p_value = crm_attr_value(pIter);</a>
<a name="ln4309"> </a>
<a name="ln4310">        lower_bound = context;</a>
<a name="ln4311">        crm_xml_add(us, p_name, p_value);</a>
<a name="ln4312">    }</a>
<a name="ln4313"> </a>
<a name="ln4314">    if (lower_bound &gt;= 0 || upper_bound &gt;= 0) {</a>
<a name="ln4315">        crm_xml_add(us, XML_ATTR_ID, ID(xml_node));</a>
<a name="ln4316">        new_parent = us;</a>
<a name="ln4317"> </a>
<a name="ln4318">    } else {</a>
<a name="ln4319">        upper_bound = in_upper_context(0, context, xml_node);</a>
<a name="ln4320">        if (upper_bound &gt;= 0) {</a>
<a name="ln4321">            crm_xml_add(us, XML_ATTR_ID, ID(xml_node));</a>
<a name="ln4322">            new_parent = us;</a>
<a name="ln4323">        } else {</a>
<a name="ln4324">            free_xml(us);</a>
<a name="ln4325">            us = NULL;</a>
<a name="ln4326">        }</a>
<a name="ln4327">    }</a>
<a name="ln4328"> </a>
<a name="ln4329">    for (child = __xml_first_child(us); child != NULL; child = __xml_next(child)) {</a>
<a name="ln4330">        diff_filter_context(context, upper_bound - 1, lower_bound - 1, child, new_parent);</a>
<a name="ln4331">    }</a>
<a name="ln4332">}</a>
<a name="ln4333"> </a>
<a name="ln4334">int</a>
<a name="ln4335">in_upper_context(int depth, int context, xmlNode * xml_node)</a>
<a name="ln4336">{</a>
<a name="ln4337">    if (context == 0) {</a>
<a name="ln4338">        return 0;</a>
<a name="ln4339">    }</a>
<a name="ln4340"> </a>
<a name="ln4341">    if (xml_node-&gt;properties) {</a>
<a name="ln4342">        return depth;</a>
<a name="ln4343"> </a>
<a name="ln4344">    } else if (depth &lt; context) {</a>
<a name="ln4345">        xmlNode *child = NULL;</a>
<a name="ln4346"> </a>
<a name="ln4347">        for (child = __xml_first_child(xml_node); child != NULL; child = __xml_next(child)) {</a>
<a name="ln4348">            if (in_upper_context(depth + 1, context, child)) {</a>
<a name="ln4349">                return depth;</a>
<a name="ln4350">            }</a>
<a name="ln4351">        }</a>
<a name="ln4352">    }</a>
<a name="ln4353">    return 0;</a>
<a name="ln4354">}</a>
<a name="ln4355"> </a>
<a name="ln4356">static xmlNode *</a>
<a name="ln4357">find_xml_comment(xmlNode * root, xmlNode * search_comment, gboolean exact)</a>
<a name="ln4358">{</a>
<a name="ln4359">    xmlNode *a_child = NULL;</a>
<a name="ln4360">    int search_offset = __xml_offset(search_comment);</a>
<a name="ln4361"> </a>
<a name="ln4362">    CRM_CHECK(search_comment-&gt;type == XML_COMMENT_NODE, return NULL);</a>
<a name="ln4363"> </a>
<a name="ln4364">    for (a_child = __xml_first_child(root); a_child != NULL; a_child = __xml_next(a_child)) {</a>
<a name="ln4365">        if (exact) {</a>
<a name="ln4366">            int offset = __xml_offset(a_child);</a>
<a name="ln4367">            xml_private_t *p = a_child-&gt;_private;</a>
<a name="ln4368"> </a>
<a name="ln4369">            if (offset &lt; search_offset) {</a>
<a name="ln4370">                continue;</a>
<a name="ln4371"> </a>
<a name="ln4372">            } else if (offset &gt; search_offset) {</a>
<a name="ln4373">                return NULL;</a>
<a name="ln4374">            }</a>
<a name="ln4375"> </a>
<a name="ln4376">            if (is_set(p-&gt;flags, xpf_skip)) {</a>
<a name="ln4377">                continue;</a>
<a name="ln4378">            }</a>
<a name="ln4379">        }</a>
<a name="ln4380"> </a>
<a name="ln4381">        if (a_child-&gt;type == XML_COMMENT_NODE</a>
<a name="ln4382">            &amp;&amp; safe_str_eq((const char *)a_child-&gt;content, (const char *)search_comment-&gt;content)) {</a>
<a name="ln4383">            return a_child;</a>
<a name="ln4384"> </a>
<a name="ln4385">        } else if (exact) {</a>
<a name="ln4386">            return NULL;</a>
<a name="ln4387">        }</a>
<a name="ln4388">    }</a>
<a name="ln4389"> </a>
<a name="ln4390">    return NULL;</a>
<a name="ln4391">}</a>
<a name="ln4392"> </a>
<a name="ln4393">static xmlNode *</a>
<a name="ln4394">subtract_xml_comment(xmlNode * parent, xmlNode * left, xmlNode * right,</a>
<a name="ln4395">                     gboolean * changed)</a>
<a name="ln4396">{</a>
<a name="ln4397">    CRM_CHECK(left != NULL, return NULL);</a>
<a name="ln4398">    CRM_CHECK(left-&gt;type == XML_COMMENT_NODE, return NULL);</a>
<a name="ln4399"> </a>
<a name="ln4400">    if (right == NULL</a>
<a name="ln4401">        || safe_str_neq((const char *)left-&gt;content, (const char *)right-&gt;content)) {</a>
<a name="ln4402">        xmlNode *deleted = NULL;</a>
<a name="ln4403"> </a>
<a name="ln4404">        deleted = add_node_copy(parent, left);</a>
<a name="ln4405">        *changed = TRUE;</a>
<a name="ln4406"> </a>
<a name="ln4407">        return deleted;</a>
<a name="ln4408">    }</a>
<a name="ln4409"> </a>
<a name="ln4410">    return NULL;</a>
<a name="ln4411">}</a>
<a name="ln4412"> </a>
<a name="ln4413">xmlNode *</a>
<a name="ln4414">subtract_xml_object(xmlNode * parent, xmlNode * left, xmlNode * right,</a>
<a name="ln4415">                    gboolean full, gboolean * changed, const char *marker)</a>
<a name="ln4416">{</a>
<a name="ln4417">    gboolean dummy = FALSE;</a>
<a name="ln4418">    gboolean skip = FALSE;</a>
<a name="ln4419">    xmlNode *diff = NULL;</a>
<a name="ln4420">    xmlNode *right_child = NULL;</a>
<a name="ln4421">    xmlNode *left_child = NULL;</a>
<a name="ln4422">    xmlAttrPtr xIter = NULL;</a>
<a name="ln4423"> </a>
<a name="ln4424">    const char *id = NULL;</a>
<a name="ln4425">    const char *name = NULL;</a>
<a name="ln4426">    const char *value = NULL;</a>
<a name="ln4427">    const char *right_val = NULL;</a>
<a name="ln4428"> </a>
<a name="ln4429">    int lpc = 0;</a>
<a name="ln4430">    static int filter_len = DIMOF(filter);</a>
<a name="ln4431"> </a>
<a name="ln4432">    if (changed == NULL) {</a>
<a name="ln4433">        changed = &amp;dummy;</a>
<a name="ln4434">    }</a>
<a name="ln4435"> </a>
<a name="ln4436">    if (left == NULL) {</a>
<a name="ln4437">        return NULL;</a>
<a name="ln4438">    }</a>
<a name="ln4439"> </a>
<a name="ln4440">    if (left-&gt;type == XML_COMMENT_NODE) {</a>
<a name="ln4441">        return subtract_xml_comment(parent, left, right, changed);</a>
<a name="ln4442">    }</a>
<a name="ln4443"> </a>
<a name="ln4444">    id = ID(left);</a>
<a name="ln4445">    if (right == NULL) {</a>
<a name="ln4446">        xmlNode *deleted = NULL;</a>
<a name="ln4447"> </a>
<a name="ln4448">        crm_trace(&quot;Processing &lt;%s id=%s&gt; (complete copy)&quot;, crm_element_name(left), id);</a>
<a name="ln4449">        deleted = add_node_copy(parent, left);</a>
<a name="ln4450">        crm_xml_add(deleted, XML_DIFF_MARKER, marker);</a>
<a name="ln4451"> </a>
<a name="ln4452">        *changed = TRUE;</a>
<a name="ln4453">        return deleted;</a>
<a name="ln4454">    }</a>
<a name="ln4455"> </a>
<a name="ln4456">    name = crm_element_name(left);</a>
<a name="ln4457">    CRM_CHECK(name != NULL, return NULL);</a>
<a name="ln4458">    CRM_CHECK(safe_str_eq(crm_element_name(left), crm_element_name(right)), return NULL);</a>
<a name="ln4459"> </a>
<a name="ln4460">    /* check for XML_DIFF_MARKER in a child */</a>
<a name="ln4461">    value = crm_element_value(right, XML_DIFF_MARKER);</a>
<a name="ln4462">    if (value != NULL &amp;&amp; strcmp(value, &quot;removed:top&quot;) == 0) {</a>
<a name="ln4463">        crm_trace(&quot;We are the root of the deletion: %s.id=%s&quot;, name, id);</a>
<a name="ln4464">        *changed = TRUE;</a>
<a name="ln4465">        return NULL;</a>
<a name="ln4466">    }</a>
<a name="ln4467"> </a>
<a name="ln4468">    /* Avoiding creating the full heirarchy would save even more work here */</a>
<a name="ln4469">    diff = create_xml_node(parent, name);</a>
<a name="ln4470"> </a>
<a name="ln4471">    /* Reset filter */</a>
<a name="ln4472">    for (lpc = 0; lpc &lt; filter_len; lpc++) {</a>
<a name="ln4473">        filter[lpc].found = FALSE;</a>
<a name="ln4474">    }</a>
<a name="ln4475"> </a>
<a name="ln4476">    /* changes to child objects */</a>
<a name="ln4477">    for (left_child = __xml_first_child(left); left_child != NULL;</a>
<a name="ln4478">         left_child = __xml_next(left_child)) {</a>
<a name="ln4479">        gboolean child_changed = FALSE;</a>
<a name="ln4480"> </a>
<a name="ln4481">        right_child = find_element(right, left_child, FALSE);</a>
<a name="ln4482">        subtract_xml_object(diff, left_child, right_child, full, &amp;child_changed, marker);</a>
<a name="ln4483">        if (child_changed) {</a>
<a name="ln4484">            *changed = TRUE;</a>
<a name="ln4485">        }</a>
<a name="ln4486">    }</a>
<a name="ln4487"> </a>
<a name="ln4488">    if (*changed == FALSE) {</a>
<a name="ln4489">        /* Nothing to do */</a>
<a name="ln4490"> </a>
<a name="ln4491">    } else if (full) {</a>
<a name="ln4492">        xmlAttrPtr pIter = NULL;</a>
<a name="ln4493"> </a>
<a name="ln4494">        for (pIter = crm_first_attr(left); pIter != NULL; pIter = pIter-&gt;next) {</a>
<a name="ln4495">            const char *p_name = (const char *)pIter-&gt;name;</a>
<a name="ln4496">            const char *p_value = crm_attr_value(pIter);</a>
<a name="ln4497"> </a>
<a name="ln4498">            xmlSetProp(diff, (const xmlChar *)p_name, (const xmlChar *)p_value);</a>
<a name="ln4499">        }</a>
<a name="ln4500"> </a>
<a name="ln4501">        /* We already have everything we need... */</a>
<a name="ln4502">        goto done;</a>
<a name="ln4503"> </a>
<a name="ln4504">    } else if (id) {</a>
<a name="ln4505">        xmlSetProp(diff, (const xmlChar *)XML_ATTR_ID, (const xmlChar *)id);</a>
<a name="ln4506">    }</a>
<a name="ln4507"> </a>
<a name="ln4508">    /* changes to name/value pairs */</a>
<a name="ln4509">    for (xIter = crm_first_attr(left); xIter != NULL; xIter = xIter-&gt;next) {</a>
<a name="ln4510">        const char *prop_name = (const char *)xIter-&gt;name;</a>
<a name="ln4511">        xmlAttrPtr right_attr = NULL;</a>
<a name="ln4512">        xml_private_t *p = NULL;</a>
<a name="ln4513"> </a>
<a name="ln4514">        if (strcmp(prop_name, XML_ATTR_ID) == 0) {</a>
<a name="ln4515">            continue;</a>
<a name="ln4516">        }</a>
<a name="ln4517"> </a>
<a name="ln4518">        skip = FALSE;</a>
<a name="ln4519">        for (lpc = 0; skip == FALSE &amp;&amp; lpc &lt; filter_len; lpc++) {</a>
<a name="ln4520">            if (filter[lpc].found == FALSE &amp;&amp; strcmp(prop_name, filter[lpc].string) == 0) {</a>
<a name="ln4521">                filter[lpc].found = TRUE;</a>
<a name="ln4522">                skip = TRUE;</a>
<a name="ln4523">                break;</a>
<a name="ln4524">            }</a>
<a name="ln4525">        }</a>
<a name="ln4526"> </a>
<a name="ln4527">        if (skip) {</a>
<a name="ln4528">            continue;</a>
<a name="ln4529">        }</a>
<a name="ln4530"> </a>
<a name="ln4531">        right_attr = xmlHasProp(right, (const xmlChar *)prop_name);</a>
<a name="ln4532">        if (right_attr) {</a>
<a name="ln4533">            p = right_attr-&gt;_private;</a>
<a name="ln4534">        }</a>
<a name="ln4535"> </a>
<a name="ln4536">        right_val = crm_element_value(right, prop_name);</a>
<a name="ln4537">        if (right_val == NULL || (p &amp;&amp; is_set(p-&gt;flags, xpf_deleted))) {</a>
<a name="ln4538">            /* new */</a>
<a name="ln4539">            *changed = TRUE;</a>
<a name="ln4540">            if (full) {</a>
<a name="ln4541">                xmlAttrPtr pIter = NULL;</a>
<a name="ln4542"> </a>
<a name="ln4543">                for (pIter = crm_first_attr(left); pIter != NULL; pIter = pIter-&gt;next) {</a>
<a name="ln4544">                    const char *p_name = (const char *)pIter-&gt;name;</a>
<a name="ln4545">                    const char *p_value = crm_attr_value(pIter);</a>
<a name="ln4546"> </a>
<a name="ln4547">                    xmlSetProp(diff, (const xmlChar *)p_name, (const xmlChar *)p_value);</a>
<a name="ln4548">                }</a>
<a name="ln4549">                break;</a>
<a name="ln4550"> </a>
<a name="ln4551">            } else {</a>
<a name="ln4552">                const char *left_value = crm_element_value(left, prop_name);</a>
<a name="ln4553"> </a>
<a name="ln4554">                xmlSetProp(diff, (const xmlChar *)prop_name, (const xmlChar *)value);</a>
<a name="ln4555">                crm_xml_add(diff, prop_name, left_value);</a>
<a name="ln4556">            }</a>
<a name="ln4557"> </a>
<a name="ln4558">        } else {</a>
<a name="ln4559">            /* Only now do we need the left value */</a>
<a name="ln4560">            const char *left_value = crm_element_value(left, prop_name);</a>
<a name="ln4561"> </a>
<a name="ln4562">            if (strcmp(left_value, right_val) == 0) {</a>
<a name="ln4563">                /* unchanged */</a>
<a name="ln4564"> </a>
<a name="ln4565">            } else {</a>
<a name="ln4566">                *changed = TRUE;</a>
<a name="ln4567">                if (full) {</a>
<a name="ln4568">                    xmlAttrPtr pIter = NULL;</a>
<a name="ln4569"> </a>
<a name="ln4570">                    crm_trace(&quot;Changes detected to %s in &lt;%s id=%s&gt;&quot;, prop_name,</a>
<a name="ln4571">                              crm_element_name(left), id);</a>
<a name="ln4572">                    for (pIter = crm_first_attr(left); pIter != NULL; pIter = pIter-&gt;next) {</a>
<a name="ln4573">                        const char *p_name = (const char *)pIter-&gt;name;</a>
<a name="ln4574">                        const char *p_value = crm_attr_value(pIter);</a>
<a name="ln4575"> </a>
<a name="ln4576">                        xmlSetProp(diff, (const xmlChar *)p_name, (const xmlChar *)p_value);</a>
<a name="ln4577">                    }</a>
<a name="ln4578">                    break;</a>
<a name="ln4579"> </a>
<a name="ln4580">                } else {</a>
<a name="ln4581">                    crm_trace(&quot;Changes detected to %s (%s -&gt; %s) in &lt;%s id=%s&gt;&quot;,</a>
<a name="ln4582">                              prop_name, left_value, right_val, crm_element_name(left), id);</a>
<a name="ln4583">                    crm_xml_add(diff, prop_name, left_value);</a>
<a name="ln4584">                }</a>
<a name="ln4585">            }</a>
<a name="ln4586">        }</a>
<a name="ln4587">    }</a>
<a name="ln4588"> </a>
<a name="ln4589">    if (*changed == FALSE) {</a>
<a name="ln4590">        free_xml(diff);</a>
<a name="ln4591">        return NULL;</a>
<a name="ln4592"> </a>
<a name="ln4593">    } else if (full == FALSE &amp;&amp; id) {</a>
<a name="ln4594">        crm_xml_add(diff, XML_ATTR_ID, id);</a>
<a name="ln4595">    }</a>
<a name="ln4596">  done:</a>
<a name="ln4597">    return diff;</a>
<a name="ln4598">}</a>
<a name="ln4599"> </a>
<a name="ln4600">static int</a>
<a name="ln4601">add_xml_comment(xmlNode * parent, xmlNode * target, xmlNode * update)</a>
<a name="ln4602">{</a>
<a name="ln4603">    CRM_CHECK(update != NULL, return 0);</a>
<a name="ln4604">    CRM_CHECK(update-&gt;type == XML_COMMENT_NODE, return 0);</a>
<a name="ln4605"> </a>
<a name="ln4606">    if (target == NULL) {</a>
<a name="ln4607">        target = find_xml_comment(parent, update, FALSE);</a>
<a name="ln4608">    }</a>
<a name="ln4609"> </a>
<a name="ln4610">    if (target == NULL) {</a>
<a name="ln4611">        add_node_copy(parent, update);</a>
<a name="ln4612"> </a>
<a name="ln4613">    /* We won't reach here currently */</a>
<a name="ln4614">    } else if (safe_str_neq((const char *)target-&gt;content, (const char *)update-&gt;content)) {</a>
<a name="ln4615">        xmlFree(target-&gt;content);</a>
<a name="ln4616">        target-&gt;content = xmlStrdup(update-&gt;content);</a>
<a name="ln4617">    }</a>
<a name="ln4618"> </a>
<a name="ln4619">    return 0;</a>
<a name="ln4620">}</a>
<a name="ln4621"> </a>
<a name="ln4622">int</a>
<a name="ln4623">add_xml_object(xmlNode * parent, xmlNode * target, xmlNode * update, gboolean as_diff)</a>
<a name="ln4624">{</a>
<a name="ln4625">    xmlNode *a_child = NULL;</a>
<a name="ln4626">    const char *object_id = NULL;</a>
<a name="ln4627">    const char *object_name = NULL;</a>
<a name="ln4628"> </a>
<a name="ln4629">#if XML_PARSE_DEBUG</a>
<a name="ln4630">    crm_log_xml_trace(&quot;update:&quot;, update);</a>
<a name="ln4631">    crm_log_xml_trace(&quot;target:&quot;, target);</a>
<a name="ln4632">#endif</a>
<a name="ln4633"> </a>
<a name="ln4634">    CRM_CHECK(update != NULL, return 0);</a>
<a name="ln4635"> </a>
<a name="ln4636">    if (update-&gt;type == XML_COMMENT_NODE) {</a>
<a name="ln4637">        return add_xml_comment(parent, target, update);</a>
<a name="ln4638">    }</a>
<a name="ln4639"> </a>
<a name="ln4640">    object_name = crm_element_name(update);</a>
<a name="ln4641">    object_id = ID(update);</a>
<a name="ln4642"> </a>
<a name="ln4643">    CRM_CHECK(object_name != NULL, return 0);</a>
<a name="ln4644"> </a>
<a name="ln4645">    if (target == NULL &amp;&amp; object_id == NULL) {</a>
<a name="ln4646">        /*  placeholder object */</a>
<a name="ln4647">        target = find_xml_node(parent, object_name, FALSE);</a>
<a name="ln4648"> </a>
<a name="ln4649">    } else if (target == NULL) {</a>
<a name="ln4650">        target = find_entity(parent, object_name, object_id);</a>
<a name="ln4651">    }</a>
<a name="ln4652"> </a>
<a name="ln4653">    if (target == NULL) {</a>
<a name="ln4654">        target = create_xml_node(parent, object_name);</a>
<a name="ln4655">        CRM_CHECK(target != NULL, return 0);</a>
<a name="ln4656">#if XML_PARSER_DEBUG</a>
<a name="ln4657">        crm_trace(&quot;Added  &lt;%s%s%s/&gt;&quot;, crm_str(object_name),</a>
<a name="ln4658">                  object_id ? &quot; id=&quot; : &quot;&quot;, object_id ? object_id : &quot;&quot;);</a>
<a name="ln4659"> </a>
<a name="ln4660">    } else {</a>
<a name="ln4661">        crm_trace(&quot;Found node &lt;%s%s%s/&gt; to update&quot;,</a>
<a name="ln4662">                  crm_str(object_name), object_id ? &quot; id=&quot; : &quot;&quot;, object_id ? object_id : &quot;&quot;);</a>
<a name="ln4663">#endif</a>
<a name="ln4664">    }</a>
<a name="ln4665"> </a>
<a name="ln4666">    CRM_CHECK(safe_str_eq(crm_element_name(target), crm_element_name(update)), return 0);</a>
<a name="ln4667"> </a>
<a name="ln4668">    if (as_diff == FALSE) {</a>
<a name="ln4669">        /* So that expand_plus_plus() gets called */</a>
<a name="ln4670">        copy_in_properties(target, update);</a>
<a name="ln4671"> </a>
<a name="ln4672">    } else {</a>
<a name="ln4673">        /* No need for expand_plus_plus(), just raw speed */</a>
<a name="ln4674">        xmlAttrPtr pIter = NULL;</a>
<a name="ln4675"> </a>
<a name="ln4676">        for (pIter = crm_first_attr(update); pIter != NULL; pIter = pIter-&gt;next) {</a>
<a name="ln4677">            const char *p_name = (const char *)pIter-&gt;name;</a>
<a name="ln4678">            const char *p_value = crm_attr_value(pIter);</a>
<a name="ln4679"> </a>
<a name="ln4680">            /* Remove it first so the ordering of the update is preserved */</a>
<a name="ln4681">            xmlUnsetProp(target, (const xmlChar *)p_name);</a>
<a name="ln4682">            xmlSetProp(target, (const xmlChar *)p_name, (const xmlChar *)p_value);</a>
<a name="ln4683">        }</a>
<a name="ln4684">    }</a>
<a name="ln4685"> </a>
<a name="ln4686">    for (a_child = __xml_first_child(update); a_child != NULL; a_child = __xml_next(a_child)) {</a>
<a name="ln4687">#if XML_PARSER_DEBUG</a>
<a name="ln4688">        crm_trace(&quot;Updating child &lt;%s id=%s&gt;&quot;, crm_element_name(a_child), ID(a_child));</a>
<a name="ln4689">#endif</a>
<a name="ln4690">        add_xml_object(target, NULL, a_child, as_diff);</a>
<a name="ln4691">    }</a>
<a name="ln4692"> </a>
<a name="ln4693">#if XML_PARSER_DEBUG</a>
<a name="ln4694">    crm_trace(&quot;Finished with &lt;%s id=%s&gt;&quot;, crm_str(object_name), crm_str(object_id));</a>
<a name="ln4695">#endif</a>
<a name="ln4696">    return 0;</a>
<a name="ln4697">}</a>
<a name="ln4698"> </a>
<a name="ln4699">gboolean</a>
<a name="ln4700">update_xml_child(xmlNode * child, xmlNode * to_update)</a>
<a name="ln4701">{</a>
<a name="ln4702">    gboolean can_update = TRUE;</a>
<a name="ln4703">    xmlNode *child_of_child = NULL;</a>
<a name="ln4704"> </a>
<a name="ln4705">    CRM_CHECK(child != NULL, return FALSE);</a>
<a name="ln4706">    CRM_CHECK(to_update != NULL, return FALSE);</a>
<a name="ln4707"> </a>
<a name="ln4708">    if (safe_str_neq(crm_element_name(to_update), crm_element_name(child))) {</a>
<a name="ln4709">        can_update = FALSE;</a>
<a name="ln4710"> </a>
<a name="ln4711">    } else if (safe_str_neq(ID(to_update), ID(child))) {</a>
<a name="ln4712">        can_update = FALSE;</a>
<a name="ln4713"> </a>
<a name="ln4714">    } else if (can_update) {</a>
<a name="ln4715">#if XML_PARSER_DEBUG</a>
<a name="ln4716">        crm_log_xml_trace(child, &quot;Update match found...&quot;);</a>
<a name="ln4717">#endif</a>
<a name="ln4718">        add_xml_object(NULL, child, to_update, FALSE);</a>
<a name="ln4719">    }</a>
<a name="ln4720"> </a>
<a name="ln4721">    for (child_of_child = __xml_first_child(child); child_of_child != NULL;</a>
<a name="ln4722">         child_of_child = __xml_next(child_of_child)) {</a>
<a name="ln4723">        /* only update the first one */</a>
<a name="ln4724">        if (can_update) {</a>
<a name="ln4725">            break;</a>
<a name="ln4726">        }</a>
<a name="ln4727">        can_update = update_xml_child(child_of_child, to_update);</a>
<a name="ln4728">    }</a>
<a name="ln4729"> </a>
<a name="ln4730">    return can_update;</a>
<a name="ln4731">}</a>
<a name="ln4732"> </a>
<a name="ln4733">int</a>
<a name="ln4734">find_xml_children(xmlNode ** children, xmlNode * root,</a>
<a name="ln4735">                  const char *tag, const char *field, const char *value, gboolean search_matches)</a>
<a name="ln4736">{</a>
<a name="ln4737">    int match_found = 0;</a>
<a name="ln4738"> </a>
<a name="ln4739">    CRM_CHECK(root != NULL, return FALSE);</a>
<a name="ln4740">    CRM_CHECK(children != NULL, return FALSE);</a>
<a name="ln4741"> </a>
<a name="ln4742">    if (tag != NULL &amp;&amp; safe_str_neq(tag, crm_element_name(root))) {</a>
<a name="ln4743"> </a>
<a name="ln4744">    } else if (value != NULL &amp;&amp; safe_str_neq(value, crm_element_value(root, field))) {</a>
<a name="ln4745"> </a>
<a name="ln4746">    } else {</a>
<a name="ln4747">        if (*children == NULL) {</a>
<a name="ln4748">            *children = create_xml_node(NULL, __FUNCTION__);</a>
<a name="ln4749">        }</a>
<a name="ln4750">        add_node_copy(*children, root);</a>
<a name="ln4751">        match_found = 1;</a>
<a name="ln4752">    }</a>
<a name="ln4753"> </a>
<a name="ln4754">    if (search_matches || match_found == 0) {</a>
<a name="ln4755">        xmlNode *child = NULL;</a>
<a name="ln4756"> </a>
<a name="ln4757">        for (child = __xml_first_child(root); child != NULL; child = __xml_next(child)) {</a>
<a name="ln4758">            match_found += find_xml_children(children, child, tag, field, value, search_matches);</a>
<a name="ln4759">        }</a>
<a name="ln4760">    }</a>
<a name="ln4761"> </a>
<a name="ln4762">    return match_found;</a>
<a name="ln4763">}</a>
<a name="ln4764"> </a>
<a name="ln4765">gboolean</a>
<a name="ln4766">replace_xml_child(xmlNode * parent, xmlNode * child, xmlNode * update, gboolean delete_only)</a>
<a name="ln4767">{</a>
<a name="ln4768">    gboolean can_delete = FALSE;</a>
<a name="ln4769">    xmlNode *child_of_child = NULL;</a>
<a name="ln4770"> </a>
<a name="ln4771">    const char *up_id = NULL;</a>
<a name="ln4772">    const char *child_id = NULL;</a>
<a name="ln4773">    const char *right_val = NULL;</a>
<a name="ln4774"> </a>
<a name="ln4775">    CRM_CHECK(child != NULL, return FALSE);</a>
<a name="ln4776">    CRM_CHECK(update != NULL, return FALSE);</a>
<a name="ln4777"> </a>
<a name="ln4778">    up_id = ID(update);</a>
<a name="ln4779">    child_id = ID(child);</a>
<a name="ln4780"> </a>
<a name="ln4781">    if (up_id == NULL || (child_id &amp;&amp; strcmp(child_id, up_id) == 0)) {</a>
<a name="ln4782">        can_delete = TRUE;</a>
<a name="ln4783">    }</a>
<a name="ln4784">    if (safe_str_neq(crm_element_name(update), crm_element_name(child))) {</a>
<a name="ln4785">        can_delete = FALSE;</a>
<a name="ln4786">    }</a>
<a name="ln4787">    if (can_delete &amp;&amp; delete_only) {</a>
<a name="ln4788">        xmlAttrPtr pIter = NULL;</a>
<a name="ln4789"> </a>
<a name="ln4790">        for (pIter = crm_first_attr(update); pIter != NULL; pIter = pIter-&gt;next) {</a>
<a name="ln4791">            const char *p_name = (const char *)pIter-&gt;name;</a>
<a name="ln4792">            const char *p_value = crm_attr_value(pIter);</a>
<a name="ln4793"> </a>
<a name="ln4794">            right_val = crm_element_value(child, p_name);</a>
<a name="ln4795">            if (safe_str_neq(p_value, right_val)) {</a>
<a name="ln4796">                can_delete = FALSE;</a>
<a name="ln4797">            }</a>
<a name="ln4798">        }</a>
<a name="ln4799">    }</a>
<a name="ln4800"> </a>
<a name="ln4801">    if (can_delete &amp;&amp; parent != NULL) {</a>
<a name="ln4802">        crm_log_xml_trace(child, &quot;Delete match found...&quot;);</a>
<a name="ln4803">        if (delete_only || update == NULL) {</a>
<a name="ln4804">            free_xml(child);</a>
<a name="ln4805"> </a>
<a name="ln4806">        } else {</a>
<a name="ln4807">            xmlNode *tmp = copy_xml(update);</a>
<a name="ln4808">            xmlDoc *doc = tmp-&gt;doc;</a>
<a name="ln4809">            xmlNode *old = NULL;</a>
<a name="ln4810"> </a>
<a name="ln4811">            xml_accept_changes(tmp);</a>
<a name="ln4812">            old = xmlReplaceNode(child, tmp);</a>
<a name="ln4813"> </a>
<a name="ln4814">            if(xml_tracking_changes(tmp)) {</a>
<a name="ln4815">                /* Replaced sections may have included relevant ACLs */</a>
<a name="ln4816">                __xml_acl_apply(tmp);</a>
<a name="ln4817">            }</a>
<a name="ln4818"> </a>
<a name="ln4819">            xml_calculate_changes(old, tmp);</a>
<a name="ln4820">            xmlDocSetRootElement(doc, old);</a>
<a name="ln4821">            free_xml(old);</a>
<a name="ln4822">        }</a>
<a name="ln4823">        child = NULL;</a>
<a name="ln4824">        return TRUE;</a>
<a name="ln4825"> </a>
<a name="ln4826">    } else if (can_delete) {</a>
<a name="ln4827">        crm_log_xml_debug(child, &quot;Cannot delete the search root&quot;);</a>
<a name="ln4828">        can_delete = FALSE;</a>
<a name="ln4829">    }</a>
<a name="ln4830"> </a>
<a name="ln4831">    child_of_child = __xml_first_child(child);</a>
<a name="ln4832">    while (child_of_child) {</a>
<a name="ln4833">        xmlNode *next = __xml_next(child_of_child);</a>
<a name="ln4834"> </a>
<a name="ln4835">        can_delete = replace_xml_child(child, child_of_child, update, delete_only);</a>
<a name="ln4836"> </a>
<a name="ln4837">        /* only delete the first one */</a>
<a name="ln4838">        if (can_delete) {</a>
<a name="ln4839">            child_of_child = NULL;</a>
<a name="ln4840">        } else {</a>
<a name="ln4841">            child_of_child = next;</a>
<a name="ln4842">        }</a>
<a name="ln4843">    }</a>
<a name="ln4844"> </a>
<a name="ln4845">    return can_delete;</a>
<a name="ln4846">}</a>
<a name="ln4847"> </a>
<a name="ln4848">void</a>
<a name="ln4849">hash2nvpair(gpointer key, gpointer value, gpointer user_data)</a>
<a name="ln4850">{</a>
<a name="ln4851">    const char *name = key;</a>
<a name="ln4852">    const char *s_value = value;</a>
<a name="ln4853"> </a>
<a name="ln4854">    xmlNode *xml_node = user_data;</a>
<a name="ln4855">    xmlNode *xml_child = create_xml_node(xml_node, XML_CIB_TAG_NVPAIR);</a>
<a name="ln4856"> </a>
<a name="ln4857">    crm_xml_add(xml_child, XML_ATTR_ID, name);</a>
<a name="ln4858">    crm_xml_add(xml_child, XML_NVPAIR_ATTR_NAME, name);</a>
<a name="ln4859">    crm_xml_add(xml_child, XML_NVPAIR_ATTR_VALUE, s_value);</a>
<a name="ln4860"> </a>
<a name="ln4861">    crm_trace(&quot;dumped: name=%s value=%s&quot;, name, s_value);</a>
<a name="ln4862">}</a>
<a name="ln4863"> </a>
<a name="ln4864">void</a>
<a name="ln4865">hash2smartfield(gpointer key, gpointer value, gpointer user_data)</a>
<a name="ln4866">{</a>
<a name="ln4867">    const char *name = key;</a>
<a name="ln4868">    const char *s_value = value;</a>
<a name="ln4869"> </a>
<a name="ln4870">    xmlNode *xml_node = user_data;</a>
<a name="ln4871"> </a>
<a name="ln4872">    if (isdigit(name[0])) {</a>
<a name="ln4873">        xmlNode *tmp = create_xml_node(xml_node, XML_TAG_PARAM);</a>
<a name="ln4874"> </a>
<a name="ln4875">        crm_xml_add(tmp, XML_NVPAIR_ATTR_NAME, name);</a>
<a name="ln4876">        crm_xml_add(tmp, XML_NVPAIR_ATTR_VALUE, s_value);</a>
<a name="ln4877"> </a>
<a name="ln4878">    } else if (crm_element_value(xml_node, name) == NULL) {</a>
<a name="ln4879">        crm_xml_add(xml_node, name, s_value);</a>
<a name="ln4880">        crm_trace(&quot;dumped: %s=%s&quot;, name, s_value);</a>
<a name="ln4881"> </a>
<a name="ln4882">    } else {</a>
<a name="ln4883">        crm_trace(&quot;duplicate: %s=%s&quot;, name, s_value);</a>
<a name="ln4884">    }</a>
<a name="ln4885">}</a>
<a name="ln4886"> </a>
<a name="ln4887">void</a>
<a name="ln4888">hash2field(gpointer key, gpointer value, gpointer user_data)</a>
<a name="ln4889">{</a>
<a name="ln4890">    const char *name = key;</a>
<a name="ln4891">    const char *s_value = value;</a>
<a name="ln4892"> </a>
<a name="ln4893">    xmlNode *xml_node = user_data;</a>
<a name="ln4894"> </a>
<a name="ln4895">    if (crm_element_value(xml_node, name) == NULL) {</a>
<a name="ln4896">        crm_xml_add(xml_node, name, s_value);</a>
<a name="ln4897"> </a>
<a name="ln4898">    } else {</a>
<a name="ln4899">        crm_trace(&quot;duplicate: %s=%s&quot;, name, s_value);</a>
<a name="ln4900">    }</a>
<a name="ln4901">}</a>
<a name="ln4902"> </a>
<a name="ln4903">void</a>
<a name="ln4904">hash2metafield(gpointer key, gpointer value, gpointer user_data)</a>
<a name="ln4905">{</a>
<a name="ln4906">    char *crm_name = NULL;</a>
<a name="ln4907"> </a>
<a name="ln4908">    if (key == NULL || value == NULL) {</a>
<a name="ln4909">        return;</a>
<a name="ln4910">    }</a>
<a name="ln4911"> </a>
<a name="ln4912">    /* Filter out cluster-generated attributes that contain a '#' or ':'</a>
<a name="ln4913">     * (like fail-count and last-failure).</a>
<a name="ln4914">     */</a>
<a name="ln4915">    for (crm_name = key; *crm_name; ++crm_name) {</a>
<a name="ln4916">        if ((*crm_name == '#') || (*crm_name == ':')) {</a>
<a name="ln4917">            return;</a>
<a name="ln4918">        }</a>
<a name="ln4919">    }</a>
<a name="ln4920"> </a>
<a name="ln4921">    crm_name = crm_meta_name(key);</a>
<a name="ln4922">    hash2field(crm_name, value, user_data);</a>
<a name="ln4923">    free(crm_name);</a>
<a name="ln4924">}</a>
<a name="ln4925"> </a>
<a name="ln4926">GHashTable *</a>
<a name="ln4927">xml2list(xmlNode * parent)</a>
<a name="ln4928">{</a>
<a name="ln4929">    xmlNode *child = NULL;</a>
<a name="ln4930">    xmlAttrPtr pIter = NULL;</a>
<a name="ln4931">    xmlNode *nvpair_list = NULL;</a>
<a name="ln4932">    GHashTable *nvpair_hash = g_hash_table_new_full(crm_str_hash, g_str_equal,</a>
<a name="ln4933">                                                    g_hash_destroy_str, g_hash_destroy_str);</a>
<a name="ln4934"> </a>
<a name="ln4935">    CRM_CHECK(parent != NULL, return nvpair_hash);</a>
<a name="ln4936"> </a>
<a name="ln4937">    nvpair_list = find_xml_node(parent, XML_TAG_ATTRS, FALSE);</a>
<a name="ln4938">    if (nvpair_list == NULL) {</a>
<a name="ln4939">        crm_trace(&quot;No attributes in %s&quot;, crm_element_name(parent));</a>
<a name="ln4940">        crm_log_xml_trace(parent, &quot;No attributes for resource op&quot;);</a>
<a name="ln4941">    }</a>
<a name="ln4942"> </a>
<a name="ln4943">    crm_log_xml_trace(nvpair_list, &quot;Unpacking&quot;);</a>
<a name="ln4944"> </a>
<a name="ln4945">    for (pIter = crm_first_attr(nvpair_list); pIter != NULL; pIter = pIter-&gt;next) {</a>
<a name="ln4946">        const char *p_name = (const char *)pIter-&gt;name;</a>
<a name="ln4947">        const char *p_value = crm_attr_value(pIter);</a>
<a name="ln4948"> </a>
<a name="ln4949">        crm_trace(&quot;Added %s=%s&quot;, p_name, p_value);</a>
<a name="ln4950"> </a>
<a name="ln4951">        g_hash_table_insert(nvpair_hash, strdup(p_name), strdup(p_value));</a>
<a name="ln4952">    }</a>
<a name="ln4953"> </a>
<a name="ln4954">    for (child = __xml_first_child(nvpair_list); child != NULL; child = __xml_next(child)) {</a>
<a name="ln4955">        if (strcmp((const char *)child-&gt;name, XML_TAG_PARAM) == 0) {</a>
<a name="ln4956">            const char *key = crm_element_value(child, XML_NVPAIR_ATTR_NAME);</a>
<a name="ln4957">            const char *value = crm_element_value(child, XML_NVPAIR_ATTR_VALUE);</a>
<a name="ln4958"> </a>
<a name="ln4959">            crm_trace(&quot;Added %s=%s&quot;, key, value);</a>
<a name="ln4960">            if (key != NULL &amp;&amp; value != NULL) {</a>
<a name="ln4961">                g_hash_table_insert(nvpair_hash, strdup(key), strdup(value));</a>
<a name="ln4962">            }</a>
<a name="ln4963">        }</a>
<a name="ln4964">    }</a>
<a name="ln4965"> </a>
<a name="ln4966">    return nvpair_hash;</a>
<a name="ln4967">}</a>
<a name="ln4968"> </a>
<a name="ln4969">typedef struct name_value_s {</a>
<a name="ln4970">    const char *name;</a>
<a name="ln4971">    const void *value;</a>
<a name="ln4972">} name_value_t;</a>
<a name="ln4973"> </a>
<a name="ln4974">static gint</a>
<a name="ln4975">sort_pairs(gconstpointer a, gconstpointer b)</a>
<a name="ln4976">{</a>
<a name="ln4977">    int rc = 0;</a>
<a name="ln4978">    const name_value_t *pair_a = a;</a>
<a name="ln4979">    const name_value_t *pair_b = b;</a>
<a name="ln4980"> </a>
<a name="ln4981">    CRM_ASSERT(a != NULL);</a>
<a name="ln4982">    CRM_ASSERT(pair_a-&gt;name != NULL);</a>
<a name="ln4983"> </a>
<a name="ln4984">    CRM_ASSERT(b != NULL);</a>
<a name="ln4985">    CRM_ASSERT(pair_b-&gt;name != NULL);</a>
<a name="ln4986"> </a>
<a name="ln4987">    rc = strcmp(pair_a-&gt;name, pair_b-&gt;name);</a>
<a name="ln4988">    if (rc &lt; 0) {</a>
<a name="ln4989">        return -1;</a>
<a name="ln4990">    } else if (rc &gt; 0) {</a>
<a name="ln4991">        return 1;</a>
<a name="ln4992">    }</a>
<a name="ln4993">    return 0;</a>
<a name="ln4994">}</a>
<a name="ln4995"> </a>
<a name="ln4996">static void</a>
<a name="ln4997">dump_pair(gpointer data, gpointer user_data)</a>
<a name="ln4998">{</a>
<a name="ln4999">    name_value_t *pair = data;</a>
<a name="ln5000">    xmlNode *parent = user_data;</a>
<a name="ln5001"> </a>
<a name="ln5002">    crm_xml_add(parent, pair-&gt;name, pair-&gt;value);</a>
<a name="ln5003">}</a>
<a name="ln5004"> </a>
<a name="ln5005">xmlNode *</a>
<a name="ln5006">sorted_xml(xmlNode * input, xmlNode * parent, gboolean recursive)</a>
<a name="ln5007">{</a>
<a name="ln5008">    xmlNode *child = NULL;</a>
<a name="ln5009">    GListPtr sorted = NULL;</a>
<a name="ln5010">    GListPtr unsorted = NULL;</a>
<a name="ln5011">    name_value_t *pair = NULL;</a>
<a name="ln5012">    xmlNode *result = NULL;</a>
<a name="ln5013">    const char *name = NULL;</a>
<a name="ln5014">    xmlAttrPtr pIter = NULL;</a>
<a name="ln5015"> </a>
<a name="ln5016">    CRM_CHECK(input != NULL, return NULL);</a>
<a name="ln5017"> </a>
<a name="ln5018">    name = crm_element_name(input);</a>
<a name="ln5019">    CRM_CHECK(name != NULL, return NULL);</a>
<a name="ln5020"> </a>
<a name="ln5021">    result = create_xml_node(parent, name);</a>
<a name="ln5022"> </a>
<a name="ln5023">    for (pIter = crm_first_attr(input); pIter != NULL; pIter = pIter-&gt;next) {</a>
<a name="ln5024">        const char *p_name = (const char *)pIter-&gt;name;</a>
<a name="ln5025">        const char *p_value = crm_attr_value(pIter);</a>
<a name="ln5026"> </a>
<a name="ln5027">        pair = calloc(1, sizeof(name_value_t));</a>
<a name="ln5028">        pair-&gt;name = p_name;</a>
<a name="ln5029">        pair-&gt;value = p_value;</a>
<a name="ln5030">        unsorted = g_list_prepend(unsorted, pair);</a>
<a name="ln5031">        pair = NULL;</a>
<a name="ln5032">    }</a>
<a name="ln5033"> </a>
<a name="ln5034">    sorted = g_list_sort(unsorted, sort_pairs);</a>
<a name="ln5035">    g_list_foreach(sorted, dump_pair, result);</a>
<a name="ln5036">    g_list_free_full(sorted, free);</a>
<a name="ln5037"> </a>
<a name="ln5038">    for (child = __xml_first_child(input); child != NULL; child = __xml_next(child)) {</a>
<a name="ln5039">        if (recursive) {</a>
<a name="ln5040">            sorted_xml(child, result, recursive);</a>
<a name="ln5041">        } else {</a>
<a name="ln5042">            add_node_copy(result, child);</a>
<a name="ln5043">        }</a>
<a name="ln5044">    }</a>
<a name="ln5045"> </a>
<a name="ln5046">    return result;</a>
<a name="ln5047">}</a>
<a name="ln5048"> </a>
<a name="ln5049">xmlNode *</a>
<a name="ln5050">first_named_child(xmlNode * parent, const char *name)</a>
<a name="ln5051">{</a>
<a name="ln5052">    xmlNode *match = NULL;</a>
<a name="ln5053"> </a>
<a name="ln5054">    for (match = __xml_first_child(parent); match != NULL; match = __xml_next(match)) {</a>
<a name="ln5055">        /*</a>
<a name="ln5056">         * name == NULL gives first child regardless of name; this is</a>
<a name="ln5057">         * semantically incorrect in this function, but may be necessary</a>
<a name="ln5058">         * due to prior use of xml_child_iter_filter</a>
<a name="ln5059">         */</a>
<a name="ln5060">        if (name == NULL || strcmp((const char *)match-&gt;name, name) == 0) {</a>
<a name="ln5061">            return match;</a>
<a name="ln5062">        }</a>
<a name="ln5063">    }</a>
<a name="ln5064">    return NULL;</a>
<a name="ln5065">}</a>
<a name="ln5066"> </a>
<a name="ln5067">void</a>
<a name="ln5068">crm_xml_init(void)</a>
<a name="ln5069">{</a>
<a name="ln5070">    static bool init = TRUE;</a>
<a name="ln5071"> </a>
<a name="ln5072">    if(init) {</a>
<a name="ln5073">        init = FALSE;</a>
<a name="ln5074">        /* The default allocator XML_BUFFER_ALLOC_EXACT does far too many</a>
<a name="ln5075">         * realloc_safe()s and it can take upwards of 18 seconds (yes, seconds)</a>
<a name="ln5076">         * to dump a 28kb tree which XML_BUFFER_ALLOC_DOUBLEIT can do in</a>
<a name="ln5077">         * less than 1 second.</a>
<a name="ln5078">         */</a>
<a name="ln5079">        xmlSetBufferAllocationScheme(XML_BUFFER_ALLOC_DOUBLEIT);</a>
<a name="ln5080"> </a>
<a name="ln5081">        /* Populate and free the _private field when nodes are created and destroyed */</a>
<a name="ln5082">        xmlDeregisterNodeDefault(pcmkDeregisterNode);</a>
<a name="ln5083">        xmlRegisterNodeDefault(pcmkRegisterNode);</a>
<a name="ln5084"> </a>
<a name="ln5085">        crm_schema_init();</a>
<a name="ln5086">    }</a>
<a name="ln5087">}</a>
<a name="ln5088"> </a>
<a name="ln5089">void</a>
<a name="ln5090">crm_xml_cleanup(void)</a>
<a name="ln5091">{</a>
<a name="ln5092">    crm_info(&quot;Cleaning up memory from libxml2&quot;);</a>
<a name="ln5093">    crm_schema_cleanup();</a>
<a name="ln5094">    xmlCleanupParser();</a>
<a name="ln5095">}</a>
<a name="ln5096"> </a>
<a name="ln5097">xmlNode *</a>
<a name="ln5098">expand_idref(xmlNode * input, xmlNode * top)</a>
<a name="ln5099">{</a>
<a name="ln5100">    const char *tag = NULL;</a>
<a name="ln5101">    const char *ref = NULL;</a>
<a name="ln5102">    xmlNode *result = input;</a>
<a name="ln5103">    char *xpath_string = NULL;</a>
<a name="ln5104"> </a>
<a name="ln5105">    if (result == NULL) {</a>
<a name="ln5106">        return NULL;</a>
<a name="ln5107"> </a>
<a name="ln5108">    } else if (top == NULL) {</a>
<a name="ln5109">        top = input;</a>
<a name="ln5110">    }</a>
<a name="ln5111"> </a>
<a name="ln5112">    tag = crm_element_name(result);</a>
<a name="ln5113">    ref = crm_element_value(result, XML_ATTR_IDREF);</a>
<a name="ln5114"> </a>
<a name="ln5115">    if (ref != NULL) {</a>
<a name="ln5116">        int xpath_max = 512, offset = 0;</a>
<a name="ln5117"> </a>
<a name="ln5118">        xpath_string = calloc(1, xpath_max);</a>
<a name="ln5119"> </a>
<a name="ln5120">        offset += snprintf(xpath_string + offset, xpath_max - offset, &quot;//%s[@id='%s']&quot;, tag, ref);</a>
<a name="ln5121">        CRM_LOG_ASSERT(offset &gt; 0);</a>
<a name="ln5122"> </a>
<a name="ln5123">        result = get_xpath_object(xpath_string, top, LOG_ERR);</a>
<a name="ln5124">        if (result == NULL) {</a>
<a name="ln5125">            char *nodePath = (char *)xmlGetNodePath(top);</a>
<a name="ln5126"> </a>
<a name="ln5127">            crm_err(&quot;No match for %s found in %s: Invalid configuration&quot;, xpath_string,</a>
<a name="ln5128">                    crm_str(nodePath));</a>
<a name="ln5129">            free(nodePath);</a>
<a name="ln5130">        }</a>
<a name="ln5131">    }</a>
<a name="ln5132"> </a>
<a name="ln5133">    free(xpath_string);</a>
<a name="ln5134">    return result;</a>
<a name="ln5135">}</a>
<a name="ln5136"> </a>
<a name="ln5137">const char *</a>
<a name="ln5138">crm_element_value(xmlNode * data, const char *name)</a>
<a name="ln5139">{</a>
<a name="ln5140">    xmlAttr *attr = NULL;</a>
<a name="ln5141"> </a>
<a name="ln5142">    if (data == NULL) {</a>
<a name="ln5143">        crm_err(&quot;Couldn't find %s in NULL&quot;, name ? name : &quot;&lt;null&gt;&quot;);</a>
<a name="ln5144">        CRM_LOG_ASSERT(data != NULL);</a>
<a name="ln5145">        return NULL;</a>
<a name="ln5146"> </a>
<a name="ln5147">    } else if (name == NULL) {</a>
<a name="ln5148">        crm_err(&quot;Couldn't find NULL in %s&quot;, crm_element_name(data));</a>
<a name="ln5149">        return NULL;</a>
<a name="ln5150">    }</a>
<a name="ln5151"> </a>
<a name="ln5152">    attr = xmlHasProp(data, (const xmlChar *)name);</a>
<a name="ln5153">    if (attr == NULL || attr-&gt;children == NULL) {</a>
<a name="ln5154">        return NULL;</a>
<a name="ln5155">    }</a>
<a name="ln5156">    return (const char *)attr-&gt;children-&gt;content;</a>
<a name="ln5157">}</a>
<a name="ln5158"> </a>
<a name="ln5159">void</a>
<a name="ln5160">crm_destroy_xml(gpointer data)</a>
<a name="ln5161">{</a>
<a name="ln5162">    free_xml(data);</a>
<a name="ln5163">}</a>

</code></pre>
<div class="balloon" rel="343"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'p'. Check lines: 343, 342.</p></div>
<div class="balloon" rel="438"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V562/" target="_blank">V562</a> It's odd to compare 0 or 1 with a value of 0: (offset > 0) == (0).</p></div>
<div class="balloon" rel="726"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V560/" target="_blank">V560</a> A part of conditional expression is always true: target.</p></div>
<div class="balloon" rel="1429"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V560/" target="_blank">V560</a> A part of conditional expression is always true: patchset != NULL.</p></div>
<div class="balloon" rel="1885"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V562/" target="_blank">V562</a> It's odd to compare 0 or 1 with a value of 0: (root_nodes_seen == 0) == (0).</p></div>
<div class="balloon" rel="1904"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V562/" target="_blank">V562</a> It's odd to compare 0 or 1 with a value of 0: (root_nodes_seen == 0) == (0).</p></div>
<div class="balloon" rel="1963"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V576/" target="_blank">V576</a> Incorrect format. Consider checking the third actual argument of the 'sscanf' function. It's dangerous to use string specifier without width specification. Buffer overflow is possible.</p></div>
<div class="balloon" rel="1974"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V576/" target="_blank">V576</a> Incorrect format. Consider checking the third actual argument of the 'sscanf' function. It's dangerous to use string specifier without width specification. Buffer overflow is possible.</p></div>
<div class="balloon" rel="1974"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V576/" target="_blank">V576</a> Incorrect format. Consider checking the fourth actual argument of the 'sscanf' function. It's dangerous to use string specifier without width specification. Buffer overflow is possible.</p></div>
<div class="balloon" rel="2082"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V562/" target="_blank">V562</a> It's odd to compare 0 or 1 with a value of 0: (position == 0) == (0).</p></div>
<div class="balloon" rel="2187"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V547/" target="_blank">V547</a> Expression 'rc == 0' is always true.</p></div>
<div class="balloon" rel="2454"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V562/" target="_blank">V562</a> It's odd to compare 0 or 1 with a value of 0: (offset > 0) == (0).</p></div>
<div class="balloon" rel="2519"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V560/" target="_blank">V560</a> A part of conditional expression is always false: value == NULL.</p></div>
<div class="balloon" rel="2567"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V560/" target="_blank">V560</a> A part of conditional expression is always false: value == NULL.</p></div>
<div class="balloon" rel="2679"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'deleted_obj'. Check lines: 2679, 2675.</p></div>
<div class="balloon" rel="3013"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V560/" target="_blank">V560</a> A part of conditional expression is always true: last_error.</p></div>
<div class="balloon" rel="3081"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V562/" target="_blank">V562</a> It's odd to compare 0 or 1 with a value of 0: (len > 0) == (0).</p></div>
<div class="balloon" rel="3175"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V562/" target="_blank">V562</a> It's odd to compare 0 or 1 with a value of 0: (fd > 0) == (0).</p></div>
<div class="balloon" rel="3248"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'copy'. Check lines: 3248, 3230.</p></div>
<div class="balloon" rel="3443"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'prefix_m'. Check lines: 3443, 3442.</p></div>
<div class="balloon" rel="3459"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'prefix_del'. Check lines: 3459, 3458.</p></div>
<div class="balloon" rel="3462"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'prefix_moved'. Check lines: 3462, 3461.</p></div>
<div class="balloon" rel="3480"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V576/" target="_blank">V576</a> Incorrect format. Consider checking the second actual argument of the 'printf' function. Under certain conditions the pointer can be null.</p></div>
<div class="balloon" rel="3542"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V501/" target="_blank">V501</a> There are identical sub-expressions 'is_set(options, xml_log_option_dirty_add)' to the left and to the right of the '||' operator.</p></div>
<div class="balloon" rel="3552"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'prefix_m'. Check lines: 3552, 3551.</p></div>
<div class="balloon" rel="3592"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V560/" target="_blank">V560</a> A part of conditional expression is always true: skip == (0).</p></div>
<div class="balloon" rel="3983"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V562/" target="_blank">V562</a> It's odd to compare 0 or 1 with a value of 0: (root_nodes_seen == 0) == (0).</p></div>
<div class="balloon" rel="4005"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V562/" target="_blank">V562</a> It's odd to compare 0 or 1 with a value of 0: (root_nodes_seen == 0) == (0).</p></div>
<div class="balloon" rel="4519"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V560/" target="_blank">V560</a> A part of conditional expression is always true: skip == (0).</p></div>
<div class="balloon" rel="4714"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V547/" target="_blank">V547</a> Expression 'can_update' is always true.</p></div>
<div class="balloon" rel="4951"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V575/" target="_blank">V575</a> The potential null pointer is passed into 'g_hash_table_insert' function. Inspect the second argument. Check lines: 4951, 4951.</p></div>
<div class="balloon" rel="4961"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V575/" target="_blank">V575</a> The potential null pointer is passed into 'g_hash_table_insert' function. Inspect the second argument. Check lines: 4961, 4961.</p></div>
<div class="balloon" rel="5028"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'pair'. Check lines: 5028, 5027.</p></div>
<div class="balloon" rel="5120"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V769/" target="_blank">V769</a> The 'xpath_string' pointer in the 'xpath_string + offset' expression could be nullptr. In such case, resulting value will be senseless and it should not be used. Check lines: 5120, 5118.</p></div>
<div class="balloon" rel="5121"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/V562/" target="_blank">V562</a> It's odd to compare 0 or 1 with a value of 0: (offset > 0) == (0).</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
